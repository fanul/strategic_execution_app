<script>
// ============================================================================
// DASHBOARD WIDGETS - Dashboard Data Management & Visualization
// ============================================================================

debugLog('DASHBOARD', 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
debugLog('DASHBOARD', 'â•‘  DASHBOARD WIDGETS SCRIPT LOADING                  â•‘');
debugLog('DASHBOARD', 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

const DashboardManager = (function() {
    'use strict';

    let kpiChart = null;
    let goalChart = null;
    let refreshInterval = null;

    /**
     * Initialize dashboard
     */
    function init() {
        debugLog('DASHBOARD', '=== init START ===');
        loadAllWidgets();
        setupAutoRefresh();
        debugLog('DASHBOARD', '=== init COMPLETE ===');
    }

    /**
     * Load all dashboard widgets
     */
    async function loadAllWidgets() {
        debugLog('DASHBOARD', '=== loadAllWidgets START ===');

        // Load all widgets in parallel for better performance
        await Promise.all([
            loadQuickStats(),
            loadKPIChart(),
            loadGoalChart(),
            loadRecentActivities(),
            loadUpcomingDeadlines(),
            loadTopWorkUnits(),
            loadImpactCenters()
        ]);

        debugLog('DASHBOARD', 'OK All widgets loaded');
    }

    /**
     * Load quick statistics
     */
    async function loadQuickStats() {
        debugLog('DASHBOARD', 'Loading quick stats...');

        try {
            const result = await apiCall('dashboard/quick-stats');

            if (result.success && result.data) {
                const stats = result.data;

                updateElement('overallProgress', stats.overall_progress + '%');
                updateElement('activeKPIs', stats.active_kpis);
                updateElement('okrsOnTrack', stats.okrs_on_track);
                updateElement('atRiskCount', stats.at_risk);

                debugLog('DASHBOARD', 'OK Quick stats loaded');
            } else {
                // Show placeholder values if no data
                updateElement('overallProgress', 'N/A');
                updateElement('activeKPIs', '0');
                updateElement('okrsOnTrack', '0');
                updateElement('atRiskCount', '0');
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading quick stats:', error);
            // Set placeholder values on error
            updateElement('overallProgress', 'N/A');
            updateElement('activeKPIs', '0');
            updateElement('okrsOnTrack', '0');
            updateElement('atRiskCount', '0');
        }
    }

    /**
     * Load KPI performance chart
     */
    async function loadKPIChart() {
        debugLog('DASHBOARD', 'Loading KPI chart...');

        try {
            const result = await apiCall('dashboard/kpi-by-perspective');

            if (result.success && result.data) {
                renderKPIChart(result.data);
                debugLog('DASHBOARD', 'OK KPI chart loaded');
            } else {
                renderEmptyChart('kpiPerformanceChart', 'No KPI data available');
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading KPI chart:', error);
            renderEmptyChart('kpiPerformanceChart', 'Error loading KPI data');
        }
    }

    /**
     * Render KPI performance chart
     */
    function renderKPIChart(data) {
        const canvas = document.getElementById('kpiPerformanceChart');
        if (!canvas) return;

        if (kpiChart) {
            kpiChart.destroy();
        }

        const labels = data.map(d => d.perspective);
        const values = data.map(d => d.achievement_percentage);

        kpiChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Achievement %',
                    data: values,
                    backgroundColor: values.map(v => {
                        if (v >= 90) return 'rgba(40, 167, 69, 0.8)'; // Green
                        if (v >= 70) return 'rgba(255, 193, 7, 0.8)'; // Yellow
                        return 'rgba(220, 53, 69, 0.8)'; // Red
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    /**
     * Load goal progress chart
     */
    async function loadGoalChart() {
        debugLog('DASHBOARD', 'Loading goal chart...');

        try {
            const result = await apiCall('dashboard/goals-progress');

            if (result.success && result.data) {
                renderGoalChart(result.data);
                debugLog('DASHBOARD', 'OK Goal chart loaded');
            } else {
                renderEmptyChart('goalProgressChart', 'No goal data available');
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading goal chart:', error);
            renderEmptyChart('goalProgressChart', 'Error loading goal data');
        }
    }

    /**
     * Render goal progress chart
     */
    function renderGoalChart(data) {
        const canvas = document.getElementById('goalProgressChart');
        if (!canvas) return;

        if (goalChart) {
            goalChart.destroy();
        }

        const labels = data.map(d => d.goal_name);
        const values = data.map(d => d.progress_percentage);

        goalChart = new Chart(canvas, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(13, 110, 253, 0.8)',
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(13, 202, 240, 0.8)',
                        'rgba(102, 16, 242, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Load recent activities
     */
    async function loadRecentActivities() {
        debugLog('DASHBOARD', 'Loading recent activities...');

        const container = document.getElementById('recentActivities');
        if (!container) return;

        try {
            const result = await apiCall('dashboard/recent-activities', { limit: 10 });

            if (result.success && result.data && result.data.length > 0) {
                renderActivities(result.data);
                debugLog('DASHBOARD', 'OK Recent activities loaded');
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2">No recent activities</p>
                    </div>
                `;
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading activities:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <p class="mt-2">Error loading activities</p>
                </div>
            `;
        }
    }

    /**
     * Render activities list
     */
    function renderActivities(activities) {
        const container = document.getElementById('recentActivities');
        if (!container) return;

        const html = activities.map(activity => {
            const icon = getActivityIcon(activity.action);
            const time = new Date(activity.created_at).toLocaleString();

            return `
                <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                    <div class="me-3">
                        <i class="bi ${icon.icon} ${icon.color} fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-1">${activity.description}</p>
                        <small class="text-muted">${activity.user_name} â€¢ ${time}</small>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Get activity icon
     */
    function getActivityIcon(action) {
        const icons = {
            'CREATE': { icon: 'bi-plus-circle', color: 'text-success' },
            'UPDATE': { icon: 'bi-pencil', color: 'text-primary' },
            'DELETE': { icon: 'bi-trash', color: 'text-danger' },
            'LOGIN': { icon: 'bi-box-arrow-in-right', color: 'text-info' },
            'LOGOUT': { icon: 'bi-box-arrow-right', color: 'text-secondary' }
        };
        return icons[action] || { icon: 'bi-circle', color: 'text-muted' };
    }

    /**
     * Load upcoming deadlines
     */
    async function loadUpcomingDeadlines() {
        debugLog('DASHBOARD', 'Loading upcoming deadlines...');

        const container = document.getElementById('upcomingDeadlines');
        if (!container) return;

        try {
            const result = await apiCall('dashboard/upcoming-deadlines', { limit: 10 });

            if (result.success && result.data && result.data.length > 0) {
                renderDeadlines(result.data);
                debugLog('DASHBOARD', 'OK Upcoming deadlines loaded');
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-calendar-check fs-1"></i>
                        <p class="mt-2">No upcoming deadlines</p>
                    </div>
                `;
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading deadlines:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <p class="mt-2">Error loading deadlines</p>
                </div>
            `;
        }
    }

    /**
     * Render deadlines list
     */
    function renderDeadlines(deadlines) {
        const container = document.getElementById('upcomingDeadlines');
        if (!container) return;

        const html = deadlines.map(deadline => {
            const isUrgent = isUrgentDeadline(deadline.due_date);
            const date = new Date(deadline.due_date);
            const formattedDate = date.toLocaleDateString();
            const daysLeft = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));

            return `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="me-3">
                        <i class="bi bi-calendar-event ${isUrgent ? 'text-danger' : 'text-primary'} fs-5"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-1">${deadline.title}</p>
                        <small class="${isUrgent ? 'text-danger' : 'text-muted'}">
                            ${formattedDate} (${daysLeft} days left)
                        </small>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Check if deadline is urgent (within 7 days)
     */
    function isUrgentDeadline(dueDate) {
        const days = Math.ceil((new Date(dueDate) - new Date()) / (1000 * 60 * 60 * 24));
        return days <= 7;
    }

    /**
     * Load top performing work units
     */
    async function loadTopWorkUnits() {
        debugLog('DASHBOARD', 'Loading top work units...');

        const container = document.getElementById('topWorkUnits');
        if (!container) return;

        try {
            const result = await apiCall('dashboard/top-work-units', { limit: 5 });

            if (result.success && result.data && result.data.length > 0) {
                renderTopWorkUnits(result.data);
                debugLog('DASHBOARD', 'OK Top work units loaded');
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <p>No work units data available</p>
                    </div>
                `;
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading work units:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <p>Error loading work units</p>
                </div>
            `;
        }
    }

    /**
     * Render top work units
     */
    function renderTopWorkUnits(units) {
        const container = document.getElementById('topWorkUnits');
        if (!container) return;

        const html = units.map((unit, index) => {
            const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;

            return `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="me-3 fs-4">${medal}</div>
                    <div class="flex-grow-1">
                        <p class="mb-1 fw-bold">${unit.work_unit_name}</p>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${unit.achievement_percentage}%"></div>
                        </div>
                    </div>
                    <div class="ms-3">
                        <span class="badge bg-success">${unit.achievement_percentage}%</span>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Load impact centers status
     */
    async function loadImpactCenters() {
        debugLog('DASHBOARD', 'Loading impact centers...');

        const container = document.getElementById('impactCentersStatus');
        if (!container) return;

        try {
            const result = await apiCall('dashboard/impact-centers-status');

            if (result.success && result.data && result.data.length > 0) {
                renderImpactCenters(result.data);
                debugLog('DASHBOARD', 'OK Impact centers loaded');
            } else {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <p>No impact centers data available</p>
                    </div>
                `;
            }
        } catch (error) {
            debugLog('DASHBOARD', 'EXCEPTION loading impact centers:', error);
            container.innerHTML = `
                <div class="text-center text-danger py-4">
                    <p>Error loading impact centers</p>
                </div>
            `;
        }
    }

    /**
     * Render impact centers
     */
    function renderImpactCenters(centers) {
        const container = document.getElementById('impactCentersStatus');
        if (!container) return;

        const html = centers.map(center => {
            const status = center.completion_percentage >= 90 ? 'Completed' :
                          center.completion_percentage >= 70 ? 'On Track' :
                          center.completion_percentage >= 50 ? 'In Progress' : 'At Risk';

            const statusClass = center.completion_percentage >= 90 ? 'bg-success' :
                               center.completion_percentage >= 70 ? 'bg-primary' :
                               center.completion_percentage >= 50 ? 'bg-warning' : 'bg-danger';

            return `
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                    <div class="flex-grow-1">
                        <p class="mb-1 fw-bold">${center.impact_center_name}</p>
                        <small class="text-muted">${center.responsible_unit}</small>
                    </div>
                    <div class="ms-3">
                        <span class="badge ${statusClass}">${status}</span>
                    </div>
                    <div class="ms-3 text-end" style="min-width: 60px;">
                        <small class="text-muted">${center.completion_percentage}%</small>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    }

    /**
     * Setup auto refresh
     */
    function setupAutoRefresh() {
        // Refresh every 5 minutes
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }

        refreshInterval = setInterval(() => {
            debugLog('DASHBOARD', 'Auto-refreshing dashboard...');
            loadAllWidgets();
        }, 5 * 60 * 1000);
    }

    /**
     * Update element safely
     */
    function updateElement(id, value) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = value;
        }
    }

    /**
     * Render empty chart placeholder
     */
    function renderEmptyChart(canvasId, message) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        ctx.font = '14px Arial';
        ctx.fillStyle = '#6c757d';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    /**
     * Refresh KPI chart
     */
    function refreshKPIChart() {
        loadKPIChart();
    }

    /**
     * Refresh goal chart
     */
    function refreshGoalChart() {
        loadGoalChart();
    }

    /**
     * Refresh all widgets
     */
    function refreshAll() {
        loadAllWidgets();
    }

    /**
     * Cleanup
     */
    function destroy() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
        if (kpiChart) {
            kpiChart.destroy();
            kpiChart = null;
        }
        if (goalChart) {
            goalChart.destroy();
            goalChart = null;
        }
        debugLog('DASHBOARD', 'Dashboard destroyed');
    }

    // Public API
    return {
        init: init,
        loadAllWidgets: loadAllWidgets,
        refreshKPIChart: refreshKPIChart,
        refreshGoalChart: refreshGoalChart,
        refreshAll: refreshAll,
        destroy: destroy
    };
})();

// Auto-initialize
window.DashboardManager = DashboardManager;

document.addEventListener('DOMContentLoaded', () => {
    // Check if we're on the dashboard page
    if (document.getElementById('dashboard-view')) {
        DashboardManager.init();
    }
});

debugLog('DASHBOARD', 'SCRIPT LOADING COMPLETE');
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('dashboard_widgets.html');
}
</script>
