<script>
// ============================================================================
// AUDIT CRUD - Audit Trail and Revision History Operations
// ============================================================================

debugLog('AUDIT_CRUD', '╔════════════════════════════════════════════════════╗');
debugLog('AUDIT_CRUD', '║  AUDIT CRUD SCRIPT LOADING                           ║');
debugLog('AUDIT_CRUD', '╚════════════════════════════════════════════════════╝');

const AuditManager = (function() {
    'use strict';

    let auditTrailData = [];
    let currentPage = 1;
    const pageSize = 50;

    /**
     * Initialize module
     */
    function init() {
        debugLog('AUDIT_CRUD', '=== init START ===');
        loadUsersDropdown();
        loadAuditTrail();
        debugLog('AUDIT_CRUD', '=== init COMPLETE ===');
    }

    /**
     * Load users dropdown for filter
     */
    async function loadUsersDropdown() {
        debugLog('AUDIT_CRUD', 'Loading users dropdown...');

        try {
            const result = await apiCall('users/list');
            if (result.success && result.data) {
                const select = document.getElementById('auditUserFilter');
                if (select) {
                    select.innerHTML = '<option value="">All Users</option>';
                    result.data.forEach(u => {
                        select.innerHTML += `<option value="${u.user_id}">${u.full_name} (${u.username})</option>`;
                    });
                }
                debugLog('AUDIT_CRUD', 'OK Users dropdown loaded');
            }
        } catch (error) {
            debugLog('AUDIT_CRUD', 'EXCEPTION loading users dropdown:', error);
        }
    }

    /**
     * Load audit trail
     */
    async function loadAuditTrail(page = 1) {
        debugLog('AUDIT_CRUD', 'Loading audit trail page:', page);

        currentPage = page;

        const filters = collectFilters();

        try {
            const result = await apiCall('audit/get-history', {
                filters: filters,
                page: page,
                page_size: pageSize
            });

            if (result.success && result.data) {
                auditTrailData = Array.isArray(result.data) ? result.data : [result.data];
                renderAuditTrail(auditTrailData);

                if (result.pagination) {
                    renderPagination(result.pagination);
                }

                debugLog('AUDIT_CRUD', 'OK Loaded', auditTrailData.length, 'audit records');
            } else {
                renderAuditTrail([]);
            }
        } catch (error) {
            debugLog('AUDIT_CRUD', 'EXCEPTION loading audit trail:', error);
            showToast('Error loading audit trail', 'error');
        }
    }

    /**
     * Collect filters
     */
    function collectFilters() {
        const filters = {};

        const entityTypeEl = document.getElementById('auditEntityTypeFilter');
        const changeTypeEl = document.getElementById('auditChangeTypeFilter');
        const userEl = document.getElementById('auditUserFilter');
        const dateEl = document.getElementById('auditDateFilter');

        if (entityTypeEl && entityTypeEl.value) filters.entity_type = entityTypeEl.value;
        if (changeTypeEl && changeTypeEl.value) filters.change_type = changeTypeEl.value;
        if (userEl && userEl.value) filters.user_id = userEl.value;
        if (dateEl && dateEl.value) filters.date = dateEl.value;

        return filters;
    }

    /**
     * Render audit trail table
     */
    function renderAuditTrail(data) {
        const tbody = document.getElementById('auditTrailBody');
        if (!tbody) return;

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No audit records found</td></tr>';
            return;
        }

        const html = data.map(record => {
            const changeTypeClass = {
                'CREATE': 'success',
                'UPDATE': 'primary',
                'DELETE': 'danger',
                'RESTORE': 'warning'
            }[record.change_type] || 'secondary';

            // Truncate long values
            const oldValue = truncateValue(record.old_value);
            const newValue = truncateValue(record.new_value);

            return `
                <tr>
                    <td><small>${formatTimestamp(record.created_at)}</small></td>
                    <td><span class="badge bg-secondary">${record.entity_type}</span></td>
                    <td><code class="small">${record.entity_id.substring(0, 8)}...</code></td>
                    <td><small>${record.field_name}</small></td>
                    <td><span class="badge bg-${changeTypeClass}">${record.change_type}</span></td>
                    <td><small>${record.user_id || 'System'}</small></td>
                    <td><small class="text-muted">${oldValue}</small></td>
                    <td><small class="text-dark">${newValue}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="AuditManager.viewEntityHistory('${record.entity_type}', '${record.entity_id}')" title="View full history">
                                <i class="bi bi-clock-history"></i>
                            </button>
                            ${record.change_type === 'UPDATE' ? `
                                <button class="btn btn-outline-warning" onclick="AuditManager.compareValues('${record.revision_id}')" title="Compare values">
                                    <i class="bi bi-arrows-collapse"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        tbody.innerHTML = html;
    }

    /**
     * Truncate value for display
     */
    function truncateValue(value) {
        if (!value) return '-';
        const str = String(value);
        return str.length > 30 ? str.substring(0, 27) + '...' : str;
    }

    /**
     * Format timestamp
     */
    function formatTimestamp(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    /**
     * Render pagination
     */
    function renderPagination(pagination) {
        const paginationEl = document.getElementById('auditPagination');
        if (!paginationEl) return;

        const { total_pages, current_page } = pagination;

        let html = '';

        // Previous button
        html += `
            <li class="page-item ${current_page <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="AuditManager.loadAuditTrail(${current_page - 1}); return false;">Previous</a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= total_pages; i++) {
            if (i === 1 || i === total_pages || (i >= current_page - 2 && i <= current_page + 2)) {
                html += `
                    <li class="page-item ${i === current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="AuditManager.loadAuditTrail(${i}); return false;">${i}</a>
                    </li>
                `;
            } else if (i === current_page - 3 || i === current_page + 3) {
                html += '<li class="page-item disabled"><a class="page-link" href="#">...</a></li>';
            }
        }

        // Next button
        html += `
            <li class="page-item ${current_page >= total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="AuditManager.loadAuditTrail(${current_page + 1}); return false;">Next</a>
            </li>
        `;

        paginationEl.innerHTML = html;
    }

    /**
     * View full entity history
     */
    async function viewEntityHistory(entityType, entityId) {
        debugLog('AUDIT_CRUD', 'Viewing entity history:', entityType, entityId);

        try {
            const result = await apiCall('audit/entity-history', {
                entity_type: entityType,
                entity_id: entityId
            });

            if (result.success && result.data) {
                renderEntityHistoryModal(result.data, entityType, entityId);
            }
        } catch (error) {
            debugLog('AUDIT_CRUD', 'EXCEPTION loading entity history:', error);
            showToast('Error loading entity history', 'error');
        }
    }

    /**
     * Render entity history in modal
     */
    function renderEntityHistoryModal(data, entityType, entityId) {
        const container = document.getElementById('entityHistoryContent');
        if (!container) return;

        const html = `
            <div class="mb-3">
                <h6>Entity: ${entityType}</h6>
                <p class="text-muted small">ID: ${entityId}</p>
                <p class="text-muted small">Total Changes: ${data.length}</p>
            </div>
            <div class="timeline">
                ${data.map((record, index) => {
                    const changeTypeClass = {
                        'CREATE': 'success',
                        'UPDATE': 'primary',
                        'DELETE': 'danger',
                        'RESTORE': 'warning'
                    }[record.change_type] || 'secondary';

                    return `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <span class="badge bg-${changeTypeClass}">${record.change_type}</span>
                                        <small class="ms-2">${formatTimestamp(record.created_at)}</small>
                                    </div>
                                    <small>By: ${record.user_id || 'System'}</small>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">Field: ${record.field_name}</small>
                                        <p class="mb-0"><strong>Old Value:</strong> ${record.old_value || '-'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">Changed To</small>
                                        <p class="mb-0"><strong>New Value:</strong> ${record.new_value || '-'}</p>
                                    </div>
                                </div>
                                ${record.reason ? `<p class="mb-0 mt-2"><small><strong>Reason:</strong> ${record.reason}</small></p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

        container.innerHTML = html;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('entityHistoryModal'));
        modal.show();
    }

    /**
     * Compare old and new values
     */
    function compareValues(revisionId) {
        const record = auditTrailData.find(r => r.revision_id === revisionId);
        if (!record) return;

        const html = `
            <h6>Value Comparison</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-danger bg-opacity-10">
                        <div class="card-body">
                            <h6>Old Value</h6>
                            <pre>${record.old_value || '(empty)'}</pre>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-success bg-opacity-10">
                        <div class="card-body">
                            <h6>New Value</h6>
                            <pre>${record.new_value || '(empty)'}</pre>
                        </div>
                    </div>
                </div>
            </div>
        `;

        showModal('Value Comparison', html);
    }

    /**
     * Export audit trail
     */
    function exportAuditTrail() {
        if (!auditTrailData || auditTrailData.length === 0) {
            showToast('No data to export', 'warning');
            return;
        }

        // Convert to CSV
        let csv = 'Timestamp,Entity Type,Entity ID,Field,Change Type,User,Old Value,New Value\n';

        auditTrailData.forEach(record => {
            csv += `"${record.created_at}","${record.entity_type}","${record.entity_id}","${record.field_name}","${record.change_type}","${record.user_id || ''}","${record.old_value || ''}","${record.new_value || ''}"\n`;
        });

        // Create download link
        const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csv);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `audit_trail_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast('Audit trail exported to CSV', 'success');
    }

    // Public API
    return {
        init: init,
        loadAuditTrail: loadAuditTrail,
        viewEntityHistory: viewEntityHistory,
        compareValues: compareValues,
        exportAuditTrail: exportAuditTrail
    };
})();

// Auto-initialize
window.AuditManager = AuditManager;

document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('audit-trail-view')) {
        AuditManager.init();
    }
});

debugLog('AUDIT_CRUD', 'SCRIPT LOADING COMPLETE');
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('audit_crud.html');
}
</script>
