<script>
// ============================================================================
// ORGANIZATION PAGE - DataTable Management
// Page-specific DataTable namespace with lazy loading, caching, and filters
// ============================================================================

// Show table loading overlay
function showTableLoading(tableType) {
    debugLog('ORG_DT', 'Show loading for ' + tableType);
    const tableId = tableType + '-table';
    const table = document.getElementById(tableId);
    if (!table) return;

    // Create loading overlay if not exists
    let overlay = document.getElementById(tableId + '-loading');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = tableId + '-loading';
        overlay.className = 'table-loading-overlay';
        overlay.innerHTML = `
            <div class="d-flex justify-content-center align-items-center" style="min-height: 200px;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        table.parentElement.appendChild(overlay);
    }
    overlay.style.display = 'flex';
}

// Hide table loading overlay
function hideTableLoading(tableType) {
    debugLog('ORG_DT', 'Hide loading for ' + tableType);
    const overlay = document.getElementById(tableType + '-table-loading');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Page-specific namespace for Organization DataTables
window.OrganizationManager = (function() {
    'use strict';

    // Private: Data cache structure
    const dataCache = {
        directorates: {
            loaded: false,
            data: null,
            tableInstance: null
        },
        'work-units': {
            loaded: false,
            data: null,
            tableInstance: null
        },
        affairs: {
            loaded: false,
            data: null,
            tableInstance: null
        },
        positions: {
            loaded: false,
            data: null,
            tableInstance: null
        }
    };

    // Private: Map tab IDs to entity types
    const tabToEntityMap = {
        '#directorates': 'directorates',
        '#work-units': 'work-units',
        '#affairs': 'affairs',
        '#positions': 'positions'
    };

    // Private: Map entity types to API endpoints
    const entityToEndpointMap = {
        'directorates': 'directorates/list',
        'work-units': 'work-units/list',
        'affairs': 'affairs/list',
        'positions': 'positions/list'
    };

    // Private: Map CRUD types to cache keys
    const crudTypeToCacheKey = {
        'directorate': 'directorates',
        'work-unit': 'work-units',
        'affair': 'affairs',
        'position': 'positions'
    };

    // Private: Map CRUD types to endpoints for refresh
    const crudTypeToEndpoint = {
        'directorate': 'directorates/list',
        'work-unit': 'work-units/list',
        'affair': 'affairs/list',
        'position': 'positions/list'
    };

    // -------------------------------------------------------------------------
    // PUBLIC API
    // -------------------------------------------------------------------------

    return {
        // Public access to tables (for backward compatibility)
        tables: {
            directorates: null,
            workUnits: null,
            affairs: null,
            positions: null
        },

        // Public access to cache
        cache: dataCache,

        /**
         * Initialize the organization page
         * Sets up tab listeners and loads initial active tab
         */
        initialize: function() {
            debugLog('ORG_DT', '=== OrganizationManager.initialize START ===');

            // Setup Bootstrap tab event listener for lazy loading
            this.setupTabListeners();

            // Load the active tab's data
            const activeTab = document.querySelector('#organization-view .nav-link.active');
            if (activeTab) {
                const targetId = activeTab.getAttribute('data-bs-target');
                const entityType = tabToEntityMap[targetId];
                if (entityType) {
                    debugLog('ORG_DT', 'Active tab: ' + entityType + ', loading data...');
                    this.loadEntityDataIfNotCached(entityType);
                }
            }

            debugLog('ORG_DT', '=== OrganizationManager.initialize COMPLETE ===');
        },

        /**
         * Setup Bootstrap tab change event listeners
         */
        setupTabListeners: function() {
            const self = this;
            const organizationView = document.getElementById('organization-view');

            if (!organizationView) {
                debugLog('ORG_DT', 'Organization view not found, skipping tab listener setup');
                return;
            }

            // Listen for tab changes using Bootstrap's shown.bs.tab event
            organizationView.addEventListener('shown.bs.tab', function(event) {
                const targetId = event.target.getAttribute('data-bs-target');
                const entityType = tabToEntityMap[targetId];

                if (entityType) {
                    debugLog('ORG_DT', 'Tab switched to: ' + entityType);
                    self.loadEntityDataIfNotCached(entityType);
                }
            });

            debugLog('ORG_DT', 'OK Tab listeners setup complete');
        },

        /**
         * Load entity data if not already cached
         * @param {string} entityType - The entity type to load
         */
        loadEntityDataIfNotCached: async function(entityType) {
            // Check if already loaded
            if (dataCache[entityType].loaded) {
                debugLog('ORG_DT', entityType + ' already cached, skipping load');
                return;
            }

            debugLog('ORG_DT', '=== loadEntityDataIfNotCached START ===' + entityType);

            // Show loading
            showTableLoading(entityType);

            try {
                const endpoint = entityToEndpointMap[entityType];
                debugLog('ORG_DT', 'Calling endpoint: ' + endpoint);

                const result = await apiCall(endpoint);
                debugLog('ORG_DT', 'API result:', result);

                if (result.success) {
                    // Cache the data
                    dataCache[entityType].data = result.data || [];
                    dataCache[entityType].loaded = true;

                    // Render the table
                    this.renderEntityTable(entityType, result.data || []);

                    debugLog('ORG_DT', 'OK ' + entityType + ' loaded and cached');
                } else {
                    debugLog('ORG_DT', 'FAIL Failed to load ' + entityType + ': ' + result.message);
                    showToast('Failed to load ' + entityType + ': ' + result.message, 'error');
                }
            } catch (error) {
                debugLog('ORG_DT', 'FAIL Error loading ' + entityType + ':', error);
                showToast('Error loading ' + entityType + ': ' + error.message, 'error');
            } finally {
                hideTableLoading(entityType);
                debugLog('ORG_DT', '=== loadEntityDataIfNotCached COMPLETE ===');
            }
        },

        /**
         * Render entity table with data
         * @param {string} entityType - The entity type
         * @param {Array} data - The data to render
         */
        renderEntityTable: function(entityType, data) {
            debugLog('ORG_DT', '=== renderEntityTable START ===' + entityType + ', count=' + data.length);

            switch (entityType) {
                case 'directorates':
                    this.renderDirectorates(data);
                    break;
                case 'work-units':
                    this.renderWorkUnits(data);
                    break;
                case 'affairs':
                    this.renderAffairs(data);
                    break;
                case 'positions':
                    this.renderPositions(data);
                    break;
                default:
                    debugLog('ORG_DT', 'FAIL Unknown entity type: ' + entityType);
            }

            debugLog('ORG_DT', '=== renderEntityTable COMPLETE ===');
        },

        /**
         * Refresh specific table after CRUD operation
         * @param {string} crudType - The CRUD type (directorate, work-unit, affair, position)
         */
        refreshEntityTable: async function(crudType) {
            const cacheKey = crudTypeToCacheKey[crudType];
            const endpoint = crudTypeToEndpoint[crudType];

            debugLog('ORG_DT', '=== refreshEntityTable START ===' + crudType);

            showTableLoading(cacheKey);

            try {
                const result = await apiCall(endpoint);
                debugLog('ORG_DT', 'API result:', result);

                if (result.success) {
                    // Update cache
                    dataCache[cacheKey].data = result.data || [];

                    // Re-render table
                    this.renderEntityTable(cacheKey, result.data || []);

                    debugLog('ORG_DT', 'OK ' + crudType + ' table refreshed');
                } else {
                    debugLog('ORG_DT', 'FAIL Failed to refresh ' + crudType + ': ' + result.message);
                    showToast('Failed to refresh ' + crudType + ' table', 'error');
                }
            } catch (error) {
                debugLog('ORG_DT', 'FAIL Error refreshing ' + crudType + ':', error);
                showToast('Error refreshing ' + crudType + ' table', 'error');
            } finally {
                hideTableLoading(cacheKey);
                debugLog('ORG_DT', '=== refreshEntityTable COMPLETE ===');
            }
        },

        /**
         * Initialize filter listeners for an entity type
         * @param {string} entityType - The entity type
         */
        initializeFilters: function(entityType) {
            debugLog('ORG_DT', '=== initializeFilters START ===' + entityType);

            const filterInputs = document.querySelectorAll(
                '#' + entityType + '-filter-accordion .filter-input'
            );

            if (filterInputs.length === 0) {
                debugLog('ORG_DT', 'No filter inputs found for ' + entityType);
                return;
            }

            const self = this;

            filterInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const columnIndex = parseInt(this.getAttribute('data-column'));
                    const filterValue = this.value;
                    const table = dataCache[entityType].tableInstance;

                    if (table) {
                        table.column(columnIndex).search(filterValue).draw();
                        debugLog('ORG_DT', 'Filter applied: ' + entityType + ' col=' + columnIndex + ' value="' + filterValue + '"');
                    }
                });
            });

            debugLog('ORG_DT', 'OK Filters initialized for ' + entityType);
        },

        /**
         * Clear all filters for an entity type
         * @param {string} entityType - The entity type
         */
        clearFilters: function(entityType) {
            debugLog('ORG_DT', '=== clearFilters START ===' + entityType);

            const filterInputs = document.querySelectorAll(
                '#' + entityType + '-filter-accordion .filter-input'
            );

            filterInputs.forEach(input => {
                input.value = '';
            });

            const table = dataCache[entityType].tableInstance;
            if (table) {
                table.columns().search('').draw();
                debugLog('ORG_DT', 'OK All filters cleared for ' + entityType);
            }
        },

        // ======================================================================
        // RENDER FUNCTIONS
        // ======================================================================

        /**
         * Render Directorates table
         */
        renderDirectorates: function(directorates) {
            debugLog('ORG_DT', '=== renderDirectorates START === count=' + directorates.length);

            const table = $('#directorates-table');
            const tbody = document.getElementById('directorates-body');
            if (!tbody) {
                debugLog('ORG_DT', 'FAIL directorates-body NOT FOUND');
                return;
            }

            // Destroy existing DataTable (check both cache and jQuery DataTables API)
            if ($.fn.DataTable.isDataTable('#directorates-table')) {
                table.DataTable().destroy();
                debugLog('ORG_DT', 'OK DataTable destroyed via jQuery API');
            }
            dataCache.directorates.tableInstance = null;
            this.tables.directorates = null;

            if (!directorates.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No directorates found</td></tr>';
                debugLog('ORG_DT', 'OK No data to display');
                return;
            }

            // Generate HTML
            tbody.innerHTML = directorates.map(d =>
                '<tr>' +
                    '<td>' + (d.directorate_code || '-') + '</td>' +
                    '<td>' + d.directorate_name + '</td>' +
                    '<td>' + (d.description || '-') + '</td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="editItem(\'directorate\', \'' + d.directorate_id + '\')">Edit</button> ' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteItem(\'directorate\', \'' + d.directorate_id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>'
            ).join('');

            // Initialize DataTable
            dataCache.directorates.tableInstance = table.DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                language: { search: "_INPUT_", searchPlaceholder: "Search..." }
            });

            // Sync with public API
            this.tables.directorates = dataCache.directorates.tableInstance;

            debugLog('ORG_DT', 'OK DataTable initialized with ' + dataCache.directorates.tableInstance.rows().count() + ' rows');

            // Initialize filters
            this.initializeFilters('directorates');

            debugLog('ORG_DT', '=== renderDirectorates COMPLETE ===');
        },

        /**
         * Render Work Units table
         */
        renderWorkUnits: function(workUnits) {
            debugLog('ORG_DT', '=== renderWorkUnits START === count=' + workUnits.length);

            const table = $('#work-units-table');
            const tbody = document.getElementById('work-units-body');
            if (!tbody) {
                debugLog('ORG_DT', 'FAIL work-units-body NOT FOUND');
                return;
            }

            // Destroy existing DataTable (check both cache and jQuery DataTables API)
            if ($.fn.DataTable.isDataTable('#work-units-table')) {
                table.DataTable().destroy();
                debugLog('ORG_DT', 'OK DataTable destroyed via jQuery API');
            }
            dataCache['work-units'].tableInstance = null;
            this.tables.workUnits = null;

            if (!workUnits.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No work units found</td></tr>';
                debugLog('ORG_DT', 'OK No data to display');
                return;
            }

            tbody.innerHTML = workUnits.map(w =>
                '<tr>' +
                    '<td>' + (w.work_unit_code || '-') + '</td>' +
                    '<td>' + w.work_unit_name + '</td>' +
                    '<td>' + (w.directorate_name || '-') + '</td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="editItem(\'work-unit\', \'' + w.work_unit_id + '\')">Edit</button> ' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteItem(\'work-unit\', \'' + w.work_unit_id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>'
            ).join('');

            dataCache['work-units'].tableInstance = table.DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                language: { search: "_INPUT_", searchPlaceholder: "Search..." }
            });

            this.tables.workUnits = dataCache['work-units'].tableInstance;

            debugLog('ORG_DT', 'OK DataTable initialized with ' + dataCache['work-units'].tableInstance.rows().count() + ' rows');

            this.initializeFilters('work-units');

            debugLog('ORG_DT', '=== renderWorkUnits COMPLETE ===');
        },

        /**
         * Render Affairs table
         */
        renderAffairs: function(affairs) {
            debugLog('ORG_DT', '=== renderAffairs START === count=' + affairs.length);

            const table = $('#affairs-table');
            const tbody = document.getElementById('affairs-body');
            if (!tbody) {
                debugLog('ORG_DT', 'FAIL affairs-body NOT FOUND');
                return;
            }

            // Destroy existing DataTable (check both cache and jQuery DataTables API)
            if ($.fn.DataTable.isDataTable('#affairs-table')) {
                table.DataTable().destroy();
                debugLog('ORG_DT', 'OK DataTable destroyed via jQuery API');
            }
            dataCache.affairs.tableInstance = null;
            this.tables.affairs = null;

            if (!affairs.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No affairs found</td></tr>';
                debugLog('ORG_DT', 'OK No data to display');
                return;
            }

            tbody.innerHTML = affairs.map(a => {
                const hierarchy = [];
                if (a.directorate_name && a.directorate_name !== '-') hierarchy.push(a.directorate_name);
                if (a.work_unit_name && a.work_unit_name !== '-') hierarchy.push(a.work_unit_name);
                const hierarchyDisplay = hierarchy.length > 0 ? hierarchy.join(' > ') : '-';

                return '<tr>' +
                    '<td>' + (a.affair_code || '-') + '</td>' +
                    '<td>' + a.affair_name + '</td>' +
                    '<td><small>' + hierarchyDisplay + '</small></td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="editItem(\'affair\', \'' + a.affair_id + '\')">Edit</button> ' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteItem(\'affair\', \'' + a.affair_id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            dataCache.affairs.tableInstance = table.DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                language: { search: "_INPUT_", searchPlaceholder: "Search..." }
            });

            this.tables.affairs = dataCache.affairs.tableInstance;

            debugLog('ORG_DT', 'OK DataTable initialized with ' + dataCache.affairs.tableInstance.rows().count() + ' rows');

            this.initializeFilters('affairs');

            debugLog('ORG_DT', '=== renderAffairs COMPLETE ===');
        },

        /**
         * Render Positions table
         */
        renderPositions: function(positions) {
            debugLog('ORG_DT', '=== renderPositions START === count=' + positions.length);

            const table = $('#positions-table');
            const tbody = document.getElementById('positions-body');
            if (!tbody) {
                debugLog('ORG_DT', 'FAIL positions-body NOT FOUND');
                return;
            }

            // Destroy existing DataTable (check both cache and jQuery DataTables API)
            if ($.fn.DataTable.isDataTable('#positions-table')) {
                table.DataTable().destroy();
                debugLog('ORG_DT', 'OK DataTable destroyed via jQuery API');
            }
            dataCache.positions.tableInstance = null;
            this.tables.positions = null;

            if (!positions.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No positions found</td></tr>';
                debugLog('ORG_DT', 'OK No data to display');
                return;
            }

            tbody.innerHTML = positions.map(p => {
                const hierarchy = [];
                if (p.directorate_name && p.directorate_name !== '-') hierarchy.push(p.directorate_name);
                if (p.work_unit_name && p.work_unit_name !== '-') hierarchy.push(p.work_unit_name);
                if (p.affair_name && p.affair_name !== '-') hierarchy.push(p.affair_name);
                const hierarchyDisplay = hierarchy.length > 0 ? hierarchy.join(' > ') : '-';

                return '<tr>' +
                    '<td>' + (p.position_code || '-') + '</td>' +
                    '<td>' + p.position_name + '</td>' +
                    '<td>' + (p.position_level || '-') + '</td>' +
                    '<td><small>' + hierarchyDisplay + '</small></td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary" onclick="editItem(\'position\', \'' + p.position_id + '\')">Edit</button> ' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteItem(\'position\', \'' + p.position_id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            dataCache.positions.tableInstance = table.DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                language: { search: "_INPUT_", searchPlaceholder: "Search..." }
            });

            this.tables.positions = dataCache.positions.tableInstance;

            debugLog('ORG_DT', 'OK DataTable initialized with ' + dataCache.positions.tableInstance.rows().count() + ' rows');

            this.initializeFilters('positions');

            debugLog('ORG_DT', '=== renderPositions COMPLETE ===');
        }
    };
})();

// Track script loading
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('organization_datatables.html');
}
</script>
