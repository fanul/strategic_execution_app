<script>
// Page navigation via AJAX
function navigateToPage(pageName) {
    debugLog('AJAX', 'Loading page: ' + pageName);

    // Show loading in main content area
    showViewLoading();

    // Update active nav
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    const activeLink = document.querySelector('.nav-link[data-page="' + pageName + '"]');
    if (activeLink) activeLink.classList.add('active');

    // Fetch page content
    apiCall('page/get', { page: pageName })
        .then(async response => {
            if (response.success) {
                // Update main content
                const mainContent = document.getElementById('main-content');
                if (!mainContent) {
                    showToast('Critical error: Main content container not found', 'error');
                    debugLog('AJAX', 'FAIL: main-content element not found');
                    return;
                }
                mainContent.innerHTML = response.data.content;

                // Update modals container
                const modalContainer = document.getElementById('page-modals');
                if (modalContainer) modalContainer.innerHTML = response.data.modals;

                // Execute page scripts (synchronous for GAS compatibility)
                executeScripts(response.data.scripts);

                // Update URL
                const url = new URL(window.location.href);
                url.searchParams.set('page', pageName);
                window.history.pushState({ page: pageName }, '', url);

                // Initialize page
                initPage(pageName);

                debugLog('AJAX', 'Page loaded: ' + pageName);
            } else {
                showToast('Failed to load page: ' + response.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error loading page: ' + error, 'error');
            debugLog('AJAX', 'Error: ' + error);
        })
        .finally(() => {
            hideViewLoading();
        });
}

// Show loading in main content area
function showViewLoading() {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;
    mainContent.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading...</p>
            </div>
        </div>
    `;
}

// Hide view loading (content already replaced)
function hideViewLoading() {
    // Content already replaced, nothing to hide
}

// Execute scripts dynamically with proper sequencing
function executeScripts(scriptHTML) {
    debugLog('AJAX', '=== executeScripts START ===');
    debugLog('AJAX', 'Script HTML length:', scriptHTML ? scriptHTML.length : 0);

    if (!scriptHTML || scriptHTML.trim() === '') {
        debugLog('AJAX', 'No scripts to execute');
        return;
    }

    try {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = scriptHTML;

        const scripts = tempDiv.querySelectorAll('script');
        debugLog('AJAX', 'Found ' + scripts.length + ' script tags to execute');

        // Execute scripts using direct injection (GAS compatible)
        // In GAS environment, script.onload events are unreliable, so we inject synchronously
        scripts.forEach((oldScript, index) => {
            debugLog('AJAX', 'Executing script ' + (index + 1) + ' of ' + scripts.length);

            try {
                // Create new script element
                const newScript = document.createElement('script');

                // Copy all attributes
                Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                });

                // Set script content directly
                newScript.textContent = oldScript.textContent;

                // Log script content preview
                const scriptPreview = oldScript.textContent.substring(0, 100).replace(/\n/g, ' ');
                debugLog('AJAX', 'Script ' + (index + 1) + ' preview: ' + scriptPreview + '...');

                // Inject script - will execute immediately in GAS environment
                document.body.appendChild(newScript);

                debugLog('AJAX', 'OK Script ' + (index + 1) + ' executed');
            } catch (scriptError) {
                debugLog('AJAX', 'FAIL Error executing script ' + (index + 1) + ':', scriptError);
                // Continue with remaining scripts even if one fails
            }
        });

        debugLog('AJAX', '=== executeScripts COMPLETE ===');
        debugLog('AJAX', 'Verifying loaded functions:');
        debugLog('AJAX', '  - typeof switchView: ' + typeof switchView);
        debugLog('AJAX', '  - typeof OrgDiagram: ' + typeof OrgDiagram);
        debugLog('AJAX', '  - typeof OrganizationManager: ' + typeof OrganizationManager);

    } catch (error) {
        debugLog('AJAX', 'EXCEPTION Fatal error in executeScripts:', error);
        showToast('Error loading page scripts. Some features may not work properly.', 'warning');
        throw error; // Re-throw so caller can handle it
    }
}

// Initialize page-specific functionality
function initPage(pageName) {
    debugLog('AJAX', 'Initializing page: ' + pageName);

    switch (pageName) {
        case 'organization':
            if (typeof window.OrganizationManager !== 'undefined') {
                window.OrganizationManager.initialize();
            }
            break;
        case 'settings':
            if (typeof loadSettings === 'function') {
                loadSettings();
            }
            break;
        case 'dashboard':
        case 'strategic-plan':
        case 'kpi':
            // Add initialization for these pages when needed
            break;
    }
}

// Handle browser back/forward
window.addEventListener('popstate', (event) => {
    const page = event.state?.page || 'dashboard';
    debugLog('AJAX', 'Popstate - navigating to: ' + page);
    navigateToPage(page);
});

// Track script loading
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('ajax_loader.html');
}
</script>
