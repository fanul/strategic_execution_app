<!-- strategic-plan.html -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-compass"></i> Strategic Planning</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <select class="form-select select2 form-select-sm me-2" id="periodSelector" onchange="loadPeriodData()" style="width: 300px;">
            <option value="">Select Period...</option>
        </select>
        <button type="button" class="btn btn-sm btn-primary" onclick="createNewPeriod()">
            <i class="bi bi-plus-circle"></i> New Period
        </button>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-3" id="strategicTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="periods-tab" data-bs-toggle="tab" data-bs-target="#periods" type="button">
            <i class="bi bi-calendar-range"></i> Periods
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="vision-tab" data-bs-toggle="tab" data-bs-target="#vision" type="button">
            <i class="bi bi-eye"></i> Vision & Mission
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="initiatives-tab" data-bs-toggle="tab" data-bs-target="#initiatives" type="button">
            <i class="bi bi-lightning"></i> Initiatives
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals" type="button">
            <i class="bi bi-bullseye"></i> Goals
        </button>
    </li>
</ul>

<div class="tab-content pt-3" id="strategicTabContent">
    <!-- Periods Tab -->
    <div class="tab-pane fade show active" id="periods" role="tabpanel">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Planning Periods</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="periodsTable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Year Range</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="periodsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Vision & Mission Tab -->
    <div class="tab-pane fade" id="vision" role="tabpanel">
        <div id="visionEmptyState" class="text-center mt-5">
            <p class="text-muted"><i class="bi bi-arrow-up-circle"></i> Please select a Period from the toolbar above to manage Vision and Mission.</p>
        </div>
        
        <div id="visionActiveState" class="d-none">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between">
                    <h6 class="m-0 font-weight-bold">Vision Statement</h6>
                    <span class="badge bg-light text-dark" id="visionStatus" onclick="approveVision()" style="cursor: pointer;" title="Click to approve">DRAFT</span>
                </div>
                <div class="card-body">
                    <form id="visionForm">
                        <input type="hidden" name="vision_id" id="visionIdField">
                        <input type="hidden" name="period_id" id="visionPeriodId">
                        <div class="mb-3">
                            <textarea class="form-control" name="vision_text" id="visionText" rows="3" placeholder="Enter the organization's vision statement..."></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveVision()">Save Vision</button>
                            <div id="visionLastUpdated" class="small text-muted"></div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Missions</h6>
                    <button class="btn btn-sm btn-success" onclick="createMission()">
                        <i class="bi bi-plus"></i> New Mission
                    </button>
                </div>
                <div class="card-body">
                     <div class="table-responsive">
                        <table id="missionsTable" class="table table-bordered table-hover table-striped datatable" width="100%">
                            <thead class="table-light">
                                <tr>
                                    <th>Code</th>
                                    <th>Mission Statement</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Initiatives Tab -->
    <div class="tab-pane fade" id="initiatives" role="tabpanel">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Strategic Initiatives</h6>
                <button class="btn btn-sm btn-success" onclick="createInitiative()">
                    <i class="bi bi-plus"></i> New Initiative
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="initiativesTable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Theme</th>
                                <th>Title</th>
                                <th>Year</th>
                                <th>Budget</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="initiativesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals Tab -->
    <div class="tab-pane fade" id="goals" role="tabpanel">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Organizational Goals</h6>
                <button class="btn btn-sm btn-success" onclick="createGoal()">
                    <i class="bi bi-plus"></i> New Goal
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="goalsTable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>Goal Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="goalsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Period -->
<div class="modal fade" id="periodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="periodForm">
                    <input type="hidden" name="period_id" id="formPeriodId">
                    <div class="mb-3">
                        <label class="form-label">Period Name</label>
                        <input type="text" class="form-control" name="period_name" id="formPeriodName" required placeholder="e.g., RPJMN 2025-2029">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Year</label>
                            <input type="number" class="form-control" name="start_year" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">End Year</label>
                            <input type="number" class="form-control" name="end_year" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-control" name="period_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="savePeriodBtn" onclick="savePeriod()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Mission -->
<div class="modal fade" id="missionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Mission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="missionForm">
                    <input type="hidden" name="mission_id" id="formMissionId">
                    <input type="hidden" name="vision_id" id="formMissionVisionId">
                    <div class="mb-3">
                        <label class="form-label">Mission Code</label>
                        <input type="text" class="form-control" name="mission_code" id="formMissionCode" placeholder="MIS-2025-001">
                        <small class="text-muted">Leave blank for auto-generation</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mission Statement</label>
                        <textarea class="form-control" name="mission_text" id="formMissionText" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Order</label>
                        <input type="number" class="form-control" name="mission_order" id="formMissionOrder">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveMission()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Initiative -->
<div class="modal fade" id="initiativeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Strategic Initiative</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="initiativeForm">
                    <input type="hidden" name="initiative_id" id="formInitiativeId">
                    <div class="mb-3">
                        <label class="form-label">Theme Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="theme_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Theme Code</label>
                        <input type="text" class="form-control" name="theme_code" placeholder="Leave blank for auto-generation">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Year <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="year" id="initiativeYear" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Budget Allocated</label>
                        <div class="input-group">
                            <span class="input-group-text">Rp</span>
                            <input type="number" class="form-control" name="budget_allocated">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Description</label>
                        <textarea class="form-control" name="target_description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveInitiative()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Goal -->
<div class="modal fade" id="goalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Organizational Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="goalForm">
                    <input type="hidden" name="goal_id" id="formGoalId">
                    <div class="mb-3">
                        <label class="form-label">Goal Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="goal_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Goal Code</label>
                        <input type="text" class="form-control" name="goal_code" placeholder="Leave blank for auto-generation">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Year <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="year" id="goalYear" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Goal Description</label>
                        <textarea class="form-control" name="goal_description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Description</label>
                        <textarea class="form-control" name="target_description" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveGoal()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Deletion Impact -->
<div class="modal fade" id="deleteImpactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this period? This action is <strong>irreversible</strong> and will delete all associated data:</p>
                <ul id="impactList" class="list-group list-group-flush mb-3">
                    <!-- Impact items here -->
                </ul>
                <div class="alert alert-warning">
                    Type <strong>DELETE</strong> to confirm:
                    <input type="text" class="form-control mt-2" id="deleteConfirmText" placeholder="DELETE">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="executeDelete()">Delete Everything</button>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
        color: #0d6efd !important;
        background-color: #fff !important;
        border: 1px solid #0d6efd;
        font-weight: bold;
    }
    .select2-container { z-index: 9999; }
</style>

<script>
// Logic
let periodsTable, missionsTable, initiativesTable, goalsTable;
let currentPeriodId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Init Tables
    periodsTable = $('#periodsTable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    missionsTable = $('#missionsTable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    initiativesTable = $('#initiativesTable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    goalsTable = $('#goalsTable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    
    // Init Select2 - Exclude DataTables length menus
    $('.select2:not(.dataTables_length select)').each(function() {
        $(this).select2({ 
            theme: 'bootstrap-5',
            dropdownParent: $(this).closest('.modal').length ? $(this).closest('.modal') : $('body'),
            width: $(this).data('width') || $(this).hasClass('w-100') ? '100%' : 'resolve'
        });
    });
    
    $('#periodSelector').on('select2:select', function(e) {
        loadPeriodData();
    });

    loadPeriods();
});

function loadPeriods() {
    google.script.run.withSuccessHandler(renderPeriods).callAPI('strategic/periods/list', {});
}

function createNewPeriod() {
    document.getElementById('periodForm').reset();
    document.getElementById('formPeriodId').value = '';
    document.getElementById('periodModal').querySelector('.modal-title').textContent = 'New Period';
    new bootstrap.Modal(document.getElementById('periodModal')).show();
}

let cachedPeriods = [];

function renderPeriods(response) {
    if (!response || !response.success) return;
    const data = response.data || [];
    cachedPeriods = data; // Cache for edit
    
    if (periodsTable) periodsTable.clear();
    const selector = $('#periodSelector');
    selector.empty().append(new Option('Select Period...', ''));
    
    data.forEach(p => {
        const periodName = p.period_name || p.period_code || `${p.start_year}-${p.end_year}`;
        
        periodsTable.row.add([
            p.period_code || '-',
            periodName,
            `${p.start_year || '?'} - ${p.end_year || '?'}`,
            `<span class="badge ${p.is_active ? 'bg-success' : 'bg-secondary'}">${p.is_active ? 'Active' : 'Inactive'}</span>`,
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editPeriod('${p.period_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePeriod('${p.period_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
        
        const option = new Option(periodName + (p.is_active ? ' (Active)' : ''), p.period_id);
        if (p.is_active) option.selected = true;
        selector.append(option);
    });
    periodsTable.draw();
    selector.trigger('change'); // Trigger load of active period
    
    // Also trigger loadPeriodData manually if Select2 'change' doesn't fire on programmatic set?
    // Select2 usually doesn't fire change on append. BUT logic below relies on user interaction OR existing value.
    // If active found, load it.
    const val = selector.val();
    if (val) loadPeriodData();
}

function loadPeriodData() {
    const periodId = $('#periodSelector').val();
    if (!periodId) return;
    currentPeriodId = periodId;
    
    // Load Visions
    google.script.run.withSuccessHandler(renderVisions).callAPI('strategic/visions/by-period', {period_id: periodId});
    
    // Load Initiatives and Goals based on current year or start year of period
    const period = cachedPeriods.find(p => p.period_id === periodId);
    if (period) {
        const year = period.start_year || new Date().getFullYear();
        loadInitiatives(year);
        loadGoals(year);
    }
}

let cachedInitiatives = [];
let cachedGoals = [];

function loadInitiatives(year) {
    google.script.run.withSuccessHandler(renderInitiatives).callAPI('strategic/initiatives/by-year', {year: year});
}

function renderInitiatives(response) {
    if (initiativesTable) initiativesTable.clear();
    if (!response || !response.success) {
        if (initiativesTable) initiativesTable.draw();
        return;
    }
    
    const data = response.data || [];
    cachedInitiatives = data;
    data.forEach(i => {
        initiativesTable.row.add([
            i.theme_code || '-',
            i.theme_name,
            i.year,
            i.budget_allocated ? 'Rp ' + i.budget_allocated.toLocaleString() : '-',
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editInitiative('${i.initiative_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteInitiative('${i.initiative_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
    });
    initiativesTable.draw();
}

function loadGoals(year) {
    google.script.run.withSuccessHandler(renderGoals).callAPI('strategic/goals/by-year', {year: year});
}

function renderGoals(response) {
    if (goalsTable) goalsTable.clear();
    if (!response || !response.success) {
        if (goalsTable) goalsTable.draw();
        return;
    }
    
    const data = response.data || [];
    cachedGoals = data;
    data.forEach(g => {
        goalsTable.row.add([
            g.goal_code || '-',
            g.goal_name,
            `<span class="badge ${g.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${g.status || 'PLANNING'}</span>`,
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editGoal('${g.goal_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteGoal('${g.goal_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
    });
    goalsTable.draw();
}

let currentVisionId = null;
let cachedMissions = [];

function renderVisions(response) {
    const emptyState = document.getElementById('visionEmptyState');
    const activeState = document.getElementById('visionActiveState');
    
    // Toggle visibility
    if (emptyState) emptyState.classList.add('d-none');
    if (activeState) activeState.classList.remove('d-none');
    
    // Set Period ID for the form
    document.getElementById('visionPeriodId').value = currentPeriodId;
    
    if (response && response.success && response.data && response.data.length > 0) {
        const v = response.data[0];
        currentVisionId = v.vision_id;
        document.getElementById('visionIdField').value = v.vision_id;
        document.getElementById('visionText').value = v.vision_text || '';
        document.getElementById('visionStatus').textContent = v.approval_status || 'DRAFT';
        if (v.updated_at) {
            document.getElementById('visionLastUpdated').textContent = 'Last updated: ' + v.updated_at;
        }
        
        // Load Missions for this vision
        loadMissions(v.vision_id);
    } else {
        currentVisionId = null;
        document.getElementById('visionIdField').value = '';
        document.getElementById('visionText').value = '';
        document.getElementById('visionStatus').textContent = 'DRAFT';
        document.getElementById('visionLastUpdated').textContent = '';
        if (missionsTable) {
            missionsTable.clear().draw();
        }
    }
}

function saveVision() {
    const form = document.getElementById('visionForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const visionId = data.vision_id;
    
    if (!data.vision_text) {
        alert('Please enter vision text');
        return;
    }
    
    const action = visionId ? 'strategic/updateVision' : 'strategic/visions/create';
    const payload = visionId ? { visionId: visionId, updates: { vision_text: data.vision_text } } : data;
    
    google.script.run.withSuccessHandler(response => {
        if (response.success) {
            showToast('Vision saved successfully', 'Success');
            loadPeriodData();
        } else {
            alert('Error: ' + response.message);
        }
    }).callAPI(action, payload);
}

function approveVision() {
    if (!currentVisionId) return;
    
    const status = document.getElementById('visionStatus').textContent;
    if (status === 'APPROVED') {
        showToast('Vision is already approved', 'Info');
        return;
    }
    
    if (confirm('Approve this vision statement?')) {
        google.script.run.withSuccessHandler(response => {
            if (response.success) {
                showToast('Vision approved!', 'Success');
                loadPeriodData();
            } else {
                alert('Error: ' + response.message);
            }
        }).callAPI('strategic/visions/approve', { visionId: currentVisionId });
    }
}

function loadMissions(visionId) {
    // Standard Load
    google.script.run.withSuccessHandler(renderMissions).callAPI('strategic/missions/by-vision', {vision_id: visionId});
}

function renderMissions(response) {
    if (missionsTable) missionsTable.clear();
    if (!response || !response.success) {
        if (missionsTable) missionsTable.draw();
        return;
    }
    
    const data = response.data || [];
    cachedMissions = data;
    data.forEach(m => {
        missionsTable.row.add([
            m.mission_code || '-',
            m.mission_text,
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editMission('${m.mission_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteMission('${m.mission_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
    });
    missionsTable.draw();
}

function createMission() {
    if (!currentVisionId) {
        alert('Please save the Vision first before adding Missions.');
        return;
    }
    document.getElementById('missionForm').reset();
    document.getElementById('formMissionId').value = '';
    document.getElementById('formMissionVisionId').value = currentVisionId;
    document.getElementById('missionModal').querySelector('.modal-title').textContent = 'New Mission';
    new bootstrap.Modal(document.getElementById('missionModal')).show();
}

function editMission(id) {
    const m = cachedMissions.find(item => item.mission_id === id);
    if (!m) return;
    
    document.getElementById('formMissionId').value = m.mission_id;
    document.getElementById('formMissionVisionId').value = m.vision_id;
    document.getElementById('formMissionCode').value = m.mission_code || '';
    document.getElementById('formMissionText').value = m.mission_text || '';
    document.getElementById('formMissionOrder').value = m.mission_order || '';
    
    document.getElementById('missionModal').querySelector('.modal-title').textContent = 'Edit Mission';
    new bootstrap.Modal(document.getElementById('missionModal')).show();
}

function saveMission() {
    const form = document.getElementById('missionForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const missionId = data.mission_id;
    
    if (!data.mission_text) {
        alert('Please enter mission statement');
        return;
    }
    
    const action = missionId ? 'strategic/updateMission' : 'strategic/createMission';
    const payload = missionId ? { missionId: missionId, updates: data } : data;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('missionModal')).hide();
            showToast(missionId ? 'Mission updated' : 'Mission created', 'Success');
            loadMissions(currentVisionId);
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI(action, payload);
}

function deleteMission(id) {
    if (confirm('Are you sure you want to delete this mission?')) {
        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                showToast('Mission deleted', 'Success');
                loadMissions(currentVisionId);
            } else {
                alert('Error: ' + res.message);
            }
        }).callAPI('strategic/deleteMission', {missionId: id});
    }
}

function createInitiative() {
    if (!currentPeriodId) {
        alert('Please select a period first.');
        return;
    }
    const period = cachedPeriods.find(p => p.period_id === currentPeriodId);
    document.getElementById('initiativeForm').reset();
    document.getElementById('formInitiativeId').value = '';
    document.getElementById('initiativeYear').value = period ? period.start_year : new Date().getFullYear();
    document.getElementById('initiativeModal').querySelector('.modal-title').textContent = 'New Strategic Initiative';
    new bootstrap.Modal(document.getElementById('initiativeModal')).show();
}

function editInitiative(id) {
    const item = cachedInitiatives.find(i => i.initiative_id === id);
    if (!item) return;
    
    const form = document.getElementById('initiativeForm');
    form.reset();
    document.getElementById('formInitiativeId').value = item.initiative_id;
    form.theme_name.value = item.theme_name || '';
    form.theme_code.value = item.theme_code || '';
    form.year.value = item.year || '';
    form.budget_allocated.value = item.budget_allocated || '';
    form.target_description.value = item.target_description || '';
    
    document.getElementById('initiativeModal').querySelector('.modal-title').textContent = 'Edit Strategic Initiative';
    new bootstrap.Modal(document.getElementById('initiativeModal')).show();
}

function saveInitiative() {
    const form = document.getElementById('initiativeForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const id = data.initiative_id;
    
    if (!data.theme_name || !data.year) {
        alert('Please fill in required fields');
        return;
    }
    
    const action = id ? 'strategic/updateInitiative' : 'strategic/createInitiative';
    const payload = id ? { initiativeId: id, updates: data } : data;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('initiativeModal')).hide();
            showToast(id ? 'Initiative updated' : 'Initiative created', 'Success');
            loadInitiatives(data.year);
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI(action, payload);
}

function deleteInitiative(id) {
    if (!confirm('Are you sure you want to delete this initiative?')) return;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            showToast('Initiative deleted', 'Success');
            const period = cachedPeriods.find(p => p.period_id === currentPeriodId);
            loadInitiatives(period ? period.start_year : new Date().getFullYear());
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI('strategic/deleteInitiative', {initiativeId: id});
}

function createGoal() {
    if (!currentPeriodId) {
        alert('Please select a period first.');
        return;
    }
    const period = cachedPeriods.find(p => p.period_id === currentPeriodId);
    document.getElementById('goalForm').reset();
    document.getElementById('formGoalId').value = '';
    document.getElementById('goalYear').value = period ? period.start_year : new Date().getFullYear();
    document.getElementById('goalModal').querySelector('.modal-title').textContent = 'New Organizational Goal';
    new bootstrap.Modal(document.getElementById('goalModal')).show();
}

function editGoal(id) {
    const item = cachedGoals.find(i => i.goal_id === id);
    if (!item) return;
    
    const form = document.getElementById('goalForm');
    form.reset();
    document.getElementById('formGoalId').value = item.goal_id;
    form.goal_name.value = item.goal_name || '';
    form.goal_code.value = item.goal_code || '';
    form.year.value = item.year || '';
    form.goal_description.value = item.goal_description || '';
    form.target_description.value = item.target_description || '';
    
    document.getElementById('goalModal').querySelector('.modal-title').textContent = 'Edit Organizational Goal';
    new bootstrap.Modal(document.getElementById('goalModal')).show();
}

function saveGoal() {
    const form = document.getElementById('goalForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const id = data.goal_id;
    
    if (!data.goal_name || !data.year) {
        alert('Please fill in required fields');
        return;
    }
    
    const action = id ? 'strategic/updateGoal' : 'strategic/createGoal';
    const payload = id ? { goalId: id, updates: data } : data;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('goalModal')).hide();
            showToast(id ? 'Goal updated' : 'Goal created', 'Success');
            loadGoals(data.year);
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI(action, payload);
}

function deleteGoal(id) {
    if (!confirm('Are you sure you want to delete this goal?')) return;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            showToast('Goal deleted', 'Success');
             const period = cachedPeriods.find(p => p.period_id === currentPeriodId);
            loadGoals(period ? period.start_year : new Date().getFullYear());
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI('strategic/deleteGoal', {goalId: id});
}


function createNewPeriod() {
    document.getElementById('periodForm').reset();
    new bootstrap.Modal(document.getElementById('periodModal')).show();
}

function savePeriod() {
    const form = document.getElementById('periodForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const periodId = data.period_id;
    
    const action = periodId ? 'strategic/periods/update' : 'strategic/periods/create';
    const payload = periodId ? { periodId: periodId, updates: data } : data;

    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('periodModal')).hide();
            showToast(periodId ? 'Period updated' : 'Period created', 'Success');
            loadPeriods();
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI(action, payload);
}

function editPeriod(id) {
    const p = cachedPeriods.find(item => item.period_id === id);
    if (!p) return;
    
    document.getElementById('formPeriodId').value = p.period_id;
    document.getElementById('formPeriodName').value = p.period_name || '';
    document.getElementsByName('start_year')[0].value = p.start_year || '';
    document.getElementsByName('end_year')[0].value = p.end_year || '';
    document.getElementsByName('period_code')[0].value = p.period_code || '';
    document.getElementsByName('description')[0].value = p.description || '';
    document.getElementsByName('notes')[0].value = p.notes || '';
    
    document.getElementById('periodModal').querySelector('.modal-title').textContent = 'Edit Period';
    new bootstrap.Modal(document.getElementById('periodModal')).show();
}

let deleteTargetId = null;

function deletePeriod(id) {
    deleteTargetId = id;
    document.getElementById('deleteConfirmText').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            const impact = res.impact;
            const list = document.getElementById('impactList');
            list.innerHTML = `
                <li class="list-group-item d-flex justify-content-between">Visions <span>${impact.visions}</span></li>
                <li class="list-group-item d-flex justify-content-between">Missions <span>${impact.missions}</span></li>
                <li class="list-group-item d-flex justify-content-between">Goals <span>${impact.orgGoals}</span></li>
                <li class="list-group-item d-flex justify-content-between">KPIs <span>${impact.kpis}</span></li>
                <li class="list-group-item d-flex justify-content-between">Programs <span>${impact.programs}</span></li>
            `;
            new bootstrap.Modal(document.getElementById('deleteImpactModal')).show();
        }
    }).callAPI('strategic/getPeriodDeletionImpact', {periodId: id});
}

document.getElementById('deleteConfirmText')?.addEventListener('input', function(e) {
    document.getElementById('confirmDeleteBtn').disabled = (e.target.value !== 'DELETE');
});

function executeDelete() {
    if (!deleteTargetId) return;
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('deleteImpactModal')).hide();
            showToast('Period and all related data deleted', 'Success');
            loadPeriods();
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI('strategic/deletePeriod', {periodId: deleteTargetId});
}

// End of script
</script>
