<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Data Import</h1>
</div>

<!-- Import Options -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow h-100">
            <div class="card-header">
                <h6 class="m-0"><i class="bi bi-file-earmark-arrow-up me-2"></i>1. Select Entity Type</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">What do you want to import?</label>
                    <select class="form-select" id="import-entity-type" onchange="updateImportOptions()">
                        <option value="">-- Select --</option>
                        <option value="users">Users</option>
                        <option value="directorates">Directorates</option>
                        <option value="workunits">Work Units</option>
                        <option value="affairs">Affairs</option>
                        <option value="positions">Positions</option>
                        <option value="kpis">KPIs</option>
                        <option value="individual-kpis">Individual KPIs</option>
                        <option value="goals">Organizational Goals</option>
                        <option value="workunit-goals">Work Unit Goals</option>
                        <option value="programs">Programs</option>
                        <option value="activities">Activities</option>
                        <option value="okrs">OKRs</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Download <a href="#" onclick="downloadTemplate()">template</a> to see required fields</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow h-100">
            <div class="card-header">
                <h6 class="m-0"><i class="bi bi-cloud-upload me-2"></i>2. Upload File</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Choose file format</label>
                    <select class="form-select" id="import-file-format">
                        <option value="excel">Excel (.xlsx, .xls)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="json">JSON (.json)</option>
                    </select>
                </div>
                <div class="upload-zone" id="upload-zone">
                    <input type="file" id="import-file-input" accept=".xlsx,.xls,.csv,.json" style="display: none;">
                    <div class="text-center p-4">
                        <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
                        <p class="mb-0">Drag & drop your file here</p>
                        <p class="text-muted small mb-2">or</p>
                        <button class="btn btn-outline-primary" onclick="document.getElementById('import-file-input').click()">
                            Browse Files
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow h-100">
            <div class="card-header">
                <h6 class="m-0"><i class="bi bi-gear me-2"></i>3. Import Options</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Import Mode</label>
                    <select class="form-select" id="import-mode">
                        <option value="create">Create new records only</option>
                        <option value="update">Update existing records</option>
                        <option value="skip">Skip duplicates</option>
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="import-validate-first">
                    <label class="form-check-label" for="import-validate-first">
                        Validate data before importing
                    </label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="import-dry-run">
                    <label class="form-check-label" for="import-dry-run">
                        Dry run (test without importing)
                    </label>
                </div>
                <button class="btn btn-primary w-100" onclick="processImport()" id="start-import-btn" disabled>
                    <i class="bi bi-upload me-2"></i>Start Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Column Mapping (shows after file upload) -->
<div class="card shadow mb-4" id="column-mapping-card" style="display: none;">
    <div class="card-header">
        <h6 class="m-0"><i class="bi bi-diagram-3 me-2"></i>Map Columns</h6>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">Map your file columns to the required system fields</p>
        <div id="column-mapping-container" class="row">
            <!-- Column mappings will be generated here -->
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-secondary" onclick="goBackToUpload()">Back</button>
        <button class="btn btn-primary" onclick="proceedToPreview()">Continue to Preview</button>
    </div>
</div>

<!-- Preview (shows after column mapping) -->
<div class="card shadow mb-4" id="preview-card" style="display: none;">
    <div class="card-header">
        <h6 class="m-0"><i class="bi bi-eye me-2"></i>Preview Data</h6>
    </div>
    <div class="card-body">
        <div id="preview-results">
            <!-- Preview will be shown here -->
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-secondary" onclick="goBackToMapping()">Back</button>
        <button class="btn btn-success" onclick="confirmImport()">
            <i class="bi bi-check-lg me-2"></i>Confirm Import
        </button>
    </div>
</div>

<!-- Import Progress -->
<div class="card shadow mb-4" id="import-progress-card" style="display: none;">
    <div class="card-body">
        <h5 class="card-title">Importing Data...</h5>
        <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="import-progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <p id="import-progress-text" class="text-muted mb-0">Initializing...</p>
    </div>
</div>

<!-- Import Results -->
<div class="card shadow" id="import-results-card" style="display: none;">
    <div class="card-header">
        <h6 class="m-0">Import Results</h6>
    </div>
    <div class="card-body">
        <div id="import-results-content"></div>
    </div>
</div>

<script>
let uploadedFile = null;
let parsedData = [];
let columnMapping = {};

/**
 * Update import options based on entity type
 */
function updateImportOptions() {
    // Could update options based on entity type
    console.log('Entity type changed');
}

/**
 * Download template
 */
function downloadTemplate() {
    const entityType = document.getElementById('import-entity-type').value;
    if (!entityType) {
        showWarningToast('Please select an entity type first');
        return;
    }

    // Get template from API
    api.import.getTemplate(entityType).then(response => {
        if (response.success && response.data.template) {
            // Create and download file
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(response.data.template, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", response.data.filename);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    });
}

/**
 * Setup file upload handlers
 */
function setupFileUpload() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('import-file-input');

    if (!uploadZone || !fileInput) return;

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });
}

/**
 * Handle file upload
 */
async function handleFileUpload(file) {
    const entityType = document.getElementById('import-entity-type').value;

    if (!entityType) {
        showWarningToast('Please select an entity type first');
        return;
    }

    uploadedFile = file;

    // Show file info
    const uploadZone = document.getElementById('upload-zone');
    uploadZone.innerHTML = `
        <div class="text-center p-3">
            <i class="bi bi-file-earmark-check fs-1 text-success"></i>
            <p class="mb-0">${file.name}</p>
            <p class="text-muted small">${formatFileSize(file.size)}</p>
            <button class="btn btn-sm btn-outline-danger" onclick="resetFileUpload()">
                <i class="bi bi-x"></i> Remove
            </button>
        </div>
    `;

    // Parse file based on format
    const format = document.getElementById('import-file-format').value;

    try {
        if (format === 'json') {
            parsedData = await parseJSONFile(file);
        } else if (format === 'csv') {
            parsedData = await parseCSVFile(file);
        } else {
            parsedData = await parseExcelFile(file);
        }

        // Enable import button
        document.getElementById('start-import-btn').disabled = false;

        // Show column mapping
        showColumnMapping();

    } catch (error) {
        console.error('Error parsing file:', error);
        showErrorToast('Failed to parse file: ' + error.message);
        resetFileUpload();
    }
}

/**
 * Parse JSON file
 */
async function parseJSONFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                resolve(Array.isArray(data) ? data : [data]);
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

/**
 * Parse CSV file
 */
async function parseCSVFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const Papa = PapaParse;
                const result = Papa.parse(e.target.result, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                resolve(result.data);
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

/**
 * Parse Excel file
 */
async function parseExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                resolve(json);
            } catch (error) {
                reject(error);
            }
        };
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
    });
}

/**
 * Show column mapping interface
 */
function showColumnMapping() {
    const entityType = document.getElementById('import-entity-type').value;
    const requiredFields = getRequiredFieldsForEntity(entityType);
    const fileColumns = Object.keys(parsedData[0] || {});

    // Show mapping card
    document.getElementById('column-mapping-card').style.display = 'block';
    document.getElementById('upload-zone').parentElement.style.display = 'none';

    const container = document.getElementById('column-mapping-container');
    container.innerHTML = requiredFields.map(field => {
        return `
            <div class="col-md-6 mb-3">
                <label class="form-label">${field.field_name} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                <select class="form-select column-mapping-select" data-field="${field.field_name}">
                    <option value="">-- Select column --</option>
                    ${fileColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
                ${field.description ? `<small class="text-muted">${field.description}</small>` : ''}
            </div>
        `;
    }).join('');

    // Auto-map columns with matching names
    autoMapColumns();
}

/**
 * Get required fields for entity
 */
function getRequiredFieldsForEntity(entityType) {
    const fields = {
        'users': [
            { field_name: 'username', required: true, description: 'Login username' },
            { field_name: 'email', required: true, description: 'Email address' },
            { field_name: 'full_name', required: true, description: 'Full name' },
            { field_name: 'role_id', required: true, description: 'Role ID' },
            { field_name: 'active_from', required: false, description: 'Active start date' }
        ],
        'directorates': [
            { field_name: 'directorate_name', required: true, description: 'Directorate name' },
            { field_name: 'description', required: false, description: 'Description' }
        ],
        'kpis': [
            { field_name: 'kpi_name', required: true, description: 'KPI name' },
            { field_name: 'year', required: true, description: 'Year' },
            { field_name: 'target_value', required: true, description: 'Target value' },
            { field_name: 'perspective', required: true, description: 'Perspective (FINANCIAL, CUSTOMER, INTERNAL_PROCESS, LEARNING_GROWTH)' }
        ]
    };

    return fields[entityType] || [];
}

/**
 * Auto-map columns by name
 */
function autoMapColumns() {
    document.querySelectorAll('.column-mapping-select').forEach(select => {
        const fieldName = select.dataset.field;
        const options = Array.from(select.options);

        // Try to find exact match
        const exactMatch = options.find(opt => opt.value.toLowerCase() === fieldName.toLowerCase());
        if (exactMatch) {
            select.value = exactMatch.value;
        }
    });
}

/**
 * Proceed to preview
 */
function proceedToPreview() {
    // Collect mapping
    columnMapping = {};
    document.querySelectorAll('.column-mapping-select').forEach(select => {
        columnMapping[select.dataset.field] = select.value;
    });

    // Map data according to mapping
    const mappedData = parsedData.map(row => {
        const mapped = {};
        Object.keys(columnMapping).forEach(field => {
            mapped[field] = row[columnMapping[field]];
        });
        return mapped;
    });

    // Show preview
    document.getElementById('column-mapping-card').style.display = 'none';
    document.getElementById('preview-card').style.display = 'block';

    const previewContainer = document.getElementById('preview-results');
    previewContainer.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>${mappedData.length} records</strong> ready to import
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>#</th>
                        ${Object.keys(columnMapping).map(field => `<th>${field}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${mappedData.slice(0, 10).map((row, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            ${Object.keys(columnMapping).map(field => `<td>${row[field] || '-'}</td>`).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            ${mappedData.length > 10 ? `
                <p class="text-muted small text-center mt-2">... and ${mappedData.length - 10} more rows</p>
            ` : ''}
        </div>
    `;
}

/**
 * Go back to file upload
 */
function resetFileUpload() {
    uploadedFile = null;
    parsedData = [];
    columnMapping = {};

    const uploadZone = document.getElementById('upload-zone');
    uploadZone.innerHTML = `
        <div class="text-center p-4">
            <i class="bi bi-cloud-arrow-up fs-1 text-primary"></i>
            <p class="mb-0">Drag & drop your file here</p>
            <p class="text-muted small mb-2">or</p>
            <button class="btn btn-outline-primary" onclick="document.getElementById('import-file-input').click()">
                Browse Files
            </button>
        </div>
    `;

    document.getElementById('import-file-input').value = '';
    document.getElementById('start-import-btn').disabled = true;
}

/**
 * Process import
 */
async function processImport() {
    const entityType = document.getElementById('import-entity-type').value;
    const validateFirst = document.getElementById('import-validate-first').checked;
    const dryRun = document.getElementById('import-dry-run').checked;
    const mode = document.getElementById('import-mode').value;

    if (!entityType) {
        showWarningToast('Please select an entity type');
        return;
    }

    // Show progress
    document.getElementById('import-progress-card').style.display = 'block';
    document.getElementById('preview-card').style.display = 'none';

    try {
        // Call API to validate
        if (validateFirst) {
            updateProgress('Validating data...', 10);
            const validation = await api.import.validate(entityType, parsedData);

            if (!validation.success || validation.data.invalidRows.length > 0) {
                document.getElementById('import-progress-card').style.display = 'none';
                showValidationErrors(validation.data);
                return;
            }
        }

        // Process import
        updateProgress('Importing data...', 50);

        if (!dryRun) {
            const result = await api.import.process(entityType, parsedData, { mode });
            showImportResults(result.data);
        } else {
            showSuccessToast('Dry run completed - no data imported');
        }

    } catch (error) {
        console.error('Import error:', error);
        document.getElementById('import-progress-card').style.display = 'none';
        showErrorToast('Import failed: ' + error.message);
    }
}

/**
 * Show import results
 */
function showImportResults(summary) {
    document.getElementById('import-progress-card').style.display = 'none';
    document.getElementById('import-results-card').style.display = 'block';

    const resultsContainer = document.getElementById('import-results-content');

    resultsContainer.innerHTML = `
        <div class="alert ${summary.failed === 0 ? 'alert-success' : 'alert-warning'}">
            <h5 class="alert-heading">Import Complete!</h5>
            <p class="mb-0">
                <strong>Total:</strong> ${summary.total} |
                <strong class="text-success">Success:</strong> ${summary.success} |
                <strong class="text-danger">Failed:</strong> ${summary.failed}
            </p>
        </div>
        ${summary.details && summary.details.length > 0 ? `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <th>Status</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${summary.details.map(detail => `
                            <tr>
                                <td>${detail.row}</td>
                                <td>
                                    <span class="badge bg-${detail.status === 'success' ? 'success' : 'danger'}">${detail.status}</span>
                                </td>
                                <td>${detail.message}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        ` : ''}
        <button class="btn btn-primary mt-3" onclick="resetImport()">Import More Data</button>
    `;
}

/**
 * Helper functions
 */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function updateProgress(text, percentage) {
    const progressBar = document.getElementById('import-progress-bar');
    const progressText = document.getElementById('import-progress-text');

    if (progressBar) progressBar.style.width = percentage + '%';
    if (progressText) progressText.textContent = text;
}

// Setup on page load
document.addEventListener('DOMContentLoaded', () => {
    setupFileUpload();
});
</script>
