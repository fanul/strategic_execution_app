<!-- reports.html -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-file-earmark-bar-graph"></i> Reports & Analytics</h1>
</div>

<!-- Report Type Cards -->
<div class="row mb-4">
    <div class="col-lg-4 mb-3">
        <div class="card shadow h-100 border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">KPI Reports</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Summary & Analysis</div>
                    </div>
                    <i class="bi bi-graph-up fs-2 text-gray-300"></i>
                </div>
                <hr>
                <button class="btn btn-primary btn-sm w-100" onclick="generateKPIReport()">
                    <i class="bi bi-file-earmark-text"></i> Generate KPI Report
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card shadow h-100 border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">OKR Reports</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Performance Review</div>
                    </div>
                    <i class="bi bi-trophy fs-2 text-gray-300"></i>
                </div>
                <hr>
                <button class="btn btn-success btn-sm w-100" onclick="generateOKRReport()">
                    <i class="bi bi-file-earmark-text"></i> Generate OKR Report
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-4 mb-3">
        <div class="card shadow h-100 border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Performance Dashboard</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Overall Metrics</div>
                    </div>
                    <i class="bi bi-speedometer2 fs-2 text-gray-300"></i>
                </div>
                <hr>
                <button class="btn btn-info btn-sm w-100" onclick="viewDashboard()">
                    <i class="bi bi-eye"></i> View Dashboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Export and Recent Reports Tabs -->
<ul class="nav nav-pills mb-3" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button">
            <i class="bi bi-download"></i> Export Data
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent" type="button">
            <i class="bi bi-clock-history"></i> Recent Generated Reports
        </button>
    </li>
</ul>

<div class="tab-content pt-2" id="reportTabContent">
    <!-- Export Section -->
    <div class="tab-pane fade show active" id="export" role="tabpanel">
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h6 class="font-weight-bold mb-3">Include Data Modules</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportKPIs" checked>
                            <label class="form-check-label" for="exportKPIs">KPI Data (Organizational & Individual)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportOKRs" checked>
                            <label class="form-check-label" for="exportOKRs">Weekly OKR Data</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportPrograms">
                            <label class="form-check-label" for="exportPrograms">Programs & Activities</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="exportImpactCenters">
                            <label class="form-check-label" for="exportImpactCenters">Impact Centers Performance</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="font-weight-bold mb-3">Options & Period</h6>
                        <div class="mb-3">
                            <label class="form-label small">File Format</label>
                            <select class="form-select select2" id="exportFormat" style="width:100%">
                                <option value="csv">CSV (Excel compatible)</option>
                                <option value="sheets">Google Sheets</option>
                                <option value="pdf">PDF Official Report</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label small">Start Date</label>
                                <input type="date" class="form-control" id="exportStartDate">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label small">End Date</label>
                                <input type="date" class="form-control" id="exportEndDate">
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-end">
                    <button class="btn btn-primary" onclick="performExport()">
                        <i class="bi bi-download"></i> Prepare & Download Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports Section -->
    <div class="tab-pane fade" id="recent" role="tabpanel">
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="recentReportsTable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Report Name</th>
                                <th>Type</th>
                                <th>Generated</th>
                                <th>Generated By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentReportsBody">
                            <!-- Data Mockup or populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
        color: #0d6efd !important;
        background-color: #fff !important;
        border: 1px solid #0d6efd;
        font-weight: bold;
    }
    .select2-container { z-index: 9999; }
</style>

<script>
let reportTable;

document.addEventListener('DOMContentLoaded', function() {
    // Init DataTable
    reportTable = $('#recentReportsTable').DataTable({
        responsive: true,
        ordering: true,
        pageLength: 5,
        lengthMenu: [5, 10, 25],
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    
    // Init Select2 - Exclude DataTables length menus
    $('.select2:not(.dataTables_length select)').each(function() {
        $(this).select2({ 
            theme: 'bootstrap-5',
            dropdownParent: $(this).closest('.modal').length ? $(this).closest('.modal') : $('body'),
            width: '100%'
        });
    });
    
    // Adjust tables on tab shown
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
    });
    
    loadRecentReports();
});

function loadRecentReports() {
    // In a real app, this would fetch from a "Generated Reports" history table
    // For now, we show a placeholder or mock
    if (reportTable) reportTable.clear();
    
    // Add mock data
    reportTable.row.add([
        'Annual Performance Review 2025',
        '<span class="badge bg-primary">KPI</span>',
        '2026-01-15 10:30',
        'System Admin',
        '<button class="btn btn-sm btn-outline-info"><i class="bi bi-eye"></i></button>'
    ]);
    
    reportTable.draw();
}

function generateKPIReport() {
    showToast('Processing KPI data...', 'Reports');
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                showToast('KPI report generated!', 'Success');
                if (response.data && response.data.url) window.open(response.data.url, '_blank');
            }
        })
        .callAPI('reports/kpi-summary', {});
}

function generateOKRReport() {
    showToast('Processing OKR data...', 'Reports');
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                showToast('OKR report generated!', 'Success');
                if (response.data && response.data.url) window.open(response.data.url, '_blank');
            }
        })
        .callAPI('reports/okr-performance', {});
}

function viewDashboard() {
    if (typeof switchView === 'function') {
        switchView('dashboard');
    } else {
        alert('Dashboard view coming soon!');
    }
}

function performExport() {
    const data = {
        includeKPIs: document.getElementById('exportKPIs').checked,
        includeOKRs: document.getElementById('exportOKRs').checked,
        includePrograms: document.getElementById('exportPrograms').checked,
        includeImpactCenters: document.getElementById('exportImpactCenters').checked,
        format: document.getElementById('exportFormat').value,
        startDate: document.getElementById('exportStartDate').value,
        endDate: document.getElementById('exportEndDate').value
    };
    
    showToast('Preparing your download...', 'Export');
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data && response.data.url) {
                window.open(response.data.url, '_blank');
            }
        })
        .callAPI('reports/export', data);
}

function showToast(msg, title) {
    alert(title + ': ' + msg);
}
</script>
