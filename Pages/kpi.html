<!-- kpi.html -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-graph-up"></i> KPI Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-primary" onclick="createNewKPI()">
            <i class="bi bi-plus-circle"></i> New KPI
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="exportKPIs()">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-3" id="kpiTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="org-kpi-tab" data-bs-toggle="tab" data-bs-target="#org-kpi" type="button">
            <i class="bi bi-building"></i> Organizational KPIs
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="ind-kpi-tab" data-bs-toggle="tab" data-bs-target="#ind-kpi" type="button">
            <i class="bi bi-person"></i> Individual KPIs
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="progress-tab" data-bs-toggle="tab" data-bs-target="#progress" type="button">
            <i class="bi bi-clipboard-data"></i> Monthly Progress
        </button>
    </li>
</ul>

<div class="tab-content pt-3" id="kpiTabContent">
    <!-- Organizational KPIs Tab -->
    <div class="tab-pane fade show active" id="org-kpi" role="tabpanel">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Organizational KPIs</h6>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select class="form-select select2 w-100" id="yearFilter" onchange="filterOrgKPIs()">
                            <option value="">All Years</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select select2 w-100" id="perspectiveFilter" onchange="filterOrgKPIs()">
                            <option value="">All Perspectives</option>
                            <option value="FINANCIAL">Financial</option>
                            <option value="CUSTOMER">Customer</option>
                            <option value="INTERNAL_PROCESS">Internal Process</option>
                            <option value="LEARNING_GROWTH">Learning & Growth</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="orgKPITable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>KPI Name</th>
                                <th>Type</th>
                                <th>Perspective</th>
                                <th>Target</th>
                                <th>Unit</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orgKPIsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual KPIs Tab -->
    <div class="tab-pane fade" id="ind-kpi" role="tabpanel">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Individual KPIs</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="indKPITable" class="table table-bordered table-hover table-striped datatable" width="100%">
                        <thead class="table-light">
                            <tr>
                                <th>Code</th>
                                <th>KPI Name</th>
                                <th>Position</th>
                                <th>Target</th>
                                <th>Unit</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="indKPIsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Progress Tab -->
    <div class="tab-pane fade" id="progress" role="tabpanel">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Monthly Progress Tracking</h6>
                <button class="btn btn-sm btn-success" onclick="submitProgress()">
                    <i class="bi bi-check-circle"></i> Submit Progress
                </button>
            </div>
            <div class="card-body">
                <div id="progressContent">
                     <p class="text-muted text-center py-5">
                        <i class="bi bi-info-circle"></i> Please use the "Organizational KPIs" or "Individual KPIs" tab to view details and update progress.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: New KPI -->
<div class="modal fade" id="kpiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="kpiModalTitle">New KPI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kpiForm">
                    <input type="hidden" name="kpi_id" id="kpiId">
                    <input type="hidden" id="isIndividual" value="0">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">KPI Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="kpi_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="kpi_code" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select select2" name="kpi_type" style="width:100%">
                                <option value="STRATEGIC">Strategic</option>
                                <option value="OPERATIONAL">Operational</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Perspective</label>
                            <select class="form-select select2" name="perspective" style="width:100%">
                                <option value="FINANCIAL">Financial</option>
                                <option value="CUSTOMER">Customer</option>
                                <option value="INTERNAL_PROCESS">Internal Process</option>
                                <option value="LEARNING_GROWTH">Learning & Growth</option>
                            </select>
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Target</label>
                            <input type="number" class="form-control" name="target_value" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Unit</label>
                            <input type="text" class="form-control" name="unit_of_measurement" placeholder="%, IDR, etc">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Year</label>
                            <input type="number" class="form-control" name="year" value="2026">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKPI()">Save</button>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link.active, .nav-pills .show>.nav-link {
        color: #0d6efd !important;
        background-color: #fff !important;
        border: 1px solid #0d6efd;
        font-weight: bold;
    }
    .select2-container { z-index: 9999; }
</style>

<script>
let orgKPITable, indKPITable;
let allKPIs = [];

document.addEventListener('DOMContentLoaded', function() {
    // Init Tables
    orgKPITable = $('#orgKPITable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    indKPITable = $('#indKPITable').DataTable({ 
        responsive: true,
        columnDefs: [{ defaultContent: "", targets: "_all" }]
    });
    
    // Init Select2 - Exclude DataTables length menus
    $('.select2:not(.dataTables_length select)').each(function() {
        $(this).select2({ 
            theme: 'bootstrap-5',
            dropdownParent: $(this).closest('.modal').length ? $(this).closest('.modal') : $('body'),
            width: '100%'
        });
    });

    loadOrganizationalKPIs();
    loadIndividualKPIs();
    
    // Tab Listeners - DataTables responsive adjust
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
    });
});

function loadOrganizationalKPIs() {
    google.script.run.withSuccessHandler(renderOrgKPIs).callAPI('kpi/organizational/list', {});
}

function renderOrgKPIs(response) {
    if (!response || !response.success) return;
    const data = response.data || [];
    // Filter out individual KPIs if they share the same sheet or ensure we only show org ones
    allKPIs = data; 
    renderKPIList(allKPIs);
}

let allIndividualKPIs = [];
function loadIndividualKPIs() {
    google.script.run.withSuccessHandler(renderIndKPIs).callAPI('kpi/individual/list', {});
}

function renderIndKPIs(response) {
    if (indKPITable) indKPITable.clear();
    if (!response || !response.success) {
        if (indKPITable) indKPITable.draw();
        return;
    }
    
    const data = response.data || [];
    allIndividualKPIs = data;
    
    data.forEach(kpi => {
        indKPITable.row.add([
            kpi.kpi_code,
            kpi.kpi_name,
            kpi.position_id || '-',
            kpi.target_value || 0,
            kpi.unit_of_measurement || '',
            `0%`, // Placeholder for progress
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editIndividualKPI('${kpi.individual_kpi_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteIndividualKPI('${kpi.individual_kpi_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
    });
    indKPITable.draw();
}

function renderKPIList(data) {
    if (orgKPITable) orgKPITable.clear();
    
    data.forEach(kpi => {
        const progress = Math.floor(Math.random() * 100); // Mock progress
        const pClass = progress >= 75 ? 'success' : progress >= 50 ? 'warning' : 'danger';
        
        orgKPITable.row.add([
            kpi.kpi_code,
            kpi.kpi_name,
            `<span class="badge bg-info">${kpi.kpi_type || '-'}</span>`,
            kpi.perspective || '-',
            kpi.target_value || 0,
            kpi.unit_of_measurement || '',
            `<div class="progress" style="height: 20px;">
                <div class="progress-bar bg-${pClass}" role="progressbar" style="width: ${progress}%">${progress}%</div>
             </div>`,
            `<div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" onclick="editKPI('${kpi.kpi_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteKPI('${kpi.kpi_id}')"><i class="bi bi-trash"></i></button>
            </div>`
        ]);
    });
    orgKPITable.draw();
}

function filterOrgKPIs() {
    const year = $('#yearFilter').val();
    const perspective = $('#perspectiveFilter').val();
    
    const filtered = allKPIs.filter(k => {
        const matchYear = !year || String(k.year) === String(year);
        const matchPersp = !perspective || k.perspective === perspective;
        return matchYear && matchPersp;
    });
    
    renderKPIList(filtered);
}

function createNewKPI() {
    document.getElementById('kpiForm').reset();
    $('#kpiModal .select2').val(null).trigger('change'); 
    new bootstrap.Modal(document.getElementById('kpiModal')).show();
}

function saveKPI() {
    const form = document.getElementById('kpiForm');
    const data = Object.fromEntries(new FormData(form).entries());
    const id = data.kpi_id;
    const isInd = document.getElementById('isIndividual').value === '1';
    
    if (!data.kpi_name || !data.kpi_code) {
        alert("Please fill in required fields.");
        return;
    }
    
    let action, payload;
    if (isInd) {
        action = id ? 'kpi/individual/update' : 'kpi/individual/create';
        payload = id ? { individualKpiId: id, updates: data } : data;
    } else {
        action = id ? 'kpi/update' : 'kpi/create';
        payload = id ? { kpiId: id, updates: data } : data;
    }
    
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            bootstrap.Modal.getInstance(document.getElementById('kpiModal')).hide();
            showToast(id ? 'KPI updated' : 'KPI created');
            if (isInd) loadIndividualKPIs();
            else loadOrganizationalKPIs();
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI(action, payload);
}

function editKPI(id) {
    const kpi = allKPIs.find(k => String(k.kpi_id) === String(id));
    if(!kpi) return;
    
    const form = document.getElementById('kpiForm');
    form.reset();
    document.getElementById('isIndividual').value = '0';
    document.getElementById('kpiId').value = kpi.kpi_id;
    form.kpi_name.value = kpi.kpi_name || '';
    form.kpi_code.value = kpi.kpi_code || '';
    $(form.kpi_type).val(kpi.kpi_type).trigger('change');
    $(form.perspective).val(kpi.perspective).trigger('change');
    form.target_value.value = kpi.target_value || '';
    form.unit_of_measurement.value = kpi.unit_of_measurement || '';
    form.year.value = kpi.year || 2026;
    
    document.getElementById('kpiModalTitle').textContent = 'Edit Organizational KPI';
    new bootstrap.Modal(document.getElementById('kpiModal')).show();
}

function editIndividualKPI(id) {
    const kpi = allIndividualKPIs.find(k => String(k.individual_kpi_id) === String(id));
    if(!kpi) return;
    
    const form = document.getElementById('kpiForm');
    form.reset();
    document.getElementById('isIndividual').value = '1';
    document.getElementById('kpiId').value = kpi.individual_kpi_id;
    form.kpi_name.value = kpi.kpi_name || '';
    form.kpi_code.value = kpi.kpi_code || '';
    $(form.kpi_type).val(kpi.kpi_type).trigger('change');
    $(form.perspective).val(kpi.perspective).trigger('change');
    form.target_value.value = kpi.target_value || '';
    form.unit_of_measurement.value = kpi.unit_of_measurement || '';
    form.year.value = kpi.year || 2026;
    
    document.getElementById('kpiModalTitle').textContent = 'Edit Individual KPI';
    new bootstrap.Modal(document.getElementById('kpiModal')).show();
}

function deleteIndividualKPI(id) {
    if (!confirm('Are you sure you want to delete this Individual KPI?')) return;
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            showToast('Individual KPI deleted');
            loadIndividualKPIs();
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI('kpi/individual/delete', { individualKpiId: id });
}

function deleteKPI(id) {
    if (!confirm('Are you sure you want to delete this KPI?')) return;
    google.script.run.withSuccessHandler(res => {
        if (res.success) {
            showToast('KPI deleted');
            loadOrganizationalKPIs();
        } else {
            alert('Error: ' + res.message);
        }
    }).callAPI('kpi/delete', { kpiId: id });
}

function submitProgress() {
    alert("Monthly progress submission flow would go here.");
}
</script>
