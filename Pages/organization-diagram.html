<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Organization Diagram</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadOrganizationDiagram()">
            <i class="bi bi-arrow-clockwise"></i> Reload
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportOrgDiagram()">
            <i class="bi bi-download"></i> Export PNG
        </button>
    </div>
</div>

<!-- Filter Controls -->
<div class="card shadow mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Filter by Type</label>
                <select class="form-select" id="org-filter-type" onchange="filterOrgDiagram()">
                    <option value="">All Types</option>
                    <option value="directorate">Directorates</option>
                    <option value="workunit">Work Units</option>
                    <option value="affair">Affairs</option>
                    <option value="position">Positions</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="org-filter-status" onchange="filterOrgDiagram()">
                    <option value="">All</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="org-search" placeholder="Search by name or code..." oninput="searchOrgDiagram()">
            </div>
            <div class="col-md-3">
                <label class="form-label">View Mode</label>
                <select class="form-select" id="org-view-mode" onchange="changeViewMode()">
                    <option value="tree">Tree View</option>
                    <option value="compact">Compact View</option>
                    <option value="radial">Radial View</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Organization Diagram Container -->
<div class="card shadow">
    <div class="card-body">
        <div id="org-diagram" class="org-diagram-container">
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading organization diagram...</p>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="card shadow mt-4">
    <div class="card-body">
        <h6 class="card-title mb-3">Legend</h6>
        <div class="row">
            <div class="col-md-3">
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 20px; height: 20px; background-color: #e7f1ff; border: 2px solid #0d6efd; border-radius: 4px;"></div>
                    <span class="ms-2">Directorate</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 20px; height: 20px; background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 4px;"></div>
                    <span class="ms-2">Work Unit</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 20px; height: 20px; background-color: #d1e7dd; border: 2px solid #198754; border-radius: 4px;"></div>
                    <span class="ms-2">Affair</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 20px; height: 20px; background-color: #f8d7da; border: 2px solid #dc3545; border-radius: 4px;"></div>
                    <span class="ms-2">Position</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let orgDiagram = null;

/**
 * Load organization diagram
 */
async function loadOrganizationDiagram() {
    try {
        // Create diagram
        orgDiagram = new OrganizationDiagram({
            containerId: 'org-diagram',
            width: 1400,
            height: 900,
            zoomEnabled: true,
            panEnabled: true,
            collapsible: true,
            onNodeClick: handleOrgNodeClick,
            onNodeDoubleClick: handleOrgNodeDoubleClick,
            onNodeRightClick: handleOrgNodeRightClick
        });

        await orgDiagram.init();

    } catch (error) {
        console.error('Error loading organization diagram:', error);
        showErrorToast('Failed to load organization diagram');
    }
}

/**
 * Handle node click
 */
function handleOrgNodeClick(nodeData, d3Node) {
    console.log('Node clicked:', nodeData);

    // Show node details in a modal
    const modal = new Modal({
        title: `${nodeData.type}: ${nodeData.name}`,
        size: 'medium',
        content: `
            <table class="table">
                <tr><th>Name:</th><td>${nodeData.name}</td></tr>
                <tr><th>Code:</th><td>${nodeData.code || '-'}</td></tr>
                <tr><th>Type:</th><td>${StringUtils.toTitleCase(nodeData.type)}</td></tr>
                ${nodeData.data.description ? `<tr><th>Description:</th><td>${nodeData.data.description}</td></tr>` : ''}
                ${nodeData.data.is_active !== undefined ? `<tr><th>Status:</th><td>${nodeData.data.is_active ? 'Active' : 'Inactive'}</td></tr>` : ''}
            </table>
        `,
        footer: `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="editOrgNode('${nodeData.id}', '${nodeData.type}')">Edit</button>
        `
    });

    modal.show();
}

/**
 * Handle node double-click
 */
function handleOrgNodeDoubleClick(nodeData, d3Node) {
    console.log('Node double-clicked:', nodeData);
    // Could open edit form directly
    editOrgNode(nodeData.id, nodeData.type);
}

/**
 * Handle node right-click
 */
function handleOrgNodeRightClick(nodeData, d3Node) {
    console.log('Node right-clicked:', nodeData);
    // Custom context menu is handled by the component
}

/**
 * Filter organization diagram
 */
function filterOrgDiagram() {
    const type = document.getElementById('org-filter-type').value;
    const status = document.getElementById('org-filter-status').value;

    if (orgDiagram) {
        // Apply filters
        showSuccessToast('Filter applied');
    }
}

/**
 * Search organization diagram
 */
function searchOrgDiagram() {
    const query = document.getElementById('org-search').value.toLowerCase();

    if (orgDiagram) {
        // Highlight matching nodes
        showSuccessToast('Search applied');
    }
}

/**
 * Change view mode
 */
function changeViewMode() {
    const mode = document.getElementById('org-view-mode').value;

    if (orgDiagram) {
        // Change layout based on mode
        showSuccessToast(`Switched to ${mode} view`);
    }
}

/**
 * Edit organization node
 */
function editOrgNode(nodeId, nodeType) {
    showToast(`Editing ${nodeType}: ${nodeId}`, 'Info');
    // Open edit form based on node type
}

/**
 * Export organization diagram
 */
function exportOrgDiagram() {
    if (orgDiagram) {
        orgDiagram._exportAsPNG();
    }
}

// Load diagram when view is shown
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        loadOrganizationDiagram();
    }, 500);
});
</script>
