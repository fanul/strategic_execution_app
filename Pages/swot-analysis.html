<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWOT Analysis - Strategic Execution Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="?path=/assets/css/custom.css" rel="stylesheet">
    <style>
        .swot-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: 600px;
        }

        .swot-quadrant {
            border: 3px solid;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .swot-quadrant.strengths {
            border-color: #198754;
            background: linear-gradient(135deg, #d1e7dd 0%, #ffffff 100%);
        }

        .swot-quadrant.weaknesses {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        }

        .swot-quadrant.opportunities {
            border-color: #0d6efd;
            background: linear-gradient(135deg, #cfe2ff 0%, #ffffff 100%);
        }

        .swot-quadrant.threats {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .swot-quadrant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .swot-quadrant-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .swot-quadrant-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .swot-item {
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .swot-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .swot-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .swot-item-title {
            font-weight: 600;
            flex: 1;
        }

        .swot-item-actions {
            display: flex;
            gap: 5px;
        }

        .swot-item-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .swot-item-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }

        .swot-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .badge-impact-high { background: #dc3545; color: white; }
        .badge-impact-medium { background: #ffc107; color: black; }
        .badge-impact-low { background: #198754; color: white; }

        .impact-priority-chart {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .strategy-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }

        .strategy-so { border-left-color: #198754; }
        .strategy-wo { border-left-color: #0d6efd; }
        .strategy-st { border-left-color: #ffc107; }
        .strategy-wt { border-left-color: #dc3545; }

        .strategy-type {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div id="swot-analysis-page">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1"><i class="bi bi-diagram-3 me-2"></i>SWOT Analysis</h2>
                            <p class="text-muted mb-0">Analyze Strengths, Weaknesses, Opportunities, and Threats for strategic goals</p>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary me-2" onclick="swotView.exportMatrix()">
                                <i class="bi bi-download me-1"></i>Export Matrix
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSWOTModal">
                                <i class="bi bi-plus-lg me-1"></i>Add SWOT Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goal Selector -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <label class="form-label">Select Goal for SWOT Analysis:</label>
                                    <select class="form-select" id="goal-selector" onchange="swotView.loadSWOTForGoal(this.value)">
                                        <option value="">-- Select a Goal --</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">View Mode:</label>
                                    <select class="form-select" id="view-mode" onchange="swotView.changeViewMode(this.value)">
                                        <option value="matrix">Matrix View</option>
                                        <option value="list">List View</option>
                                        <option value="strategies">Strategy View</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Filter by Impact:</label>
                                    <select class="form-select" id="impact-filter" onchange="swotView.filterByImpact(this.value)">
                                        <option value="all">All Impact Levels</option>
                                        <option value="HIGH">High Impact</option>
                                        <option value="MEDIUM">Medium Impact</option>
                                        <option value="LOW">Low Impact</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matrix View -->
            <div id="matrix-view" class="swot-view">
                <div class="swot-matrix">
                    <!-- Strengths -->
                    <div class="swot-quadrant strengths">
                        <div class="swot-quadrant-header">
                            <div>
                                <div class="swot-quadrant-title text-success">
                                    <i class="bi bi-plus-circle-fill me-2"></i>Strengths
                                </div>
                                <div class="swot-quadrant-subtitle">Internal Positive Factors</div>
                            </div>
                            <span class="badge bg-success" id="strengths-count">0</span>
                        </div>
                        <div id="strengths-list"></div>
                    </div>

                    <!-- Weaknesses -->
                    <div class="swot-quadrant weaknesses">
                        <div class="swot-quadrant-header">
                            <div>
                                <div class="swot-quadrant-title text-danger">
                                    <i class="bi bi-dash-circle-fill me-2"></i>Weaknesses
                                </div>
                                <div class="swot-quadrant-subtitle">Internal Negative Factors</div>
                            </div>
                            <span class="badge bg-danger" id="weaknesses-count">0</span>
                        </div>
                        <div id="weaknesses-list"></div>
                    </div>

                    <!-- Opportunities -->
                    <div class="swot-quadrant opportunities">
                        <div class="swot-quadrant-header">
                            <div>
                                <div class="swot-quadrant-title text-primary">
                                    <i class="bi bi-lightbulb-fill me-2"></i>Opportunities
                                </div>
                                <div class="swot-quadrant-subtitle">External Positive Factors</div>
                            </div>
                            <span class="badge bg-primary" id="opportunities-count">0</span>
                        </div>
                        <div id="opportunities-list"></div>
                    </div>

                    <!-- Threats -->
                    <div class="swot-quadrant threats">
                        <div class="swot-quadrant-header">
                            <div>
                                <div class="swot-quadrant-title text-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Threats
                                </div>
                                <div class="swot-quadrant-subtitle">External Negative Factors</div>
                            </div>
                            <span class="badge bg-warning text-dark" id="threats-count">0</span>
                        </div>
                        <div id="threats-list"></div>
                    </div>
                </div>
            </div>

            <!-- List View -->
            <div id="list-view" class="swot-view" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>All SWOT Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Factor</th>
                                        <th>Description</th>
                                        <th>Impact</th>
                                        <th>Priority</th>
                                        <th>Linked Goal</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="swot-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy View -->
            <div id="strategy-view" class="swot-view" style="display: none;">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Generated Strategies (TOWS Analysis)</h5>
                            </div>
                            <div class="card-body" id="strategies-container">
                                <p class="text-muted">Select a goal to generate strategies based on SWOT analysis.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Impact vs Priority</h5>
                            </div>
                            <div class="card-body">
                                <div class="impact-priority-chart">
                                    <canvas id="impact-priority-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Impact/Priority Chart -->
            <div id="impact-priority-section" class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Impact vs Priority Analysis</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="swot-scatter-chart" height="100"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit SWOT Modal -->
    <div class="modal fade" id="addSWOTModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="swotModalTitle">Add SWOT Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="swot-form">
                        <input type="hidden" id="swot-analysis-id">

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Goal *</label>
                                <select class="form-select" id="swot-goal-id" required>
                                    <option value="">-- Select Goal --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="swot-category" required>
                                    <option value="">-- Select Category --</option>
                                    <option value="S">Strength</option>
                                    <option value="W">Weakness</option>
                                    <option value="O">Opportunity</option>
                                    <option value="T">Threat</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Factor Title *</label>
                            <input type="text" class="form-control" id="swot-factor" required
                                   placeholder="e.g., Strong brand recognition">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="swot-description" rows="3"
                                      placeholder="Describe this factor in detail..."></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Impact Level *</label>
                                <select class="form-select" id="swot-impact" required>
                                    <option value="">-- Select Impact --</option>
                                    <option value="HIGH">High Impact</option>
                                    <option value="MEDIUM">Medium Impact</option>
                                    <option value="LOW">Low Impact</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Priority *</label>
                                <select class="form-select" id="swot-priority" required>
                                    <option value="">-- Select Priority --</option>
                                    <option value="HIGH">High Priority</option>
                                    <option value="MEDIUM">Medium Priority</option>
                                    <option value="LOW">Low Priority</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="swotView.saveSWOT()">
                        <i class="bi bi-check-lg me-1"></i>Save SWOT Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this SWOT item?</p>
                    <p class="text-muted mb-0">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="swotView.confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="?path=/assets/js/utils.js"></script>
    <script src="?path=/assets/js/api.js"></script>
    <script src="?path=/assets/js/components.js"></script>

    <script>
        class SWOTView {
            constructor() {
                this.currentGoalId = null;
                this.currentSWOTItems = [];
                this.currentAnalysisId = null;
                this.currentMatrix = null;
                this.scatterChart = null;
            }

            async init() {
                await this.loadGoals();
                this._setupEventListeners();
            }

            async loadGoals() {
                try {
                    const response = await api.call('strategic/goals/list', { year: new Date().getFullYear() });

                    if (response.success && response.data) {
                        const goals = Array.isArray(response.data) ? response.data : (response.data.goals || []);
                        const selector = document.getElementById('goal-selector');
                        const modalSelector = document.getElementById('swot-goal-id');

                        const options = goals.map(goal =>
                            `<option value="${goal.goal_id}">${goal.goal_name}</option>`
                        ).join('');

                        selector.innerHTML = '<option value="">-- Select a Goal --</option>' + options;
                        modalSelector.innerHTML = '<option value="">-- Select Goal --</option>' + options;
                    }
                } catch (error) {
                    console.error('Error loading goals:', error);
                    showErrorMessage('Failed to load goals');
                }
            }

            async loadSWOTForGoal(goalId) {
                if (!goalId) {
                    this._clearAllQuadrants();
                    return;
                }

                this.currentGoalId = goalId;
                showLoadingOverlay();

                try {
                    const response = await api.call('swot/list', { goal_id: goalId });

                    if (response.success) {
                        this.currentSWOTItems = response.data || [];
                        this._displayMatrix(this.currentSWOTItems);
                        this._displayList(this.currentSWOTItems);
                        await this._loadStrategies();
                        this._updateScatterChart(this.currentSWOTItems);
                    }
                } catch (error) {
                    console.error('Error loading SWOT:', error);
                    showErrorMessage('Failed to load SWOT analysis');
                } finally {
                    hideLoadingOverlay();
                }
            }

            _displayMatrix(items) {
                const quadrants = {
                    S: document.getElementById('strengths-list'),
                    W: document.getElementById('weaknesses-list'),
                    O: document.getElementById('opportunities-list'),
                    T: document.getElementById('threats-list')
                };

                const counts = { S: 0, W: 0, O: 0, T: 0 };

                Object.values(quadrants).forEach(el => el.innerHTML = '');

                items.forEach(item => {
                    const category = item.category;
                    counts[category]++;

                    const badgeClass = {
                        HIGH: 'badge-impact-high',
                        MEDIUM: 'badge-impact-medium',
                        LOW: 'badge-impact-low'
                    }[item.impact_level];

                    const html = `
                        <div class="swot-item" data-id="${item.analysis_id}">
                            <div class="swot-item-header">
                                <div class="swot-item-title">${item.factor}</div>
                                <div class="swot-item-actions">
                                    <button class="btn btn-sm btn-link" onclick="swotView.editSWOT('${item.analysis_id}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-danger" onclick="swotView.deleteSWOT('${item.analysis_id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            ${item.description ? `<div class="swot-item-description">${item.description}</div>` : ''}
                            <div class="swot-item-meta">
                                <span class="swot-badge ${badgeClass}">${item.impact_level}</span>
                                <span>${item.priority_level}</span>
                            </div>
                        </div>
                    `;

                    if (quadrants[category]) {
                        quadrants[category].innerHTML += html;
                    }
                });

                document.getElementById('strengths-count').textContent = counts.S;
                document.getElementById('weaknesses-count').textContent = counts.W;
                document.getElementById('opportunities-count').textContent = counts.O;
                document.getElementById('threats-count').textContent = counts.T;
            }

            _displayList(items) {
                const tbody = document.getElementById('swot-list-body');
                tbody.innerHTML = '';

                const categoryNames = {
                    S: '<span class="badge bg-success">Strength</span>',
                    W: '<span class="badge bg-danger">Weakness</span>',
                    O: '<span class="badge bg-primary">Opportunity</span>',
                    T: '<span class="badge bg-warning text-dark">Threat</span>'
                };

                items.forEach(item => {
                    const row = `
                        <tr>
                            <td>${categoryNames[item.category] || item.category}</td>
                            <td><strong>${item.factor}</strong></td>
                            <td>${item.description || '-'}</td>
                            <td>${item.impact_level}</td>
                            <td>${item.priority_level}</td>
                            <td>${item.goal_name || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="swotView.editSWOT('${item.analysis_id}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="swotView.deleteSWOT('${item.analysis_id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            async _loadStrategies() {
                if (!this.currentGoalId) return;

                try {
                    const response = await api.call('swot/matrix', { goal_id: this.currentGoalId });

                    if (response.success && response.data) {
                        this.currentMatrix = response.data;
                        this._displayStrategies(response.data.strategies || {});
                    }
                } catch (error) {
                    console.error('Error loading strategies:', error);
                }
            }

            _displayStrategies(strategies) {
                const container = document.getElementById('strategies-container');

                if (Object.keys(strategies).length === 0) {
                    container.innerHTML = '<p class="text-muted">Add SWOT items to generate strategies.</p>';
                    return;
                }

                const strategyTypes = {
                    SO: { title: 'SO Strategies', desc: 'Use Strengths to take advantage of Opportunities', class: 'strategy-so' },
                    WO: { title: 'WO Strategies', desc: 'Overcome Weaknesses to pursue Opportunities', class: 'strategy-wo' },
                    ST: { title: 'ST Strategies', desc: 'Use Strengths to mitigate Threats', class: 'strategy-st' },
                    WT: { title: 'WT Strategies', desc: 'Minimize Weaknesses and avoid Threats', class: 'strategy-wt' }
                };

                let html = '';
                for (const [type, config] of Object.entries(strategyTypes)) {
                    if (strategies[type] && strategies[type].length > 0) {
                        html += `
                            <h6 class="mt-3">${config.title}</h6>
                            <p class="text-muted small">${config.desc}</p>
                        `;
                        strategies[type].forEach(strategy => {
                            html += `
                                <div class="strategy-card ${config.class}">
                                    <div class="strategy-type">${type}</div>
                                    <div>${strategy}</div>
                                </div>
                            `;
                        });
                    }
                }

                container.innerHTML = html || '<p class="text-muted">Add SWOT items to generate strategies.</p>';
            }

            _updateScatterChart(items) {
                const ctx = document.getElementById('swot-scatter-chart');
                if (!ctx) return;

                if (this.scatterChart) {
                    this.scatterChart.destroy();
                }

                const impactValues = { HIGH: 3, MEDIUM: 2, LOW: 1 };
                const priorityValues = { HIGH: 3, MEDIUM: 2, LOW: 1 };

                const datasets = {
                    S: { label: 'Strengths', data: [], backgroundColor: 'rgba(25, 135, 84, 0.7)' },
                    W: { label: 'Weaknesses', data: [], backgroundColor: 'rgba(220, 53, 69, 0.7)' },
                    O: { label: 'Opportunities', data: [], backgroundColor: 'rgba(13, 110, 253, 0.7)' },
                    T: { label: 'Threats', data: [], backgroundColor: 'rgba(255, 193, 7, 0.7)' }
                };

                items.forEach(item => {
                    const x = impactValues[item.impact_level] || 2;
                    const y = priorityValues[item.priority_level] || 2;
                    datasets[item.category]?.data.push({
                        x: x,
                        y: y,
                        label: item.factor
                    });
                });

                this.scatterChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: Object.values(datasets).filter(d => d.data.length > 0)
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: { display: true, text: 'Impact Level' },
                                min: 0,
                                max: 4,
                                ticks: {
                                    callback: (value) => ['', 'Low', 'Medium', 'High'][value] || ''
                                }
                            },
                            y: {
                                title: { display: true, text: 'Priority Level' },
                                min: 0,
                                max: 4,
                                ticks: {
                                    callback: (value) => ['', 'Low', 'Medium', 'High'][value] || ''
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => context.raw.label || ''
                                }
                            }
                        }
                    }
                });
            }

            changeViewMode(mode) {
                document.querySelectorAll('.swot-view').forEach(el => el.style.display = 'none');
                document.getElementById(`${mode}-view`).style.display = 'block';
            }

            filterByImpact(impact) {
                const filtered = impact === 'all'
                    ? this.currentSWOTItems
                    : this.currentSWOTItems.filter(item => item.impact_level === impact);

                this._displayMatrix(filtered);
                this._displayList(filtered);
            }

            async saveSWOT() {
                const form = document.getElementById('swot-form');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const data = {
                    goal_id: document.getElementById('swot-goal-id').value,
                    category: document.getElementById('swot-category').value,
                    factor: document.getElementById('swot-factor').value,
                    description: document.getElementById('swot-description').value,
                    impact_level: document.getElementById('swot-impact').value,
                    priority_level: document.getElementById('swot-priority').value
                };

                const analysisId = document.getElementById('swot-analysis-id').value;
                const endpoint = analysisId ? 'swot/update' : 'swot/create';
                if (analysisId) data.analysis_id = analysisId;

                showLoadingOverlay();

                try {
                    const response = await api.call(endpoint, data);

                    if (response.success) {
                        showSuccessMessage('SWOT item saved successfully');
                        bootstrap.Modal.getInstance(document.getElementById('addSWOTModal')).hide();
                        form.reset();
                        document.getElementById('swot-analysis-id').value = '';

                        if (this.currentGoalId) {
                            await this.loadSWOTForGoal(this.currentGoalId);
                        }
                    } else {
                        showErrorMessage(response.message || 'Failed to save SWOT item');
                    }
                } catch (error) {
                    console.error('Error saving SWOT:', error);
                    showErrorMessage('Failed to save SWOT item');
                } finally {
                    hideLoadingOverlay();
                }
            }

            editSWOT(analysisId) {
                const item = this.currentSWOTItems.find(i => i.analysis_id === analysisId);
                if (!item) return;

                document.getElementById('swot-analysis-id').value = item.analysis_id;
                document.getElementById('swot-goal-id').value = item.goal_id;
                document.getElementById('swot-category').value = item.category;
                document.getElementById('swot-factor').value = item.factor;
                document.getElementById('swot-description').value = item.description || '';
                document.getElementById('swot-impact').value = item.impact_level;
                document.getElementById('swot-priority').value = item.priority_level;

                document.getElementById('swotModalTitle').textContent = 'Edit SWOT Item';
                new bootstrap.Modal(document.getElementById('addSWOTModal')).show();
            }

            deleteSWOT(analysisId) {
                this.currentAnalysisId = analysisId;
                new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
            }

            async confirmDelete() {
                showLoadingOverlay();

                try {
                    const response = await api.call('swot/delete', {
                        analysis_id: this.currentAnalysisId
                    });

                    if (response.success) {
                        showSuccessMessage('SWOT item deleted successfully');
                        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();

                        if (this.currentGoalId) {
                            await this.loadSWOTForGoal(this.currentGoalId);
                        }
                    } else {
                        showErrorMessage(response.message || 'Failed to delete SWOT item');
                    }
                } catch (error) {
                    console.error('Error deleting SWOT:', error);
                    showErrorMessage('Failed to delete SWOT item');
                } finally {
                    hideLoadingOverlay();
                }
            }

            exportMatrix() {
                if (!this.currentMatrix) {
                    showErrorMessage('No data to export');
                    return;
                }

                const csv = this._generateCSV(this.currentMatrix);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `swot-matrix-${this.currentGoalId}.csv`;
                a.click();
            }

            _generateCSV(matrix) {
                let csv = 'Category,Factor,Description,Impact,Priority\n';

                (matrix.items || []).forEach(item => {
                    csv += `"${item.category}","${item.factor}","${item.description || ''}","${item.impact_level}","${item.priority_level}"\n`;
                });

                return csv;
            }

            _clearAllQuadrants() {
                ['strengths-list', 'weaknesses-list', 'opportunities-list', 'threats-list'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                document.getElementById('strengths-count').textContent = '0';
                document.getElementById('weaknesses-count').textContent = '0';
                document.getElementById('opportunities-count').textContent = '0';
                document.getElementById('threats-count').textContent = '0';
            }

            _setupEventListeners() {
                document.getElementById('addSWOTModal').addEventListener('show.bs.modal', () => {
                    document.getElementById('swotModalTitle').textContent = 'Add SWOT Item';
                    document.getElementById('swot-form').reset();
                    document.getElementById('swot-analysis-id').value = '';
                });
            }
        }

        const swotView = new SWOTView();

        document.addEventListener('DOMContentLoaded', async () => {
            await swotView.init();
        });
    </script>
</body>
</html>
