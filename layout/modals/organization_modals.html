<!-- Directorate Modal -->
<div class="modal fade" id="directorateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="directorateModalTitle">Add Directorate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="directorateModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="directorateForm">
                    <input type="hidden" id="directorate_id">
                    <div class="mb-3">
                        <label class="form-label">Code *</label>
                        <input type="text" class="form-control" id="directorate_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="directorate_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDirectorate()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Work Unit Modal -->
<div class="modal fade" id="work-unitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Work Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="work-unitModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="work-unitForm">
                    <input type="hidden" id="work_unit_id">
                    <div class="mb-3">
                        <label class="form-label">Code *</label>
                        <input type="text" class="form-control" id="work_unit_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="work_unit_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Directorate *</label>
                        <select class="form-select" id="directorate_id_select" required>
                            <option value="">Select Directorate</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWorkUnit()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Affair Modal -->
<div class="modal fade" id="affairModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Affair</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="affairModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="affairForm">
                    <input type="hidden" id="affair_id">
                    <div class="mb-3">
                        <label class="form-label">Code *</label>
                        <input type="text" class="form-control" id="affair_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="affair_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Unit *</label>
                        <select class="form-select" id="work_unit_id_select" required>
                            <option value="">Select Work Unit</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAffair()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Position Modal -->
<div class="modal fade" id="positionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Position</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="positionModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="positionForm">
                    <input type="hidden" id="position_id">
                    <div class="mb-3">
                        <label class="form-label">Code *</label>
                        <input type="text" class="form-control" id="position_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="position_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <input type="text" class="form-control" id="position_level">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Work Unit *</label>
                        <select class="form-select" id="position_work_unit_id_select" required>
                            <option value="">Select Work Unit</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assigned User</label>
                        <select class="form-select" id="position_user_id_select">
                            <option value="">Unassigned</option>
                        </select>
                        <small class="text-muted">Assign a user to this position</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePosition()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Organizational Unit Modal -->
<div class="modal fade" id="org-unitModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="org-unitModalTitle">Add Organizational Unit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="org-unitModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="org-unitForm">
                    <input type="hidden" id="unit_id">

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit Type *</label>
                                <select class="form-select" id="unit_type" required onchange="handleUnitTypeChange()">
                                    <option value="">Select Unit Type</option>
                                    <option value="ROOT">ROOT (BPJS Ketenagakerjaan)</option>
                                    <option value="DIRECTORATE">Directorate (HQ)</option>
                                    <option value="WORK_UNIT">Work Unit/Deputi (HQ)</option>
                                    <option value="AFFAIR">Affair/Urusan (HQ)</option>
                                    <option value="REGIONAL_OFFICE">Regional Office</option>
                                    <option value="BRANCH_OFFICE">Branch Office</option>
                                    <option value="SUBSIDIARY">Subsidiary</option>
                                    <option value="SUBSIDIARY_UNIT">Subsidiary Unit</option>
                                </select>
                                <small class="text-muted">Select the type of organizational unit</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Parent Unit</label>
                                <select class="form-select" id="parent_unit_id">
                                    <option value="">No Parent (Root Level)</option>
                                </select>
                                <small class="text-muted">Select parent unit (optional for ROOT)</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Unit Code *</label>
                                <input type="text" class="form-control" id="unit_code" required>
                                <small class="text-muted">Unique code for this unit</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Unit Name *</label>
                                <input type="text" class="form-control" id="unit_name" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Classification</label>
                                <select class="form-select" id="classification">
                                    <option value="">Select Classification</option>
                                    <option value="HQ">HQ (Headquarters)</option>
                                    <option value="KELAS_1">Kelas 1 (Class 1 Branch)</option>
                                    <option value="KELAS_2">Kelas 2 (Class 2 Branch)</option>
                                    <option value="KELAS_3">Kelas 3 (Class 3 Branch)</option>
                                    <option value="KELAS_3A">Kelas 3A (Class 3A Branch)</option>
                                    <option value="SUBSIDIARY">Subsidiary</option>
                                </select>
                                <small class="text-muted">Classification for branch offices</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Unit Level</label>
                                <input type="number" class="form-control" id="unit_level" min="0" value="0">
                                <small class="text-muted">Hierarchical level (0 for root)</small>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Geographical Scope</label>
                                <select class="form-select" id="geographical_scope">
                                    <option value="">Select Scope</option>
                                    <option value="NATIONAL">National</option>
                                    <option value="REGIONAL">Regional</option>
                                    <option value="CITY">City</option>
                                    <option value="DISTRICT">District</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Province</label>
                                <input type="text" class="form-control" id="province">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">City</label>
                                <input type="text" class="form-control" id="city">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Address</label>
                                <textarea class="form-control" id="address" rows="2"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Head Position</label>
                                <select class="form-select" id="head_position_id">
                                    <option value="">Select Position</option>
                                </select>
                                <small class="text-muted">Assign head of this unit</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_active" checked>
                                    <label class="form-check-label" for="is_active">
                                        Active
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOrgUnit()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="deleteConfirmTitle">Confirm Delete</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Warning: Item has children -->
                <div id="deleteHasChildrenWarning" class="alert alert-warning" style="display:none;">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Warning:</strong> This item has <strong id="childrenCount">0</strong> child item(s) that will also be affected.
                </div>

                <!-- Children details -->
                <div id="deleteChildrenDetails" style="display:none; margin-bottom: 15px;">
                    <ul class="list-unstyled" id="childrenList">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>

                <!-- Delete options -->
                <div id="deleteOptionsSection" style="display:none;">
                    <h6 class="mb-3">Choose how to handle child items:</h6>

                    <!-- Cascade delete option -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOptionCascade" value="cascade" checked>
                        <label class="form-check-label" for="deleteOptionCascade">
                            <strong>Delete all children</strong>
                            <small class="d-block text-muted">Delete this item and all child items. This cannot be undone.</small>
                        </label>
                    </div>

                    <!-- Reassign option -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteOptionReassign" value="reassign">
                        <label class="form-check-label" for="deleteOptionReassign">
                            <strong>Reassign children</strong>
                            <small class="d-block text-muted">Move child items to another parent before deleting.</small>
                        </label>
                    </div>

                    <!-- Reassign dropdown (shown when reassign is selected) -->
                    <div id="reassignSection" style="display:none; margin-left: 1.5em; margin-bottom: 15px;">
                        <label class="form-label">Select new parent:</label>
                        <select class="form-select" id="reassignTarget">
                            <option value="">-- Select new parent --</option>
                        </select>
                    </div>
                </div>

                <!-- Direct delete message (no children) -->
                <div id="deleteDirectMessage" style="display:none;">
                    <p>Are you sure you want to delete <strong id="deleteItemName">this item</strong>?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="executeDelete()">
                    <i class="bi bi-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
