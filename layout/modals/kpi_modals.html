<!-- KPI Modal -->
<div class="modal fade" id="kpiModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="kpiModalTitle">Add KPI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <!-- Modal Loading Overlay -->
                <div id="kpiModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="kpiForm">
                    <input type="hidden" id="kpi_id">
                    <input type="hidden" id="work_unit_goal_id">

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">KPI Code *</label>
                            <input type="text" class="form-control" id="kpi_code" readonly
                                   placeholder="Auto-generated">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-control" id="kpi_year" required
                                   min="2020" max="2100" value="2026">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">KPI Name *</label>
                        <input type="text" class="form-control" id="kpi_name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Glossary (Definition)</label>
                        <textarea class="form-control" id="kpi_glossary" rows="2"
                                  placeholder="Define what this KPI measures..."></textarea>
                    </div>

                    <!-- Organization Assignment -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Directorate *</label>
                            <select class="form-select" id="kpi_directorate_id" required>
                                <option value="">Select Directorate</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Work Unit *</label>
                            <select class="form-select" id="kpi_work_unit_id" required>
                                <option value="">Select Work Unit</option>
                            </select>
                        </div>
                    </div>

                    <!-- KPI Classification -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">KPI Type *</label>
                            <select class="form-select" id="kpi_type" required>
                                <option value="">Select Type</option>
                                <option value="OUTCOME">Outcome</option>
                                <option value="OUTPUT">Output</option>
                                <option value="INPUT">Input</option>
                                <option value="PROCESS">Process</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Perspective *</label>
                            <select class="form-select" id="kpi_perspective" required>
                                <option value="">Select Perspective</option>
                                <option value="FINANCIAL">Financial</option>
                                <option value="CUSTOMER">Customer</option>
                                <option value="INTERNAL_PROCESS">Internal Process</option>
                                <option value="LEARNING_GROWTH">Learning & Growth</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Assessment Type *</label>
                            <select class="form-select" id="kpi_assessment_type" required>
                                <option value="">Select Type</option>
                                <option value="QUANTITATIVE">Quantitative</option>
                                <option value="QUALITATIVE">Qualitative</option>
                            </select>
                        </div>
                    </div>

                    <!-- Targets -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Weight (%) *</label>
                            <input type="number" class="form-control" id="kpi_weight"
                                   min="0" max="100" step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Target Value *</label>
                            <input type="number" class="form-control" id="kpi_target_value"
                                   step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Unit of Measurement *</label>
                            <input type="text" class="form-control" id="kpi_unit" required
                                   placeholder="e.g., %, USD, count">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Calculation Type *</label>
                            <select class="form-select" id="kpi_calculation_type" required>
                                <option value="">Select Type</option>
                                <option value="CUMULATIVE">Cumulative</option>
                                <option value="AVERAGE">Average</option>
                                <option value="MAXIMUM">Maximum</option>
                                <option value="MINIMUM">Minimum</option>
                                <option value="LATEST">Latest</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Measurement Period *</label>
                            <select class="form-select" id="kpi_measurement_period" required>
                                <option value="">Select Period</option>
                                <option value="MONTHLY">Monthly</option>
                                <option value="QUARTERLY">Quarterly</option>
                                <option value="ANNUALLY">Annually</option>
                            </select>
                        </div>
                    </div>

                    <!-- Optional Fields -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Baseline Value</label>
                            <input type="number" class="form-control" id="kpi_baseline_value"
                                   step="0.01" placeholder="Starting point">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Maximum Limit</label>
                            <input type="number" class="form-control" id="kpi_maximum_limit"
                                   step="0.01" placeholder="Maximum allowed value">
                        </div>
                    </div>

                    <!-- Derived KPI -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="kpi_is_derived">
                            <label class="form-check-label" for="kpi_is_derived">
                                This is a derived KPI (calculated from other KPIs)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="parent_kpi_container" style="display:none;">
                        <label class="form-label">Parent KPI</label>
                        <select class="form-select" id="kpi_parent_id">
                            <option value="">Select Parent KPI</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="kpi_notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKPI()">Save KPI</button>
            </div>
        </div>
    </div>
</div>

<!-- KPI Progress Modal -->
<div class="modal fade" id="kpiProgressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record KPI Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body position-relative">
                <div id="kpiProgressModalLoading" class="modal-loading-overlay" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <form id="kpiProgressForm">
                    <input type="hidden" id="kpi_progress_id">
                    <input type="hidden" id="progress_kpi_id">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-control" id="progress_year" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Month *</label>
                            <select class="form-select" id="progress_month" required>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Actual Value *</label>
                        <input type="number" class="form-control" id="progress_actual_value"
                               step="0.01" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Evidence URL</label>
                        <input type="url" class="form-control" id="progress_evidence_url"
                               placeholder="https://...">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="progress_notes" rows="3"
                                  placeholder="Any comments or explanations..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKPIProgress()">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="kpiDeleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete KPI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this KPI?</p>
                <p class="text-muted">
                    <strong>KPI:</strong> <span id="deleteKPIName"></span><br>
                    This will also delete all associated progress records.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmKPIDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
