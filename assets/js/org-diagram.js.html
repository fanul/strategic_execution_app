<script>
/**
 * Organization Diagram Component
 * Interactive hierarchical visualization using D3.js
 */

// ============================================================================
// ORGANIZATION DIAGRAM CLASS
// ============================================================================

class OrganizationDiagram {
    constructor(options = {}) {
        this.containerId = options.containerId || 'org-diagram';
        this.data = options.data || null;
        this.width = options.width || 1200;
        this.height = options.height || 800;
        this.nodeWidth = options.nodeWidth || 180;
        this.nodeHeight = options.nodeHeight || 80;
        this.duration = options.duration || 500;
        this.zoomEnabled = options.zoomEnabled !== false;
        this.panEnabled = options.panEnabled !== false;
        this.collapsible = options.collapsible !== false;
        this.onNodeClick = options.onNodeClick || null;
        this.onNodeDoubleClick = options.onNodeDoubleClick || null;
        this.onNodeRightClick = options.onNodeRightClick || null;

        this.svg = null;
        this.g = null;
        this.zoom = null;
        this.root = null;
        this.nodes = [];
        this.links = [];
    }

    /**
     * Initialize diagram
     */
    async init() {
        const container = document.getElementById(this.containerId);
        if (!container) {
            console.error(`Container not found: ${this.containerId}`);
            return;
        }

        // Clear container
        container.innerHTML = '';

        // Create controls
        this._createControls(container);

        // Create SVG element
        const svg = d3.select(`#${this.containerId}`)
            .append('svg')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('viewBox', `0 0 ${this.width} ${this.height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');

        this.svg = svg;

        // Create main group for zoom/pan
        this.g = svg.append('g')
            .attr('class', 'org-diagram-content');

        // Setup zoom behavior
        if (this.zoomEnabled || this.panEnabled) {
            this.zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    this.g.attr('transform', event.transform);
                });

            svg.call(this.zoom);
        }

        // Load and render data
        if (!this.data) {
            this.data = await this._loadOrganizationData();
        }

        this._render();
    }

    /**
     * Create control buttons
     * @private
     */
    _createControls(container) {
        const controls = document.createElement('div');
        controls.className = 'org-diagram-controls';
        controls.innerHTML = `
            <button class="org-diagram-btn" id="zoom-in" title="Zoom In">
                <i class="bi bi-zoom-in"></i>
            </button>
            <button class="org-diagram-btn" id="zoom-out" title="Zoom Out">
                <i class="bi bi-zoom-out"></i>
            </button>
            <button class="org-diagram-btn" id="zoom-reset" title="Reset Zoom">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <button class="org-diagram-btn" id="expand-all" title="Expand All">
                <i class="bi bi-chevron-down"></i>
            </button>
            <button class="org-diagram-btn" id="collapse-all" title="Collapse All">
                <i class="bi bi-chevron-up"></i>
            </button>
            <button class="org-diagram-btn" id="export-org" title="Export as PNG">
                <i class="bi bi-download"></i>
            </button>
        `;

        container.appendChild(controls);

        // Add event listeners
        if (this.svg) {
            document.getElementById('zoom-in').addEventListener('click', () => this._zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => this._zoomOut());
            document.getElementById('zoom-reset').addEventListener('click', () => this._resetZoom());
            document.getElementById('expand-all').addEventListener('click', () => this._expandAll());
            document.getElementById('collapse-all').addEventListener('click', () => this._collapseAll());
            document.getElementById('export-org').addEventListener('click', () => this._exportAsPNG());
        }
    }

    /**
     * Load organization data from API
     * @private
     */
    async _loadOrganizationData() {
        try {
            // Fetch directorates, work units, affairs, positions
            const [directorates, workUnits, affairs, positions] = await Promise.all([
                api.directorates.list(),
                api.workUnits.list(),
                api.affairs.list(),
                api.positions.list()
            ]);

            // Build hierarchical tree
            return this._buildTree(directorates, workUnits, affairs, positions);
        } catch (error) {
            console.error('Error loading organization data:', error);
            return { name: 'Organization', children: [] };
        }
    }

    /**
     * Build hierarchical tree structure
     * @private
     */
    _buildTree(directorates, workUnits, affairs, positions) {
        // Create a map for quick lookup
        const directorateMap = {};
        const workUnitMap = {};
        const affairMap = {};

        // Initialize directorates
        directorates.data.forEach(d => {
            directorateMap[d.directorate_id] = {
                id: d.directorate_id,
                name: d.directorate_name,
                type: 'directorate',
                code: d.directorate_code,
                children: [],
                data: d
            };
        });

        // Add work units to directorates
        workUnits.data.forEach(w => {
            const workUnit = {
                id: w.work_unit_id,
                name: w.work_unit_name,
                type: 'workunit',
                code: w.work_unit_code,
                children: [],
                data: w
            };
            workUnitMap[w.work_unit_id] = workUnit;

            if (directorateMap[w.directorate_id]) {
                directorateMap[w.directorate_id].children.push(workUnit);
            }
        });

        // Add affairs to work units
        affairs.data.forEach(a => {
            const affair = {
                id: a.affair_id,
                name: a.affair_name,
                type: 'affair',
                code: a.affair_code,
                children: [],
                data: a
            };
            affairMap[a.affair_id] = affair;

            if (workUnitMap[a.work_unit_id]) {
                workUnitMap[a.work_unit_id].children.push(affair);
            }
        });

        // Add positions to affairs
        positions.data.forEach(p => {
            const position = {
                id: p.position_id,
                name: p.position_name,
                type: 'position',
                code: p.position_code,
                level: p.position_level,
                children: [],
                data: p
            };

            // Add to appropriate parent
            if (p.affair_id && affairMap[p.affair_id]) {
                affairMap[p.affair_id].children.push(position);
            } else if (p.work_unit_id && workUnitMap[p.work_unit_id]) {
                workUnitMap[p.work_unit_id].children.push(position);
            } else if (p.directorate_id && directorateMap[p.directorate_id]) {
                directorateMap[p.directorate_id].children.push(position);
            }
        });

        // Return root node with directorates as children
        return {
            id: 'root',
            name: 'Organization',
            type: 'root',
            children: Object.values(directorateMap)
        };
    }

    /**
     * Render diagram
     * @private
     */
    _render() {
        if (!this.data) return;

        // Create tree layout
        const treeLayout = d3.tree()
            .size([this.height - 100, this.width - 200]);

        // Generate hierarchy
        const root = d3.hierarchy(this.data);
        treeLayout(root);

        this.root = root;

        // Create links
        this._renderLinks(root.links());

        // Create nodes
        this._renderNodes(root.descendants());
    }

    /**
     * Render links between nodes
     * @private
     */
    _renderLinks(links) {
        const link = d3.linkHorizontal()
            .x(d => d.y)
            .y(d => d.x);

        this.g.selectAll('.org-link')
            .data(links)
            .join('path')
            .attr('class', 'org-link')
            .attr('d', link)
            .style('fill', 'none')
            .style('stroke', '#cbd5e0')
            .style('stroke-width', '2px');
    }

    /**
     * Render nodes
     * @private
     */
    _renderNodes(nodes) {
        const nodeGroups = this.g.selectAll('.org-node')
            .data(nodes)
            .join('g')
            .attr('class', 'org-node')
            .attr('transform', d => `translate(${d.y},${d.x})`);

        // Node rectangles
        nodeGroups.append('rect')
            .attr('width', this.nodeWidth)
            .attr('height', this.nodeHeight)
            .attr('x', -this.nodeWidth / 2)
            .attr('y', -this.nodeHeight / 2)
            .attr('rx', 8)
            .attr('ry', 8)
            .style('fill', d => this._getNodeColor(d))
            .style('stroke', d => this._getNodeStroke(d))
            .style('stroke-width', '2px')
            .style('cursor', 'pointer')
            .on('click', (event, d) => this._handleNodeClick(event, d))
            .on('dblclick', (event, d) => this._handleNodeDoubleClick(event, d))
            .on('contextmenu', (event, d) => this._handleNodeRightClick(event, d));

        // Node labels
        nodeGroups.append('text')
            .attr('dy', '-5')
            .style('text-anchor', 'middle')
            .style('font-size', '12px')
            .style('font-weight', 'bold')
            .style('fill', '#333')
            .text(d => this._truncateText(d.data.name, 20));

        // Node sub-labels (type/code)
        nodeGroups.append('text')
            .attr('dy', '15')
            .style('text-anchor', 'middle')
            .style('font-size', '10px')
            .style('fill', '#666')
            .text(d => d.data.code || d.data.type);

        // Collapse/expand button for nodes with children
        nodeGroups.each((d, i, nodes) => {
            if (d.children && d.children.length > 0) {
                d3.select(nodes[i])
                    .append('circle')
                    .attr('cy', this.nodeHeight / 2)
                    .attr('r', 8)
                    .style('fill', '#fff')
                    .style('stroke', '#999')
                    .style('stroke-width', '1px')
                    .style('cursor', 'pointer')
                    .on('click', (event) => {
                        event.stopPropagation();
                        this._toggleNode(d);
                    });
            }
        });

        this.nodes = nodes;
    }

    /**
     * Get node color based on type
     * @private
     */
    _getNodeColor(d) {
        const colors = {
            'root': '#0d6efd',
            'directorate': '#e7f1ff',
            'workunit': '#fff3cd',
            'affair': '#d1e7dd',
            'position': '#f8d7da'
        };
        return colors[d.data.type] || '#f8f9fa';
    }

    /**
     * Get node stroke color
     * @private
     */
    _getNodeStroke(d) {
        const colors = {
            'root': '#0a58ca',
            'directorate': '#0d6efd',
            'workunit': '#ffc107',
            'affair': '#198754',
            'position': '#dc3545'
        };
        return colors[d.data.type] || '#dee2e6';
    }

    /**
     * Truncate text to fit node
     * @private
     */
    _truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
    }

    /**
     * Handle node click
     * @private
     */
    _handleNodeClick(event, d) {
        if (this.onNodeClick) {
            this.onNodeClick(d.data, d);
        }

        // Highlight selected node
        this.g.selectAll('.org-node rect')
            .style('stroke-width', '2px');

        d3.select(event.currentTarget)
            .style('stroke-width', '4px');
    }

    /**
     * Handle node double-click
     * @private
     */
    _handleNodeDoubleClick(event, d) {
        if (this.onNodeDoubleClick) {
            this.onNodeDoubleClick(d.data, d);
        }
    }

    /**
     * Handle node right-click
     * @private
     */
    _handleNodeRightClick(event, d) {
        event.preventDefault();

        if (this.onNodeRightClick) {
            this.onNodeRightClick(d.data, d);
        } else {
            this._showContextMenu(event, d);
        }
    }

    /**
     * Show context menu
     * @private
     */
    _showContextMenu(event, d) {
        const menu = document.createElement('div');
        menu.className = 'org-context-menu';
        menu.style.position = 'absolute';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        menu.style.zIndex = '9999';
        menu.innerHTML = `
            <div class="context-menu-item" data-action="view">
                <i class="bi bi-eye"></i> View Details
            </div>
            <div class="context-menu-item" data-action="edit">
                <i class="bi bi-pencil"></i> Edit
            </div>
            <div class="context-menu-item" data-action="add">
                <i class="bi bi-plus"></i> Add Child
            </div>
            ${d.data.type !== 'root' ? `
                <div class="context-menu-divider"></div>
                <div class="context-menu-item text-danger" data-action="delete">
                    <i class="bi bi-trash"></i> Delete
                </div>
            ` : ''}
        `;

        document.body.appendChild(menu);

        // Handle menu item clicks
        menu.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = item.dataset.action;
                this._handleContextMenuAction(action, d);
                menu.remove();
            });
        });

        // Close menu on click outside
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            });
        }, 100);
    }

    /**
     * Handle context menu action
     * @private
     */
    _handleContextMenuAction(action, d) {
        switch (action) {
            case 'view':
                showToast(`Viewing: ${d.data.name}`, 'Info');
                break;
            case 'edit':
                showToast(`Editing: ${d.data.name}`, 'Info');
                break;
            case 'add':
                showToast(`Adding child to: ${d.data.name}`, 'Info');
                break;
            case 'delete':
                confirmDialog({
                    title: 'Confirm Delete',
                    message: `Are you sure you want to delete "${d.data.name}"?`,
                    type: 'danger'
                }).then(confirmed => {
                    if (confirmed) {
                        showToast(`Deleted: ${d.data.name}`, 'Success');
                    }
                });
                break;
        }
    }

    /**
     * Toggle node collapse/expand
     * @private
     */
    _toggleNode(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        this._render();
    }

    /**
     * Zoom in
     */
    _zoomIn() {
        if (this.zoom) {
            this.svg.transition().duration(300).call(
                this.zoom.scaleBy, 1.3
            );
        }
    }

    /**
     * Zoom out
     */
    _zoomOut() {
        if (this.zoom) {
            this.svg.transition().duration(300).call(
                this.zoom.scaleBy, 0.7
            );
        }
    }

    /**
     * Reset zoom
     */
    _resetZoom() {
        if (this.zoom && this.svg) {
            this.svg.transition().duration(500).call(
                this.zoom.transform,
                d3.zoomIdentity
            );
        }
    }

    /**
     * Expand all nodes
     */
    _expandAll() {
        this.root.descendants().forEach(d => {
            if (d._children) {
                d.children = d._children;
                d._children = null;
            }
        });
        this._render();
    }

    /**
     * Collapse all nodes
     */
    _collapseAll() {
        this.root.descendants().forEach(d => {
            if (d.children && d.depth > 0) {
                d._children = d.children;
                d.children = null;
            }
        });
        this._render();
    }

    /**
     * Export diagram as PNG
     */
    _exportAsPNG() {
        const svgElement = document.querySelector(`#${this.containerId} svg`);
        if (!svgElement) return;

        // Serialize SVG
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(svgElement);

        // Create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        // Set canvas size
        canvas.width = this.width;
        canvas.height = this.height;

        img.onload = () => {
            ctx.drawImage(img, 0, 0);

            // Download as PNG
            const link = document.createElement('a');
            link.download = 'organization-diagram.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        };

        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
    }

    /**
     * Update diagram data
     */
    updateData(data) {
        this.data = data;
        this._render();
    }

    /**
     * Destroy diagram
     */
    destroy() {
        if (this.svg) {
            this.svg.remove();
            this.svg = null;
        }
    }
}

// ============================================================================
// HELPER FUNCTION TO CREATE ORGANIZATION DIAGRAM
// ============================================================================

function createOrganizationDiagram(containerId, options = {}) {
    const diagram = new OrganizationDiagram({
        containerId,
        ...options
    });

    diagram.init();

    return diagram;
}

// ============================================================================
// ADD STYLES FOR ORGANIZATION DIAGRAM
// ============================================================================

const orgDiagramStyles = `
    <style>
        .org-diagram-container {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        .org-diagram-content {
            cursor: grab;
        }

        .org-diagram-content:active {
            cursor: grabbing;
        }

        .org-diagram-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .org-context-menu {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f8f9fa;
        }

        .context-menu-item.text-danger {
            color: #dc3545;
        }

        .context-menu-divider {
            height: 1px;
            background-color: #dee2e6;
            margin: 4px 0;
        }
    </style>
`;

// Inject styles
document.head.insertAdjacentHTML('beforeend', orgDiagramStyles);

// ============================================================================
// EXPORT
// ============================================================================

if (typeof window !== 'undefined') {
    window.OrganizationDiagram = OrganizationDiagram;
    window.createOrganizationDiagram = createOrganizationDiagram;
}

</script>
