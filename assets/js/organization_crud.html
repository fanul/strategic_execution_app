<script>
// ============================================================================
// ORGANIZATION PAGE CRUD OPERATIONS
// This file contains CRUD operations specific to the Organization page
// ============================================================================

// Prevent duplicate event handlers
let organizationCrudHandlersSetup = false;

// Save Directorate
async function saveDirectorate() {
    debugLog('CRUD', '=== saveDirectorate START ===');

    // Get form elements
    const idEl = document.getElementById('directorate_id');
    const codeEl = document.getElementById('directorate_code');
    const nameEl = document.getElementById('directorate_name');
    const descEl = document.getElementById('description');

    // Defensive checks
    if (!codeEl || !nameEl || !descEl) {
        debugLog('CRUD', 'FAIL: Required form elements not found');
        showToast('Form not properly initialized. Please try again.', 'error');
        return;
    }

    // Get form values
    const id = idEl ? idEl.value : '';
    const data = {
        directorate_code: codeEl.value,
        directorate_name: nameEl.value,
        description: descEl.value
    };

    const formData = { id: id };
    for (const key in data) {
        formData[key] = data[key];
    }
    debugLog('CRUD', 'Form data:', formData);

    // Validation
    if (!data.directorate_code || !data.directorate_name) {
        debugLog('CRUD', 'FAIL Validation failed: missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
    }
    debugLog('CRUD', 'OK Validation passed');

    // Determine endpoint
    const endpoint = id ? 'directorates/update' : 'directorates/create';
    if (id) data.directorate_id = id;

    debugLog('CRUD', 'Calling endpoint: ' + endpoint, data);

    // API call
    const result = await apiCall(endpoint, data);
    debugLog('CRUD', 'API result:', result);

    if (result.success) {
        debugLog('CRUD', 'OK Directorate saved successfully');
        showToast('Directorate saved successfully', 'success');

        // Close modal
        const modalEl = document.getElementById('directorateModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
            debugLog('CRUD', 'OK Modal closed');
        } else {
            debugLog('CRUD', 'FAIL Failed to get modal instance');
        }

        // Reload data
        debugLog('CRUD', 'Refreshing directorates table...');
        await OrganizationManager.refreshEntityTable('directorate');
        debugLog('CRUD', 'OK Directorates table refreshed');

        // Reload diagram if active
        if (ViewToggle.getCurrentView() === 'diagram' && typeof OrgDiagram !== 'undefined') {
            debugLog('CRUD', 'Reloading diagram after directorate save');
            await OrgDiagram.reload();
        }

        debugLog('CRUD', '=== saveDirectorate COMPLETE ===');
    } else {
        debugLog('CRUD', 'FAIL Failed to save: ' + result.message);
        showToast('Failed to save: ' + result.message, 'error');
    }
}

// Save Work Unit
async function saveWorkUnit() {
    debugLog('CRUD', '=== saveWorkUnit START ===');

    // Get form elements
    const idEl = document.getElementById('work_unit_id');
    const codeEl = document.getElementById('work_unit_code');
    const nameEl = document.getElementById('work_unit_name');
    const directorateEl = document.getElementById('directorate_id_select');

    // Defensive checks
    if (!codeEl || !nameEl || !directorateEl) {
        debugLog('CRUD', 'FAIL: Required form elements not found');
        showToast('Form not properly initialized. Please try again.', 'error');
        return;
    }

    const id = idEl ? idEl.value : '';
    const data = {
        work_unit_code: codeEl.value,
        work_unit_name: nameEl.value,
        directorate_id: directorateEl.value
    };

    const formData = { id: id };
    for (const key in data) {
        formData[key] = data[key];
    }
    debugLog('CRUD', 'Form data:', formData);

    if (!data.work_unit_code || !data.work_unit_name || !data.directorate_id) {
        debugLog('CRUD', 'FAIL Validation failed: missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
    }
    debugLog('CRUD', 'OK Validation passed');

    const endpoint = id ? 'work-units/update' : 'work-units/create';
    if (id) data.work_unit_id = id;

    debugLog('CRUD', 'Calling endpoint: ' + endpoint, data);
    const result = await apiCall(endpoint, data);
    debugLog('CRUD', 'API result:', result);

    if (result.success) {
        debugLog('CRUD', 'OK Work Unit saved successfully');
        showToast('Work Unit saved successfully', 'success');

        const modalEl = document.getElementById('work-unitModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
            debugLog('CRUD', 'OK Modal closed');
        }

        await OrganizationManager.refreshEntityTable('work-unit');
        debugLog('CRUD', 'OK Work Units table refreshed');

        // Reload diagram if active
        if (ViewToggle.getCurrentView() === 'diagram' && typeof OrgDiagram !== 'undefined') {
            debugLog('CRUD', 'Reloading diagram after work unit save');
            await OrgDiagram.reload();
        }

        debugLog('CRUD', '=== saveWorkUnit COMPLETE ===');
    } else {
        debugLog('CRUD', 'FAIL Failed to save: ' + result.message);
        showToast('Failed to save: ' + result.message, 'error');
    }
}

// Save Affair
async function saveAffair() {
    debugLog('CRUD', '=== saveAffair START ===');

    // Get form elements
    const idEl = document.getElementById('affair_id');
    const codeEl = document.getElementById('affair_code');
    const nameEl = document.getElementById('affair_name');
    const workUnitEl = document.getElementById('work_unit_id_select');

    // Defensive checks
    if (!codeEl || !nameEl || !workUnitEl) {
        debugLog('CRUD', 'FAIL: Required form elements not found');
        showToast('Form not properly initialized. Please try again.', 'error');
        return;
    }

    const id = idEl ? idEl.value : '';
    const data = {
        affair_code: codeEl.value,
        affair_name: nameEl.value,
        work_unit_id: workUnitEl.value
    };

    const formData = { id: id };
    for (const key in data) {
        formData[key] = data[key];
    }
    debugLog('CRUD', 'Form data:', formData);

    if (!data.affair_code || !data.affair_name || !data.work_unit_id) {
        debugLog('CRUD', 'FAIL Validation failed: missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
    }
    debugLog('CRUD', 'OK Validation passed');

    const endpoint = id ? 'affairs/update' : 'affairs/create';
    if (id) data.affair_id = id;

    debugLog('CRUD', 'Calling endpoint: ' + endpoint, data);
    const result = await apiCall(endpoint, data);
    debugLog('CRUD', 'API result:', result);

    if (result.success) {
        debugLog('CRUD', 'OK Affair saved successfully');
        showToast('Affair saved successfully', 'success');

        const modalEl = document.getElementById('affairModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
            debugLog('CRUD', 'OK Modal closed');
        }

        await OrganizationManager.refreshEntityTable('affair');
        debugLog('CRUD', 'OK Affairs table refreshed');

        // Reload diagram if active
        if (ViewToggle.getCurrentView() === 'diagram' && typeof OrgDiagram !== 'undefined') {
            debugLog('CRUD', 'Reloading diagram after affair save');
            await OrgDiagram.reload();
        }

        debugLog('CRUD', '=== saveAffair COMPLETE ===');
    } else {
        debugLog('CRUD', 'FAIL Failed to save: ' + result.message);
        showToast('Failed to save: ' + result.message, 'error');
    }
}

// Save Position
async function savePosition() {
    debugLog('CRUD', '=== savePosition START ===');

    // Get form elements
    const idEl = document.getElementById('position_id');
    const codeEl = document.getElementById('position_code');
    const nameEl = document.getElementById('position_name');
    const levelEl = document.getElementById('position_level');
    const workUnitEl = document.getElementById('position_work_unit_id_select');
    const userEl = document.getElementById('position_user_id_select');

    // Defensive checks
    if (!codeEl || !nameEl || !levelEl || !workUnitEl) {
        debugLog('CRUD', 'FAIL: Required form elements not found');
        showToast('Form not properly initialized. Please try again.', 'error');
        return;
    }

    const id = idEl ? idEl.value : '';
    const data = {
        position_code: codeEl.value,
        position_name: nameEl.value,
        position_level: levelEl.value,
        work_unit_id: workUnitEl.value,
        user_id: userEl ? userEl.value : null // Include user assignment
    };

    const formData = { id: id };
    for (const key in data) {
        formData[key] = data[key];
    }
    debugLog('CRUD', 'Form data:', formData);

    if (!data.position_code || !data.position_name || !data.work_unit_id) {
        debugLog('CRUD', 'FAIL Validation failed: missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
    }
    debugLog('CRUD', 'OK Validation passed');

    const endpoint = id ? 'positions/update' : 'positions/create';
    if (id) data.position_id = id;

    debugLog('CRUD', 'Calling endpoint: ' + endpoint, data);
    const result = await apiCall(endpoint, data);
    debugLog('CRUD', 'API result:', result);

    if (result.success) {
        debugLog('CRUD', 'OK Position saved successfully');
        showToast('Position saved successfully', 'success');

        const modalEl = document.getElementById('positionModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) {
            modal.hide();
            debugLog('CRUD', 'OK Modal closed');
        }

        await OrganizationManager.refreshEntityTable('position');
        debugLog('CRUD', 'OK Positions table refreshed');

        // Reload diagram if active
        if (ViewToggle.getCurrentView() === 'diagram' && typeof OrgDiagram !== 'undefined') {
            debugLog('CRUD', 'Reloading diagram after position save');
            await OrgDiagram.reload();
        }

        debugLog('CRUD', '=== savePosition COMPLETE ===');
    } else {
        debugLog('CRUD', 'FAIL Failed to save: ' + result.message);
        showToast('Failed to save: ' + result.message, 'error');
    }
}

// ============================================================================
// ENHANCED DELETE CONFIRMATION
// Handles delete operations with children checking and cascade/reassign options
// ============================================================================

// Store current delete operation context
let deleteContext = {
    type: null,
    id: null,
    name: null,
    children: null,
    alternatives: null
};

// Map entity types to API endpoints
const deleteEndpointMap = {
    'directorate': {
        checkChildren: 'directorates/check-children',
        getAlternatives: 'directorates/get-alternatives',
        deleteCascade: 'directorates/delete-cascade',
        deleteReassign: 'directorates/delete-reassign',
        deleteDirect: 'directorates/delete',
        idField: 'directorate_id',
        newNameField: 'new_directorate_id'
    },
    'work-unit': {
        checkChildren: 'work-units/check-children',
        getAlternatives: 'work-units/get-alternatives',
        deleteCascade: 'work-units/delete-cascade',
        deleteReassign: 'work-units/delete-reassign',
        deleteDirect: 'work-units/delete',
        idField: 'work_unit_id',
        newNameField: 'new_work_unit_id'
    },
    'affair': {
        checkChildren: 'affairs/check-children',
        getAlternatives: 'affairs/get-alternatives',
        deleteCascade: 'affairs/delete-cascade',
        deleteReassign: 'affairs/delete-reassign',
        deleteDirect: 'affairs/delete',
        idField: 'affair_id',
        newNameField: 'new_affair_id'
    },
    'position': {
        deleteDirect: 'positions/delete',
        idField: 'position_id'
    }
};

// Helper functions for loading - always use overlay approach
function showDeleteLoading(caller = 'unknown') {
    debugLog('DELETE', 'showDeleteLoading called by: ' + caller);

    // Always use overlay approach (never replace main content for delete operations)
    const existingOverlay = document.querySelector('.delete-loading-overlay');
    if (existingOverlay) {
        debugLog('DELETE', 'Loading overlay already exists, reusing it');
        return;
    }

    const overlay = document.createElement('div');
    overlay.className = 'delete-loading-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;z-index:9999;';
    overlay.innerHTML = '<div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div>';
    document.body.appendChild(overlay);
    debugLog('DELETE', 'Loading overlay created');
}

function hideDeleteLoading(caller = 'unknown') {
    debugLog('DELETE', 'hideDeleteLoading called by: ' + caller);

    const overlay = document.querySelector('.delete-loading-overlay');
    if (overlay) {
        overlay.remove();
        debugLog('DELETE', 'Loading overlay removed');
    } else {
        debugLog('DELETE', 'No loading overlay found to remove');
    }
}

// Enhanced delete function
window.deleteItem = async function(type, id) {
    debugLog('DELETE', '=== deleteItem START === type=' + type + ', id=' + id);

    // For positions, use direct delete (no children)
    if (type === 'position') {
        const itemName = type.charAt(0).toUpperCase() + type.slice(1);
        if (!confirm('Are you sure you want to delete this ' + itemName + '?')) {
            debugLog('DELETE', 'FAIL Delete cancelled by user');
            return;
        }

        const endpoint = deleteEndpointMap[type].deleteDirect;
        const result = await apiCall(endpoint, { id });
        debugLog('DELETE', 'API result:', result);

        if (result.success) {
            showToast(itemName + ' deleted successfully', 'success');
            await OrganizationManager.refreshEntityTable(type);
            debugLog('DELETE', 'OK Delete completed');
        } else {
            showToast('Failed to delete: ' + result.message, 'error');
        }
        return;
    }

    // For entities with potential children, check first
    const endpoints = deleteEndpointMap[type];
    showDeleteLoading('deleteItem');

    try {
        // Check for children
        debugLog('DELETE', 'Checking children for ' + type + ' ' + id);
        const childrenResult = await apiCall(endpoints.checkChildren, { [endpoints.idField]: id });
        debugLog('DELETE', 'Children check result:', childrenResult);

        if (!childrenResult.success) {
            hideDeleteLoading('deleteItem-childrenCheckFailed');
            showToast('Failed to check children: ' + childrenResult.message, 'error');
            return;
        }

        const children = childrenResult.data;
        debugLog('DELETE', 'Children data:', children);

        // Get item details for display
        const itemEndpoint = type === 'directorate' ? 'directorates/get' :
                             type === 'work-unit' ? 'work-units/get' :
                             type === 'affair' ? 'affairs/get' : 'positions/get';
        const itemResult = await apiCall(itemEndpoint, { id });
        const itemName = itemResult.success ?
            (itemResult.data.directorate_name || itemResult.data.work_unit_name || itemResult.data.affair_name || type) :
            type;

        // Store context
        deleteContext = {
            type: type,
            id: id,
            name: itemName,
            children: children,
            alternatives: null
        };

        hideDeleteLoading('deleteItem-gotItemDetails');

        // If no children, show simple confirmation
        if (!children.hasChildren) {
            showSimpleDeleteConfirm(type, itemName, id);
        } else {
            // Has children - get alternatives and show full modal
            showDeleteWithChildren(type, itemName, children, id);
        }

    } catch (error) {
        hideDeleteLoading('deleteItem-error');
        debugLog('DELETE', 'FAIL Error: ' + error.message);
        showToast('Error checking children: ' + error.message, 'error');
    }
}

// Show simple delete confirmation (no children)
function showSimpleDeleteConfirm(type, itemName, id) {
    debugLog('DELETE', 'Showing simple delete confirm for ' + itemName);

    // Set up modal content
    document.getElementById('deleteConfirmTitle').textContent = 'Delete ' + (type.charAt(0).toUpperCase() + type.slice(1));
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteDirectMessage').style.display = 'block';
    document.getElementById('deleteHasChildrenWarning').style.display = 'none';
    document.getElementById('deleteChildrenDetails').style.display = 'none';
    document.getElementById('deleteOptionsSection').style.display = 'none';

    // Set direct delete mode
    deleteContext.mode = 'direct';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

// Show delete confirmation with children options
async function showDeleteWithChildren(type, itemName, children, id) {
    debugLog('DELETE', 'Showing delete confirm with children for ' + itemName);

    // Set up modal content
    document.getElementById('deleteConfirmTitle').textContent = 'Delete ' + (type.charAt(0).toUpperCase() + type.slice(1));
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteDirectMessage').style.display = 'none';
    document.getElementById('deleteHasChildrenWarning').style.display = 'block';
    document.getElementById('deleteOptionsSection').style.display = 'block';

    // Update children count and details
    document.getElementById('childrenCount').textContent = children.total;

    const childrenList = document.getElementById('childrenList');
    childrenList.innerHTML = '';

    if (children.workUnits > 0) {
        childrenList.innerHTML += '<li><i class="bi bi-building me-2"></i>' + children.workUnits + ' Work Unit(s)</li>';
    }
    if (children.affairs > 0) {
        childrenList.innerHTML += '<li><i class="bi bi-folder me-2"></i>' + children.affairs + ' Affair(s)</li>';
    }
    if (children.positions > 0) {
        childrenList.innerHTML += '<li><i class="bi bi-person me-2"></i>' + children.positions + ' Position(s)</li>';
    }

    document.getElementById('deleteChildrenDetails').style.display = childrenList.innerHTML !== '' ? 'block' : 'none';

    // Get alternatives for reassign option
    const endpointMap = deleteEndpointMap[type];
    showDeleteLoading('showDeleteWithChildren');

    try {
        const alternativesResult = await apiCall(endpointMap.getAlternatives, { [endpointMap.idField]: id });
        debugLog('DELETE', 'Alternatives result:', alternativesResult);
        debugLog('DELETE', 'Alternatives data type:', typeof alternativesResult.data);
        debugLog('DELETE', 'Alternatives data length:', Array.isArray(alternativesResult.data) ? alternativesResult.data.length : 'not an array');

        if (alternativesResult.success) {
            // Handle different data structures
            let alternativesData = alternativesResult.data;

            // If data is not an array, check if it has a nested property
            if (!Array.isArray(alternativesData)) {
                debugLog('DELETE', 'Data is not an array, checking for nested properties');
                if (alternativesData.alternatives && Array.isArray(alternativesData.alternatives)) {
                    alternativesData = alternativesData.alternatives;
                    debugLog('DELETE', 'Found nested alternatives array');
                } else if (alternativesData.work_units && Array.isArray(alternativesData.work_units)) {
                    alternativesData = alternativesData.work_units;
                    debugLog('DELETE', 'Found work_units array');
                } else if (alternativesData.directorates && Array.isArray(alternativesData.directorates)) {
                    alternativesData = alternativesData.directorates;
                    debugLog('DELETE', 'Found directorates array');
                } else {
                    debugLog('DELETE', 'No array found in response, converting to array');
                    alternativesData = alternativesData.data ? [alternativesData.data] : [];
                }
            }

            debugLog('DELETE', 'Processed alternatives data:', alternativesData);
            debugLog('DELETE', 'Alternatives count:', alternativesData.length);

            if (alternativesData.length > 0) {
                deleteContext.alternatives = alternativesData;

                // Populate reassign dropdown with flexible field mapping
                const reassignSelect = document.getElementById('reassignTarget');

                // Destroy existing Select2 if present
                if (typeof $ !== 'undefined' && $(reassignSelect).data('select2')) {
                    $(reassignSelect).select2('destroy');
                }

                reassignSelect.innerHTML = '<option value="">-- Select new parent --</option>';

                alternativesData.forEach(alt => {
                    // Try different field names for id
                    const id = alt.id || alt.work_unit_id || alt.directorate_id || alt.affair_id || alt.position_id;
                    // Try different field names for display name
                    const display = alt.display || alt.name || alt.work_unit_name || alt.directorate_name || alt.affair_name || alt.position_name || alt.title || id;

                    debugLog('DELETE', 'Processing alternative: id=' + id + ', display=' + display);

                    if (id) {
                        reassignSelect.innerHTML += '<option value="' + id + '">' + display + '</option>';
                    }
                });

                // Initialize Select2 on the dropdown for searchable functionality
                if (typeof $ !== 'undefined') {
                    $(reassignSelect).select2({
                        dropdownParent: $('#deleteConfirmModal'),
                        placeholder: '-- Select new parent --',
                        allowClear: true,
                        width: '100%'
                    });
                    debugLog('DELETE', 'Select2 initialized on reassignTarget');
                }

                // Enable reassign option
                document.getElementById('deleteOptionReassign').disabled = false;
                debugLog('DELETE', 'Reassign option enabled with ' + alternativesData.length + ' alternatives');
            } else {
                // No alternatives available, disable reassign option
                deleteContext.alternatives = [];
                document.getElementById('reassignTarget').innerHTML = '<option value="">-- No alternatives available --</option>';
                document.getElementById('deleteOptionReassign').disabled = true;
                document.getElementById('deleteOptionCascade').checked = true;
                debugLog('DELETE', 'No alternatives found, reassign disabled');
            }
        } else {
            // API call failed
            deleteContext.alternatives = [];
            document.getElementById('reassignTarget').innerHTML = '<option value="">-- Error loading alternatives --</option>';
            document.getElementById('deleteOptionReassign').disabled = true;
            document.getElementById('deleteOptionCascade').checked = true;
            debugLog('DELETE', 'Alternatives API call failed: ' + alternativesResult.message);
        }

        hideDeleteLoading('showDeleteWithChildren-gotAlternatives');

        // Set cascade delete as default
        deleteContext.mode = 'cascade';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();

    } catch (error) {
        hideDeleteLoading('showDeleteWithChildren-error');
        debugLog('DELETE', 'FAIL Error getting alternatives: ' + error.message);
        showToast('Error getting alternatives: ' + error.message, 'error');
    }
}

// Handle delete option change
function setupDeleteOptionHandlers() {
    if (organizationCrudHandlersSetup) {
        debugLog('DELETE', 'Handlers already setup, skipping');
        return;
    }

    document.addEventListener('change', function deleteOptionHandler(e) {
        if (e.target.name === 'deleteOption') {
            const reassignSection = document.getElementById('reassignSection');
            if (!reassignSection) return;

            if (e.target.value === 'reassign') {
                reassignSection.style.display = 'block';
                deleteContext.mode = 'reassign';
            } else {
                reassignSection.style.display = 'none';
                deleteContext.mode = 'cascade';
            }
        }
    });

    // Hide loading overlay when delete modal is closed (cancel or X button)
    document.addEventListener('hidden.bs.modal', function modalCloseHandler(e) {
        if (e.target.id === 'deleteConfirmModal') {
            // Clean up Select2
            const reassignSelect = document.getElementById('reassignTarget');
            if (reassignSelect && typeof $ !== 'undefined' && $(reassignSelect).data('select2')) {
                $(reassignSelect).select2('destroy');
                debugLog('DELETE', 'Select2 destroyed on modal close');
            }
            hideDeleteLoading('modalClosed');
        }
    });

    organizationCrudHandlersSetup = true;
    debugLog('DELETE', 'Delete option handlers setup complete');
}

// Setup handlers when script loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupDeleteOptionHandlers);
} else {
    setupDeleteOptionHandlers();
}

// Execute the delete operation
window.executeDelete = async function() {
    debugLog('DELETE', '=== executeDelete START === mode=' + deleteContext.mode);

    const type = deleteContext.type;
    const id = deleteContext.id;
    const endpoints = deleteEndpointMap[type];

    // Validate reassign option if selected
    if (deleteContext.mode === 'reassign') {
        const newParentId = document.getElementById('reassignTarget').value;
        if (!newParentId) {
            showToast('Please select a new parent for reassignment', 'error');
            return;
        }
        deleteContext.newParentId = newParentId;
    }

    // Close modal
    const modalEl = document.getElementById('deleteConfirmModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    showDeleteLoading('executeDelete');

    try {
        let result;
        let endpoint;
        let data = { [endpoints.idField]: id };

        if (deleteContext.mode === 'cascade') {
            endpoint = endpoints.deleteCascade;
            debugLog('DELETE', 'Calling cascade delete: ' + endpoint, data);
            result = await apiCall(endpoint, data);
        } else if (deleteContext.mode === 'reassign') {
            endpoint = endpoints.deleteReassign;
            data[endpoints.newNameField] = deleteContext.newParentId;
            debugLog('DELETE', 'Calling reassign and delete: ' + endpoint, data);
            result = await apiCall(endpoint, data);
        } else {
            // Direct delete (no children)
            endpoint = endpoints.deleteDirect;
            debugLog('DELETE', 'Calling direct delete: ' + endpoint, data);
            result = await apiCall(endpoint, data);
        }

        debugLog('DELETE', 'API result:', result);

        if (result.success) {
            const typeName = type.charAt(0).toUpperCase() + type.slice(1);
            showToast(typeName + ' deleted successfully', 'success');

            // Refresh all affected tables based on entity hierarchy
            // Mapping of entity types to tables that need to be refreshed
            const affectedTables = {
                'directorate': ['directorate', 'work-unit', 'affair', 'position'],
                'work-unit': ['work-unit', 'affair', 'position'],
                'affair': ['affair', 'position'],
                'position': ['position']
            };

            const tablesToRefresh = affectedTables[type] || [type];
            debugLog('DELETE', 'Refreshing affected tables:', tablesToRefresh);

            // Refresh all affected tables in parallel
            const refreshPromises = tablesToRefresh.map(tableType => {
                return OrganizationManager.refreshEntityTable(tableType)
                    .then(() => debugLog('DELETE', 'OK Refreshed ' + tableType + ' table'))
                    .catch(err => debugLog('DELETE', 'FAIL Failed to refresh ' + tableType + ':', err));
            });

            await Promise.all(refreshPromises);
            debugLog('DELETE', 'OK All affected tables refreshed');

            // Reload diagram if active
            if (currentView === 'diagram' && typeof OrgDiagram !== 'undefined') {
                debugLog('DELETE', 'Reloading diagram after delete');
                await OrgDiagram.reload();
            }
        } else {
            showToast('Failed to delete: ' + result.message, 'error');
        }

    } catch (error) {
        debugLog('DELETE', 'FAIL Error: ' + error.message);
        showToast('Error deleting: ' + error.message, 'error');
    } finally {
        hideDeleteLoading('executeDelete-finally');
        debugLog('DELETE', '=== executeDelete COMPLETE ===');
    }
}

// ============================================================================
// ORGANIZATIONAL UNITS MANAGER (New BPJS Structure)
// ============================================================================

const OrgUnitManager = {
    /**
     * Initialize the organizational units manager
     */
    init: async function() {
        debugLog('ORG_UNIT', '=== OrgUnitManager init START ===');

        // Mark tree container as initialized to prevent duplicate initialization
        const treeContainer = document.getElementById('org-units-tree-container');
        if (treeContainer) {
            treeContainer.setAttribute('data-initialized', 'true');
        }

        // Load stats
        await this.loadStats();

        // Load tree view by default
        await this.loadTreeView();

        // Setup event listeners
        this.setupEventListeners();

        debugLog('ORG_UNIT', '=== OrgUnitManager init COMPLETE ===');
    },

    /**
     * Load statistics for the dashboard
     */
    loadStats: async function() {
        debugLog('ORG_UNIT', 'Loading organizational unit stats...');

        try {
            // Get all units
            const result = await apiCall('organizational-units/list', { is_active: true });

            if (result.success && result.data) {
                const units = result.data;

                // Count by type
                const stats = {
                    total: units.length,
                    regional: units.filter(u => u.unit_type === 'REGIONAL_OFFICE').length,
                    branch: units.filter(u => u.unit_type === 'BRANCH_OFFICE').length,
                    subsidiary: units.filter(u => u.unit_type === 'SUBSIDIARY').length
                };

                // Update UI
                document.getElementById('stat-total-units').textContent = stats.total;
                document.getElementById('stat-regional-offices').textContent = stats.regional;
                document.getElementById('stat-branch-offices').textContent = stats.branch;
                document.getElementById('stat-subsidiaries').textContent = stats.subsidiary;

                debugLog('ORG_UNIT', 'Stats loaded:', stats);
            }
        } catch (error) {
            debugLog('ORG_UNIT', 'Failed to load stats:', error);
        }
    },

    /**
     * Load tree view (hierarchical display)
     */
    loadTreeView: async function() {
        debugLog('ORG_UNIT', 'Loading tree view...');

        const container = document.getElementById('org-units-tree-container');
        if (!container) {
            debugLog('ORG_UNIT', 'Tree container not found');
            return;
        }

        try {
            // Show loading state
            container.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading organizational structure...</p>
                </div>
            `;

            // Get hierarchy from API
            const result = await apiCall('organizational-units/hierarchy', { include_inactive: false });

            debugLog('ORG_UNIT', 'Hierarchy API result:', result);

            if (result.success && result.data) {
                // Check if data is empty
                if (!result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-diagram-3" style="font-size: 3rem;"></i>
                            <p class="mt-3">No organizational units found</p>
                            <p class="small">Click "Add Organizational Unit" to create the first unit</p>
                        </div>
                    `;
                    debugLog('ORG_UNIT', 'No organizational units in database');
                } else {
                    // Build hierarchical tree HTML
                    const treeHtml = this.buildTreeHtml(result.data);
                    container.innerHTML = treeHtml;
                    debugLog('ORG_UNIT', 'Tree view loaded successfully with', result.data.length, 'root units');
                }
            } else {
                container.innerHTML = '<div class="alert alert-warning">Failed to load organizational structure: ' + (result.message || 'Unknown error') + '</div>';
                debugLog('ORG_UNIT', 'Failed to load hierarchy:', result.message);
            }
        } catch (error) {
            debugLog('ORG_UNIT', 'Error loading tree view:', error);
            container.innerHTML = '<div class="alert alert-danger">Error loading tree view: ' + error.message + '</div>';
        }
    },

    /**
     * Load flat view (table display)
     */
    loadFlatView: async function() {
        debugLog('ORG_UNIT', 'Loading flat view...');

        try {
            // Get all units
            const result = await apiCall('organizational-units/list', { is_active: true });

            if (result.success && result.data) {
                const units = result.data;
                const tbody = document.getElementById('org-units-body');

                if (!tbody) return;

                // Build table rows
                const rows = units.map(unit => {
                    const typeBadge = this.getTypeBadge(unit.unit_type);
                    const classBadge = this.getClassificationBadge(unit.classification);
                    const statusBadge = unit.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';
                    const location = [unit.province, unit.city].filter(Boolean).join(', ') || '-';

                    return `
                        <tr>
                            <td>${typeBadge}</td>
                            <td>${unit.unit_code || '-'}</td>
                            <td>${unit.unit_name}</td>
                            <td>${unit.unit_level || '-'}</td>
                            <td>${classBadge}</td>
                            <td>${location}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="OrgUnitManager.viewUnit('${unit.unit_id}')" title="View">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="OrgUnitManager.editUnit('${unit.unit_id}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    ${!unit.is_active ? '' : `
                                    <button class="btn btn-outline-danger" onclick="OrgUnitManager.deleteUnit('${unit.unit_id}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;
                debugLog('ORG_UNIT', 'Flat view loaded with', units.length, 'units');
            }
        } catch (error) {
            debugLog('ORG_UNIT', 'Error loading flat view:', error);
        }
    },

    /**
     * Build HTML tree from hierarchical data
     */
    buildTreeHtml: function(nodes, level = 0) {
        if (!nodes || nodes.length === 0) {
            return '<div class="text-muted p-3">No organizational units found</div>';
        }

        debugLog('ORG_UNIT', 'Building tree HTML for', nodes.length, 'nodes at level', level);

        const indent = level * 20;
        let html = '<div class="org-tree">';

        nodes.forEach((node, index) => {
            const hasChildren = node.children && node.children.length > 0;
            const childCount = hasChildren ? node.children.length : 0;
            const icon = this.getNodeIcon(node.unit_type);
            const badge = this.getClassificationBadge(node.classification);
            const typeLabel = this.getTypeLabel(node.unit_type);
            const statusClass = node.is_active ? '' : 'text-muted text-decoration-line-through';

            debugLog('ORG_UNIT', `Node ${index}: ${node.unit_name} (${node.unit_type}), children: ${childCount}`);

            html += `
                <div class="org-tree-node" style="margin-left: ${indent}px; padding: 8px 0; border-left: 2px solid #e0e0e0;" data-unit-id="${node.unit_id}">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center flex-grow-1">
                            ${hasChildren ?
                                `<i class="bi bi-caret-right-fill text-primary me-2 tree-toggle" style="cursor: pointer; font-size: 1.2rem;" title="Click to expand/collapse (${childCount} children)"></i>` :
                                '<span class="me-4"></span>'
                            }
                            ${icon}
                            <div class="fw-medium ${statusClass}">${node.unit_name}</div>
                            ${badge ? '<span class="ms-2">' + badge + '</span>' : ''}
                            <small class="text-muted ms-2">${typeLabel}</small>
                            ${!node.is_active ? '<span class="badge bg-secondary ms-2">Inactive</span>' : ''}
                            ${hasChildren ? `<span class="badge bg-info ms-2">${childCount} children</span>` : ''}
                        </div>
                        <div class="btn-group btn-group-sm ms-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); OrgUnitManager.editUnit('${node.unit_id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); OrgUnitManager.deleteUnit('${node.unit_id}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${hasChildren ?
                        `<div class="org-tree-children ps-4" style="display: none; border-left: 1px dashed #ccc;">
                            ${this.buildTreeHtml(node.children, level + 1)}
                        </div>` :
                        ''
                    }
                </div>
            `;
        });

        html += '</div>';

        // Add click handlers for tree toggles
        setTimeout(() => {
            debugLog('ORG_UNIT', 'Setting up tree toggle handlers...');
            const toggles = document.querySelectorAll('.tree-toggle');
            debugLog('ORG_UNIT', 'Found', toggles.length, 'toggle elements');

            toggles.forEach((toggle, idx) => {
                // Remove existing listeners to prevent duplicates
                toggle.parentNode?.removeEventListener('click', toggle._handler);

                // Create new handler
                toggle._handler = function(e) {
                    e.stopPropagation();
                    e.preventDefault();

                    const treeNode = this.closest('.org-tree-node');
                    const children = treeNode.querySelector('.org-tree-children');

                    debugLog('ORG_UNIT', 'Toggle clicked, children container:', children ? 'found' : 'not found');

                    if (children) {
                        const isHidden = children.style.display === 'none' || !children.style.display;
                        children.style.display = isHidden ? 'block' : 'none';

                        // Update icon
                        if (isHidden) {
                            this.classList.remove('bi-caret-right-fill');
                            this.classList.add('bi-caret-down-fill');
                        } else {
                            this.classList.remove('bi-caret-down-fill');
                            this.classList.add('bi-caret-right-fill');
                        }

                        debugLog('ORG_UNIT', 'Children toggled:', isHidden ? 'expanded' : 'collapsed');
                    }
                };

                toggle.addEventListener('click', toggle._handler);
            });

            debugLog('ORG_UNIT', 'Tree toggle handlers setup complete');
        }, 100);

        return html;
    },

    /**
     * Get icon for node type
     */
    getNodeIcon: function(unitType) {
        const icons = {
            'ROOT': '<i class="bi bi-building text-primary me-2"></i>',
            'DIRECTORATE': '<i class="bi bi-building me-2" style="color: #42A5F5;"></i>',
            'WORK_UNIT': '<i class="bi bi-layers me-2" style="color: #90CAF9;"></i>',
            'AFFAIR': '<i class="bi bi-folder me-2" style="color: #BBDEFB;"></i>',
            'REGIONAL_OFFICE': '<i class="bi bi-geo-alt me-2 text-success"></i>',
            'BRANCH_OFFICE': '<i class="bi bi-pin-map me-2" style="color: #8BC34A;"></i>',
            'SUBSIDIARY': '<i class="bi bi-building me-2 text-warning"></i>',
            'SUBSIDIARY_UNIT': '<i class="bi bi-building me-2" style="color: #BA68C8;"></i>'
        };
        return icons[unitType] || '<i class="bi bi-building me-2 text-secondary"></i>';
    },

    /**
     * Get type badge HTML
     */
    getTypeBadge: function(unitType) {
        const badges = {
            'ROOT': '<span class="badge bg-primary">ROOT</span>',
            'DIRECTORATE': '<span class="badge" style="background-color: #42A5F5;">DIR</span>',
            'WORK_UNIT': '<span class="badge" style="background-color: #90CAF9;">WU</span>',
            'AFFAIR': '<span class="badge" style="background-color: #BBDEFB; color: black;">AFF</span>',
            'REGIONAL_OFFICE': '<span class="badge bg-success">RO</span>',
            'BRANCH_OFFICE': '<span class="badge" style="background-color: #8BC34A; color: black;">BO</span>',
            'SUBSIDIARY': '<span class="badge bg-warning text-dark">SUB</span>',
            'SUBSIDIARY_UNIT': '<span class="badge" style="background-color: #BA68C8;">SU</span>'
        };
        return badges[unitType] || '<span class="badge bg-secondary">Unknown</span>';
    },

    /**
     * Get classification badge HTML
     */
    getClassificationBadge: function(classification) {
        if (!classification) return '';

        const badges = {
            'HQ': '<span class="badge bg-primary">HQ</span>',
            'KELAS_1': '<span class="badge" style="background-color: #2E7D32;">Kelas 1</span>',
            'KELAS_2': '<span class="badge" style="background-color: #43A047;">Kelas 2</span>',
            'KELAS_3': '<span class="badge" style="background-color: #8BC34A;">Kelas 3</span>',
            'KELAS_3A': '<span class="badge" style="background-color: #AED581; color: black;">Kelas 3A</span>',
            'SUBSIDIARY': '<span class="badge bg-warning text-dark">Subsidiary</span>'
        };
        return badges[classification] || '';
    },

    /**
     * Get type label
     */
    getTypeLabel: function(unitType) {
        const labels = {
            'ROOT': 'Organization',
            'DIRECTORATE': 'Directorate',
            'WORK_UNIT': 'Work Unit',
            'AFFAIR': 'Affair',
            'REGIONAL_OFFICE': 'Regional Office',
            'BRANCH_OFFICE': 'Branch Office',
            'SUBSIDIARY': 'Subsidiary',
            'SUBSIDIARY_UNIT': 'Subsidiary Unit'
        };
        return labels[unitType] || unitType;
    },

    /**
     * Show tree view
     */
    showTreeView: async function() {
        document.getElementById('org-units-tree-view').style.display = 'block';
        document.getElementById('org-units-flat-view').style.display = 'none';
        document.getElementById('btn-tree-view').classList.add('active');
        document.getElementById('btn-flat-view').classList.remove('active');
        await this.loadTreeView();
    },

    /**
     * Show flat view
     */
    showFlatView: async function() {
        document.getElementById('org-units-tree-view').style.display = 'none';
        document.getElementById('org-units-flat-view').style.display = 'block';
        document.getElementById('btn-tree-view').classList.remove('active');
        document.getElementById('btn-flat-view').classList.add('active');
        await this.loadFlatView();
    },

    /**
     * Apply filters
     */
    applyFilters: async function() {
        debugLog('ORG_UNIT', 'Applying filters...');

        const typeSelect = document.getElementById('org-units-filter-type');
        const classSelect = document.getElementById('org-units-filter-classification');
        const provinceInput = document.getElementById('org-units-filter-province');
        const cityInput = document.getElementById('org-units-filter-city');
        const showInactive = document.getElementById('org-units-show-inactive').checked;

        const filters = {
            include_inactive: showInactive
        };

        // Get selected types
        if (typeSelect && typeSelect.selectedOptions.length > 0) {
            const types = Array.from(typeSelect.selectedOptions).map(o => o.value);
            // For now, just use the first selected type
            // TODO: Support multiple types
            if (types.length > 0) {
                filters.unit_type = types[0];
            }
        }

        // Get selected classifications
        if (classSelect && classSelect.selectedOptions.length > 0) {
            const classes = Array.from(classSelect.selectedOptions).map(o => o.value);
            if (classes.length > 0) {
                filters.classification = classes[0];
            }
        }

        if (provinceInput && provinceInput.value) {
            filters.province = provinceInput.value;
        }

        if (cityInput && cityInput.value) {
            filters.city = cityInput.value;
        }

        debugLog('ORG_UNIT', 'Filters:', filters);

        // Reload with filters
        await this.loadTreeView();
    },

    /**
     * Clear filters
     */
    clearFilters: async function() {
        document.getElementById('org-units-filter-type').value = '';
        document.getElementById('org-units-filter-classification').value = '';
        document.getElementById('org-units-filter-province').value = '';
        document.getElementById('org-units-filter-city').value = '';
        document.getElementById('org-units-show-inactive').checked = false;

        await this.loadTreeView();
        showToast('Filters cleared', 'info');
    },

    /**
     * View unit details
     */
    viewUnit: async function(unitId) {
        debugLog('ORG_UNIT', 'Viewing unit:', unitId);
        // TODO: Implement view unit modal
        showToast('View unit details: ' + unitId, 'info');
    },

    /**
     * Edit unit
     */
    editUnit: async function(unitId) {
        debugLog('ORG_UNIT', 'Editing unit:', unitId);

        // Check if showModal function exists
        if (typeof showModal !== 'function') {
            debugLog('ORG_UNIT', 'FAIL: showModal function not available');
            showToast('Modal system not available', 'error');
            return;
        }

        // Open the org-unit modal in edit mode
        showModal('org-unit', unitId);
    },

    /**
     * Delete unit
     */
    deleteUnit: async function(unitId) {
        if (!confirm('Are you sure you want to delete this organizational unit?')) {
            return;
        }

        debugLog('ORG_UNIT', 'Deleting unit:', unitId);

        const result = await apiCall('organizational-units/delete', { unitId: unitId });

        if (result.success) {
            showToast('Unit deleted successfully', 'success');
            await this.loadTreeView();
            await this.loadStats();
        } else {
            showToast('Failed to delete: ' + result.message, 'error');
        }
    },

    /**
     * Setup event listeners
     */
    setupEventListeners: function() {
        // Filter change listeners
        const filterInputs = ['org-units-filter-type', 'org-units-filter-classification',
                              'org-units-filter-province', 'org-units-filter-city'];

        filterInputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', () => this.applyFilters());
            }
        });
    },

    /**
     * Show view mode selector (currently just switches between tree/flat view)
     */
    showViewModeSelector: function() {
        debugLog('ORG_UNIT', 'View mode selector clicked');

        // For now, just toggle between tree and flat view
        const treeViewBtn = document.getElementById('btn-tree-view');
        const flatViewBtn = document.getElementById('btn-flat-view');

        if (treeViewBtn && flatViewBtn) {
            // Check current state and toggle
            if (treeViewBtn.classList.contains('active')) {
                // Currently in tree view, switch to flat
                this.showFlatView();
            } else {
                // Currently in flat view, switch to tree
                this.showTreeView();
            }
        } else {
            debugLog('ORG_UNIT', 'View buttons not found, defaulting to tree view');
            this.showTreeView();
        }
    }
};

// Global wrapper function for showViewModeSelector (called from HTML onclick)
function showViewModeSelector() {
    if (typeof OrgUnitManager !== 'undefined' && OrgUnitManager.showViewModeSelector) {
        OrgUnitManager.showViewModeSelector();
    } else {
        debugLog('ORG_UNIT', 'FAIL: OrgUnitManager not available');
        showToast('View mode selector not available', 'error');
    }
}

// ============================================================================
// ORGANIZATIONAL UNIT CRUD OPERATIONS (BPJS Structure)
// ============================================================================

/**
 * Save Organizational Unit (Create or Update)
 */
async function saveOrgUnit() {
    debugLog('CRUD', '=== saveOrgUnit START ===');

    // Get form elements
    const idEl = document.getElementById('unit_id');
    const typeEl = document.getElementById('unit_type');
    const parentEl = document.getElementById('parent_unit_id');
    const codeEl = document.getElementById('unit_code');
    const nameEl = document.getElementById('unit_name');
    const classEl = document.getElementById('classification');
    const levelEl = document.getElementById('unit_level');
    const geoEl = document.getElementById('geographical_scope');
    const provEl = document.getElementById('province');
    const cityEl = document.getElementById('city');
    const addrEl = document.getElementById('address');
    const headEl = document.getElementById('head_position_id');
    const activeEl = document.getElementById('is_active');
    const notesEl = document.getElementById('notes');

    // Defensive checks
    if (!typeEl || !codeEl || !nameEl) {
        debugLog('CRUD', 'FAIL: Required form elements not found');
        showToast('Form not properly initialized. Please try again.', 'error');
        return;
    }

    // Get form values
    const id = idEl ? idEl.value : '';
    const data = {
        unit_type: typeEl.value,
        parent_unit_id: parentEl.value || null,
        unit_code: codeEl.value,
        unit_name: nameEl.value,
        classification: classEl.value || null,
        unit_level: parseInt(levelEl?.value) || 0,
        geographical_scope: geoEl.value || null,
        province: provEl.value || null,
        city: cityEl.value || null,
        address: addrEl.value || null,
        head_position_id: headEl.value || null,
        is_active: activeEl ? activeEl.checked : true,
        notes: notesEl.value || null
    };

    const formData = { id: id };
    for (const key in data) {
        formData[key] = data[key];
    }
    debugLog('CRUD', 'Form data:', formData);

    // Validation
    if (!data.unit_type || !data.unit_code || !data.unit_name) {
        debugLog('CRUD', 'FAIL Validation failed: missing required fields');
        showToast('Please fill in all required fields', 'error');
        return;
    }

    // Validate parent-child relationships
    if (data.parent_unit_id && data.parent_unit_id === id) {
        debugLog('CRUD', 'FAIL Validation failed: unit cannot be its own parent');
        showToast('A unit cannot be its own parent', 'error');
        return;
    }

    // Validate ROOT unit
    if (data.unit_type === 'ROOT' && data.parent_unit_id) {
        debugLog('CRUD', 'FAIL Validation failed: ROOT cannot have a parent');
        showToast('ROOT unit cannot have a parent unit', 'error');
        return;
    }

    debugLog('CRUD', 'OK Validation passed');

    // Determine endpoint
    const endpoint = id ? 'organizational-units/update' : 'organizational-units/create';
    if (id) data.unitId = id;

    debugLog('CRUD', 'Calling endpoint: ' + endpoint, data);

    // API call
    try {
        const result = await apiCall(endpoint, data);
        debugLog('CRUD', 'API result:', result);

        if (result.success) {
            debugLog('CRUD', 'OK Organizational unit saved successfully');
            showToast('Organizational unit saved successfully', 'success');

            // Close modal
            const modalEl = document.getElementById('org-unitModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
                debugLog('CRUD', 'OK Modal closed');
            } else {
                debugLog('CRUD', 'FAIL Failed to get modal instance');
            }

            // Reload data
            if (typeof OrgUnitManager !== 'undefined') {
                debugLog('CRUD', 'Refreshing organizational units...');
                await OrgUnitManager.loadTreeView();
                await OrgUnitManager.loadStats();
                debugLog('CRUD', 'OK Data refreshed');
            }

            debugLog('CRUD', '=== saveOrgUnit COMPLETE ===');
        } else {
            debugLog('CRUD', 'FAIL Failed to save: ' + result.message);
            showToast('Failed to save: ' + result.message, 'error');
        }
    } catch (error) {
        debugLog('CRUD', 'FAIL Exception during save:', error);
        showToast('Error saving unit: ' + error.message, 'error');
    }
}

/**
 * Handle unit type change - update classification options
 */
function handleUnitTypeChange() {
    debugLog('CRUD', '=== handleUnitTypeChange START ===');

    const typeEl = document.getElementById('unit_type');
    const classEl = document.getElementById('classification');
    const parentEl = document.getElementById('parent_unit_id');

    if (!typeEl || !classEl) {
        debugLog('CRUD', 'FAIL Required elements not found');
        return;
    }

    const unitType = typeEl.value;
    debugLog('CRUD', 'Unit type changed to:', unitType);

    // Reset classification
    classEl.innerHTML = '<option value="">Select Classification</option>';

    // Show/hide classification based on unit type
    if (unitType === 'BRANCH_OFFICE') {
        // Show branch classifications
        const classifications = [
            { value: 'KELAS_1', label: 'Kelas 1 (Class 1 Branch)' },
            { value: 'KELAS_2', label: 'Kelas 2 (Class 2 Branch)' },
            { value: 'KELAS_3', label: 'Kelas 3 (Class 3 Branch)' },
            { value: 'KELAS_3A', label: 'Kelas 3A (Class 3A Branch)' }
        ];

        classifications.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.value;
            option.textContent = cls.label;
            classEl.appendChild(option);
        });

        classEl.disabled = false;
        debugLog('CRUD', 'OK Branch office classifications enabled');
    } else if (unitType === 'SUBSIDIARY' || unitType === 'SUBSIDIARY_UNIT') {
        // Show subsidiary classification
        const option = document.createElement('option');
        option.value = 'SUBSIDIARY';
        option.textContent = 'Subsidiary';
        classEl.appendChild(option);

        classEl.disabled = false;
        debugLog('CRUD', 'OK Subsidiary classification enabled');
    } else if (unitType === 'ROOT' || unitType === 'DIRECTORATE' || unitType === 'WORK_UNIT' || unitType === 'AFFAIR') {
        // HQ units
        const option = document.createElement('option');
        option.value = 'HQ';
        option.textContent = 'HQ (Headquarters)';
        classEl.appendChild(option);

        classEl.disabled = false;
        debugLog('CRUD', 'OK HQ classification enabled');
    } else {
        // Regional office - no specific classification
        classEl.disabled = true;
        debugLog('CRUD', 'OK Classification disabled for regional office');
    }

    // Update parent unit filter based on type
    if (parentEl) {
        loadParentUnitsDropdown(unitType);
    }

    debugLog('CRUD', '=== handleUnitTypeChange COMPLETE ===');
}

/**
 * Load parent units dropdown filtered by unit type
 */
async function loadParentUnitsDropdown(unitType) {
    debugLog('CRUD', '=== loadParentUnitsDropdown START === unitType:', unitType);

    const parentEl = document.getElementById('parent_unit_id');
    if (!parentEl) {
        debugLog('CRUD', 'FAIL Parent dropdown not found');
        return;
    }

    try {
        // Get all units
        const result = await apiCall('organizational-units/list', { is_active: true });
        debugLog('CRUD', 'Units API result:', result);

        if (result.success && result.data) {
            // Clear existing options
            parentEl.innerHTML = '<option value="">No Parent (Root Level)</option>';

            // Filter potential parents based on unit type
            const validParents = result.data.filter(unit => {
                // ROOT cannot have a parent
                if (unitType === 'ROOT') return false;

                // Filter based on hierarchical rules
                switch (unitType) {
                    case 'DIRECTORATE':
                    case 'WORK_UNIT':
                    case 'AFFAIR':
                        // These can only be under ROOT
                        return unit.unit_type === 'ROOT';

                    case 'REGIONAL_OFFICE':
                        // Can be under ROOT
                        return unit.unit_type === 'ROOT';

                    case 'BRANCH_OFFICE':
                        // Can be under REGIONAL_OFFICE or ROOT
                        return unit.unit_type === 'REGIONAL_OFFICE' || unit.unit_type === 'ROOT';

                    case 'SUBSIDIARY':
                        // Can be under ROOT
                        return unit.unit_type === 'ROOT';

                    case 'SUBSIDIARY_UNIT':
                        // Can be under SUBSIDIARY
                        return unit.unit_type === 'SUBSIDIARY';

                    default:
                        return true;
                }
            });

            // Add options
            validParents.forEach(parent => {
                const option = document.createElement('option');
                option.value = parent.unit_id;
                option.textContent = `${parent.unit_code} - ${parent.unit_name} (${parent.unit_type})`;
                parentEl.appendChild(option);
            });

            debugLog('CRUD', `OK Loaded ${validParents.length} valid parent units`);
        } else {
            debugLog('CRUD', 'FAIL Failed to load parent units:', result.message);
        }
    } catch (error) {
        debugLog('CRUD', 'FAIL Error loading parent units:', error);
    }

    debugLog('CRUD', '=== loadParentUnitsDropdown COMPLETE ===');
}

/**
 * Load positions dropdown for head position assignment
 */
async function loadPositionsForOrgUnitDropdown(preselectedValue = null) {
    debugLog('CRUD', '=== loadPositionsForOrgUnitDropdown START ===');

    const select = $('#head_position_id');
    const modal = $('#org-unitModal');

    try {
        const result = await apiCall('positions/list');
        debugLog('CRUD', 'Positions API result:', result);

        if (result.success && result.data) {
            // Destroy existing Select2 if initialized
            if (select.data('select2')) {
                select.select2('destroy');
                debugLog('CRUD', 'OK Destroyed existing Select2 instance');
            }

            // Clear and populate options
            select.empty();
            select.append('<option value="">Select Position</option>');

            result.data.forEach(pos => {
                select.append('<option value="' + pos.position_id + '">' +
                             pos.position_code + ' - ' + pos.position_name +
                             '</option>');
            });

            // Initialize Select2 with dropdownParent for modal
            select.select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Select Position',
                allowClear: true,
                dropdownParent: modal
            });

            // Pre-select value if provided
            if (preselectedValue) {
                select.val(preselectedValue).trigger('change');
                debugLog('CRUD', 'OK Pre-selected position:', preselectedValue);
            }

            debugLog('CRUD', 'OK Loaded ' + result.data.length + ' positions into dropdown');
        } else {
            debugLog('CRUD', 'FAIL Failed to load positions:', result.message);
        }
    } catch (error) {
        debugLog('CRUD', 'FAIL Error loading positions:', error);
    }

    debugLog('CRUD', '=== loadPositionsForOrgUnitDropdown COMPLETE ===');
}

// Track script loading
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('organization_crud.html');
}
</script>
