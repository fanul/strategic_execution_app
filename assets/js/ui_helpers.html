<script>
// Show/Hide Loading with timeout safety
function showLoading() {
    // Get stack trace to identify caller
    const stack = new Error().stack;
    const caller = stack.split('\n')[2]?.trim() || 'unknown';
    debugLog('UI', 'WARNING showLoading CALLED by: ' + caller);

    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('show');
        debugLog('UI', 'OK loading-overlay element found, show class added');
    } else {
        debugLog('UI', 'FAIL loading-overlay element NOT FOUND!');
    }
    // Auto-hide after 30 seconds as safety
    loadingTimeout = setTimeout(() => {
        console.warn('Loading timeout - auto-hiding');
        hideLoading();
    }, 30000);
}

function hideLoading() {
    // Get stack trace to identify caller
    const stack = new Error().stack;
    const caller = stack.split('\n')[2]?.trim() || 'unknown';
    debugLog('UI', 'WARNING hideLoading CALLED by: ' + caller);

    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        debugLog('UI', 'OK loading-overlay show class removed');
    } else {
        debugLog('UI', 'FAIL loading-overlay element NOT FOUND!');
    }
    if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
    }
}

// Debug function to find all visible spinners
function debugFindSpinners() {
    const spinners = document.querySelectorAll('.spinner-border');
    debugLog('UI', '=== FOUND ' + spinners.length + ' SPINNER ELEMENTS ===');

    // Also check loading-overlay element
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        const overlayDisplay = window.getComputedStyle(loadingOverlay).display;
        const overlayClasses = loadingOverlay.className;
        const overlayVisible = loadingOverlay.offsetParent !== null;
        debugLog('UI', 'Loading overlay: display=' + overlayDisplay + ', classes="' + overlayClasses + '", visible=' + overlayVisible);
    } else {
        debugLog('UI', `Loading overlay element NOT FOUND`);
    }

    spinners.forEach((spinner, index) => {
        const isVisible = spinner.offsetParent !== null;
        const parent = spinner.parentElement?.className || 'no parent';
        const grandParent = spinner.parentElement?.parentElement?.className || 'no grandparent';
        const display = window.getComputedStyle(spinner).display;
        debugLog('UI', 'Spinner ' + index + ': visible=' + isVisible + ', display=' + display + ', parent="' + parent + '", grandparent="' + grandParent + '"');
    });
}

// Show Toast
function showToast(message, type = 'info') {
    const toastEl = document.getElementById('liveToast');
    if (!toastEl) {
        debugLog('UI', 'FAIL: Toast element not found');
        return;
    }

    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');

    if (!toastTitle || !toastMessage) {
        debugLog('UI', 'FAIL: Toast title or message element not found');
        return;
    }

    toastTitle.textContent = type.charAt(0).toUpperCase() + type.slice(1);
    toastMessage.textContent = message;

    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

// View Switching
function showView(viewName, event) {
    // Prevent default link behavior
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    // Update nav
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Find the link that matches this view
        document.querySelectorAll('.nav-link[onclick*="' + viewName + '"]').forEach(el => el.classList.add('active'));
    }

    debugLog('APP', 'Switching to view: ' + viewName);

    // Hide all views
    document.querySelectorAll('.view-section').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });

    // Show selected view
    const view = document.getElementById(viewName + '-view');
    if (view) {
        view.style.display = 'block';
        view.classList.add('active');

        // Load data if organization view
        if (viewName === 'organization') {
            loadOrganizationData();
        }
    }
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        window.location.reload();
    }
}

// Load settings (needed for debug panel initialization on all pages)
async function loadSettings() {
    debugLog('SETTINGS', 'Loading settings from server...');
    try {
        const result = await apiCall('settings/get');
        debugLog('SETTINGS', 'Settings result:', result);

        if (result.success && result.data) {
            // Update DEBUG_MODE from server response
            // Note: The field name is 'debugMode' (camelCase) from the backend
            if ('debugMode' in result.data) {
                DEBUG_MODE = result.data.debugMode === true;
                debugLog('SETTINGS', 'DEBUG_MODE updated from server: ' + DEBUG_MODE);
            } else if ('debug_mode' in result.data) {
                // Also support snake_case for backward compatibility
                DEBUG_MODE = result.data.debug_mode === true;
                debugLog('SETTINGS', 'DEBUG_MODE updated from server (snake_case): ' + DEBUG_MODE);
            } else {
                debugLog('SETTINGS', 'debugMode not in response, keeping current value: ' + DEBUG_MODE);
            }

            // Apply debug mode to panel
            applyDebugMode();
        } else {
            debugLog('SETTINGS', 'Failed to load settings: ' + (result.message || 'Unknown error'));
            // Keep current DEBUG_MODE value when API call fails
            applyDebugMode();
        }
    } catch (error) {
        debugLog('SETTINGS', 'Error loading settings: ' + error.message);
        console.log('Could not load settings, using defaults');
        // Keep current DEBUG_MODE value when API call fails
        applyDebugMode();
    }

    debugLog('SETTINGS', 'Settings loading complete');
}

// Apply debug mode setting to panel
function applyDebugMode() {
    const toggleEl = document.getElementById('debugModeToggle');
    if (toggleEl) {
        toggleEl.checked = DEBUG_MODE;
        debugLog('SETTINGS', 'Toggle updated to: ' + DEBUG_MODE);
    }

    // Apply debug mode to panel
    if (window.debugPanel) {
        if (DEBUG_MODE) {
            window.debugPanel.show();
            debugLog('SETTINGS', 'Debug panel shown (DEBUG_MODE=' + DEBUG_MODE + ')');
        } else {
            window.debugPanel.hide();
            debugLog('SETTINGS', 'Debug panel hidden (DEBUG_MODE=' + DEBUG_MODE + ')');
        }
    } else {
        debugLog('SETTINGS', 'debugPanel object not found yet');
    }
}

// Track script loading
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('ui_helpers.html');
}
</script>
