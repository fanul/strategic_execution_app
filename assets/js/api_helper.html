<script>
// API Helper with Debug Logging
debugLog('INIT', 'api_helper.html loaded');

// Note: Global variables (directoratesTable, workUnitsTable, affairsTable, positionsTable, loadingTimeout, DEBUG_MODE)
// are declared in debug_panel_script.html to avoid duplicate declarations
function apiCall(endpoint, data = {}) {
    debugLog('API', '-> CALL START: ' + endpoint, data);

    return new Promise((resolve, reject) => {
        const startTime = Date.now();
        let resolved = false;

        // Timeout handler - if no response after 10 seconds
        const timeoutId = setTimeout(() => {
            if (!resolved) {
                resolved = true;
                debugLog('API', 'TIMEOUT: No response after 10 seconds');
                resolve({
                    success: false,
                    message: 'Request timeout',
                    error: 'No response from server after 10 seconds'
                });
            }
        }, 10000);

        google.script.run
            .withSuccessHandler(result => {
                if (!resolved) {
                    resolved = true;
                    clearTimeout(timeoutId);
                    const duration = Date.now() - startTime;

                    // DETAILED LOGGING
                    debugLog('API', '=== SUCCESS HANDLER ===');
                    debugLog('API', 'Duration: ' + duration + 'ms');
                    debugLog('API', 'Result type: ' + typeof result);
                    debugLog('API', 'Result keys: ' + (result ? Object.keys(result).join(',') : 'N/A'));
                    debugLog('API', 'Result stringified (first 200 chars): ' + JSON.stringify(result).substring(0, 200));

                    resolve(result);
                }
            })
            .withFailureHandler(error => {
                if (!resolved) {
                    resolved = true;
                    clearTimeout(timeoutId);
                    const duration = Date.now() - startTime;
                    debugLog('API', '=== FAILURE HANDLER ===');
                    debugLog('API', 'Error from google.script.run: ' + error);
                    debugLog('API', 'FAIL CALL ERROR: ' + endpoint + ' (' + duration + 'ms)', error);
                    resolve({
                        success: false,
                        message: error.toString(),
                        error: error.toString()
                    });
                }
            })
            .callAPI(endpoint, data || {});
    });
}

debugLog('INIT', 'apiCall function defined');

// Track script loading
if (window.scriptLoadTracker) {
    window.scriptLoadTracker.loaded('api_helper.html');
}
</script>
