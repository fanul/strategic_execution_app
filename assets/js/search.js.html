<script>
/**
 * Global Search Component for Strategic Execution Monitoring Application
 * Provides global search across all modules with keyboard shortcut support
 */

// ============================================================================
// GLOBAL SEARCH CLASS
// ============================================================================

class GlobalSearch {
    constructor(options = {}) {
        this.modules = options.modules || [];
        this.onResultClick = options.onResultClick || null;
        this.recentSearches = StorageUtils.get('global-search-recent', []);
        this.maxRecentSearches = 5;
        this.isOpen = false;
        this.currentQuery = '';
        this.isSearching = false;
    }

    /**
     * Initialize global search
     */
    init() {
        this._createSearchUI();
        this._setupKeyboardShortcuts();
        this._setupEventListeners();
    }

    /**
     * Create search UI
     * @private
     */
    _createSearchUI() {
        // Check if search bar already exists in navbar
        let searchBar = document.getElementById('global-search-bar');

        if (!searchBar) {
            // Create search bar
            searchBar = document.createElement('div');
            searchBar.className = 'global-search-bar';
            searchBar.id = 'global-search-bar';
            searchBar.innerHTML = `
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="global-search-input"
                           placeholder="Search... (Ctrl+K)" autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search" style="display: none;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div id="global-search-results" class="global-search-results" style="display: none;"></div>
            `;
        }

        return searchBar;
    }

    /**
     * Setup keyboard shortcuts
     * @private
     */
    _setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Ctrl+K / Cmd+K to open search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                this.open();
            }

            // Escape to close search
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });
    }

    /**
     * Setup event listeners
     * @private
     */
    _setupEventListeners() {
        const input = document.getElementById('global-search-input');
        const clearBtn = document.getElementById('clear-search');

        if (input) {
            // Search on input
            input.addEventListener('input', (e) => {
                this.currentQuery = e.target.value;
                if (this.currentQuery.trim()) {
                    clearBtn.style.display = 'block';
                    this._performSearch(this.currentQuery);
                } else {
                    clearBtn.style.display = 'none';
                    this._showRecentSearches();
                }
            });

            // Handle navigation keys
            input.addEventListener('keydown', (e) => {
                this._handleKeyNavigation(e);
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                input.value = '';
                this.currentQuery = '';
                clearBtn.style.display = 'none';
                this._showRecentSearches();
                input.focus();
            });
        }

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            const searchBar = document.getElementById('global-search-bar');
            if (searchBar && !searchBar.contains(e.target)) {
                this.close();
            }
        });
    }

    /**
     * Open search modal/bar
     */
    open() {
        const searchBar = document.getElementById('global-search-bar');
        if (!searchBar) {
            this._createSearchUI();
        }

        const results = document.getElementById('global-search-results');
        const input = document.getElementById('global-search-input');

        if (results) results.style.display = 'block';
        if (input) input.focus();

        this.isOpen = true;
        this._showRecentSearches();
    }

    /**
     * Close search modal/bar
     */
    close() {
        const results = document.getElementById('global-search-results');
        if (results) {
            results.style.display = 'none';
        }
        this.isOpen = false;
    }

    /**
     * Show recent searches
     * @private
     */
    _showRecentSearches() {
        const resultsContainer = document.getElementById('global-search-results');

        if (this.recentSearches.length === 0) {
            resultsContainer.innerHTML = `
                <div class="p-3 text-muted text-center">
                    <small>No recent searches</small>
                </div>
            `;
            return;
        }

        resultsContainer.innerHTML = `
            <div class="search-recent-header p-2 border-bottom">
                <small class="text-muted">Recent Searches</small>
            </div>
            <div class="search-recent-list">
                ${this.recentSearches.map(search => `
                    <div class="search-recent-item p-2" data-search="${search}">
                        <i class="bi bi-clock-history me-2"></i>${search}
                    </div>
                `).join('')}
            </div>
            <div class="search-recent-footer p-2 border-top">
                <a href="#" class="clear-recent-link small text-muted">
                    <i class="bi bi-trash me-1"></i>Clear history
                </a>
            </div>
        `;

        // Add click handlers
        resultsContainer.querySelectorAll('.search-recent-item').forEach(item => {
            item.addEventListener('click', () => {
                const search = item.dataset.search;
                document.getElementById('global-search-input').value = search;
                this._performSearch(search);
            });
        });

        resultsContainer.querySelector('.clear-recent-link')?.addEventListener('click', (e) => {
            e.preventDefault();
            this.recentSearches = [];
            StorageUtils.remove('global-search-recent');
            this._showRecentSearches();
        });
    }

    /**
     * Perform search
     * @private
     */
    async _performSearch(query) {
        if (!query || query.trim().length < 2) return;

        this.isSearching = true;
        const resultsContainer = document.getElementById('global-search-results');

        // Show loading
        resultsContainer.innerHTML = `
            <div class="p-4 text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Searching...</span>
                </div>
                <div class="mt-2 text-muted"><small>Searching...</small></div>
            </div>
        `;

        try {
            // Call API search endpoint
            const response = await api.search.global(query);

            if (response.success && response.data) {
                this._displayResults(query, response.data);

                // Add to recent searches
                this._addToRecentSearches(query);
            } else {
                resultsContainer.innerHTML = `
                    <div class="p-4 text-center text-muted">
                        <small>No results found for "${query}"</small>
                    </div>
                `;
            }

        } catch (error) {
            console.error('Search error:', error);
            resultsContainer.innerHTML = `
                <div class="p-4 text-center text-danger">
                    <small>Search failed. Please try again.</small>
                </div>
            `;
        }

        this.isSearching = false;
    }

    /**
     * Display search results
     * @private
     */
    _displayResults(query, data) {
        const resultsContainer = document.getElementById('global-search-results');

        if (!data || Object.keys(data).length === 0) {
            resultsContainer.innerHTML = `
                <div class="p-4 text-center text-muted">
                    <small>No results found for "${query}"</small>
                </div>
            `;
            return;
        }

        let html = '<div class="search-results-list">';

        for (const [module, results] of Object.entries(data)) {
            if (results && results.length > 0) {
                const moduleNames = {
                    'users': 'Users',
                    'roles': 'Roles',
                    'directorates': 'Directorates',
                    'workunits': 'Work Units',
                    'affairs': 'Affairs',
                    'positions': 'Positions',
                    'goals': 'Goals',
                    'kpis': 'KPIs',
                    'programs': 'Programs',
                    'activities': 'Activities'
                };

                html += `
                    <div class="search-result-category p-2 border-bottom">
                        <small class="text-muted fw-bold">${moduleNames[module] || module}</small>
                    </div>
                `;

                results.forEach(result => {
                    html += `
                        <div class="search-result-item p-2" data-module="${module}" data-id="${result.id}">
                            <div class="d-flex align-items-center">
                                <div class="search-result-icon me-2">
                                    <i class="bi bi-${this._getModuleIcon(module)}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="search-result-title">${result.name || result.title || result.username}</div>
                                    <div class="search-result-subtitle text-muted small">${result.code || result.email || result.description || ''}</div>
                                </div>
                                <div class="search-result-action">
                                    <i class="bi bi-arrow-right-short"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        html += '</div>';

        resultsContainer.innerHTML = html;

        // Add click handlers
        resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
                const module = item.dataset.module;
                const id = item.dataset.id;
                this._handleResultClick(module, id);
            });
        });
    }

    /**
     * Get icon for module
     * @private
     */
    _getModuleIcon(module) {
        const icons = {
            'users': 'person',
            'roles': 'shield-check',
            'directorates': 'building',
            'workunits': 'diagram-3',
            'affairs': 'folder',
            'positions': 'person-badge',
            'goals': 'flag',
            'kpis': 'graph-up',
            'programs': 'list-task',
            'activities': 'check2-square'
        };
        return icons[module] || 'file-earmark';
    }

    /**
     * Handle result click
     * @private
     */
    _handleResultClick(module, id) {
        this.close();

        // Navigate to the relevant page
        const viewMap = {
            'users': 'users',
            'roles': 'users',
            'directorates': 'organization',
            'workunits': 'organization',
            'affairs': 'organization',
            'positions': 'organization',
            'goals': 'strategic-plan',
            'kpis': 'kpi',
            'programs': 'programs'
        };

        const viewName = viewMap[module];
        if (viewName) {
            app.switchView(viewName);
        }

        // Notify to highlight/show the specific item
        if (this.onResultClick) {
            this.onResultClick(module, id);
        }
    }

    /**
     * Add to recent searches
     * @private
     */
    _addToRecentSearches(query) {
        // Remove if already exists
        this.recentSearches = this.recentSearches.filter(s => s !== query);

        // Add to beginning
        this.recentSearches.unshift(query);

        // Keep only maxRecentSearches
        this.recentSearches = this.recentSearches.slice(0, this.maxRecentSearches);

        // Save to storage
        StorageUtils.save('global-search-recent', this.recentSearches);
    }

    /**
     * Handle keyboard navigation
     * @private
     */
    _handleKeyNavigation(e) {
        const items = document.querySelectorAll('.search-result-item, .search-recent-item');
        const currentIndex = Array.from(items).findIndex(item => item.classList.contains('selected'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
            this._selectItem(items, nextIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
            this._selectItem(items, prevIndex);
        } else if (e.key === 'Enter' && currentIndex >= 0) {
            e.preventDefault();
            items[currentIndex].click();
        }
    }

    /**
     * Select item in results list
     * @private
     */
    _selectItem(items, index) {
        items.forEach(item => item.classList.remove('selected'));
        items[index].classList.add('selected');
        items[index].scrollIntoView({ block: 'nearest' });
    }
}

// ============================================================================
// FILTER PANEL COMPONENT
// ============================================================================

class FilterPanel {
    constructor(options = {}) {
        this.containerId = options.containerId;
        this.filters = options.filters || [];
        this.onFilterChange = options.onFilterChange || null;
        this.collapsed = false;
    }

    /**
     * Create filter panel
     */
    create() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        container.innerHTML = `
            <div class="filter-panel">
                <div class="filter-header d-flex justify-content-between align-items-center p-3">
                    <h6 class="m-0"><i class="bi bi-funnel me-2"></i>Filters</h6>
                    <div class="filter-actions">
                        <button class="btn btn-sm btn-link p-0" id="toggle-filter-panel" title="Toggle">
                            <i class="bi bi-chevron-up"></i>
                        </button>
                        <button class="btn btn-sm btn-link p-0" id="clear-all-filters" title="Clear all">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-body p-3">
                    ${this._renderFilters()}
                </div>
                <div class="filter-footer p-3 border-top">
                    <button class="btn btn-primary btn-sm w-100" id="apply-filters">
                        <i class="bi bi-check-lg me-1"></i>Apply Filters
                    </button>
                </div>
            </div>
        `;

        this._setupEventListeners();
    }

    /**
     * Render filters
     * @private
     */
    _renderFilters() {
        return this.filters.map(filter => {
            switch (filter.type) {
                case 'text':
                    return this._renderTextFilter(filter);
                case 'select':
                    return this._renderSelectFilter(filter);
                case 'multiselect':
                    return this._renderMultiSelectFilter(filter);
                case 'date':
                    return this._renderDateFilter(filter);
                case 'daterange':
                    return this._renderDateRangeFilter(filter);
                case 'checkbox':
                    return this._renderCheckboxFilter(filter);
                default:
                    return '';
            }
        }).join('');
    }

    /**
     * Render text filter
     * @private
     */
    _renderTextFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <label class="form-label">${filter.label}</label>
                <input type="text" class="form-control filter-input"
                       name="${filter.name}" placeholder="${filter.placeholder || ''}"
                       value="${filter.value || ''}">
            </div>
        `;
    }

    /**
     * Render select filter
     * @private
     */
    _renderSelectFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <label class="form-label">${filter.label}</label>
                <select class="form-select filter-select" name="${filter.name}">
                    <option value="">${filter.placeholder || 'Select...'}</option>
                    ${(filter.options || []).map(opt => `
                        <option value="${opt.value}" ${filter.value === opt.value ? 'selected' : ''}>
                            ${opt.label}
                        </option>
                    `).join('')}
                </select>
            </div>
        `;
    }

    /**
     * Render multi-select filter
     * @private
     */
    _renderMultiSelectFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <label class="form-label">${filter.label}</label>
                <select multiple class="form-select filter-multiselect" name="${filter.name}" size="3">
                    ${(filter.options || []).map(opt => `
                        <option value="${opt.value}" ${(filter.value || []).includes(opt.value) ? 'selected' : ''}>
                            ${opt.label}
                        </option>
                    `).join('')}
                </select>
                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
            </div>
        `;
    }

    /**
     * Render date filter
     * @private
     */
    _renderDateFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <label class="form-label">${filter.label}</label>
                <input type="date" class="form-control filter-date"
                       name="${filter.name}" value="${filter.value || ''}">
            </div>
        `;
    }

    /**
     * Render date range filter
     * @private
     */
    _renderDateRangeFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <label class="form-label">${filter.label}</label>
                <div class="row g-2">
                    <div class="col">
                        <input type="date" class="form-control filter-date-start"
                               name="${filter.name}_start" placeholder="From"
                               value="${filter.start || ''}">
                    </div>
                    <div class="col">
                        <input type="date" class="form-control filter-date-end"
                               name="${filter.name}_end" placeholder="To"
                               value="${filter.end || ''}">
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Render checkbox filter
     * @private
     */
    _renderCheckboxFilter(filter) {
        return `
            <div class="filter-item mb-3">
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox"
                           name="${filter.name}" id="filter-${filter.name}"
                           ${(filter.checked !== undefined) ? (filter.checked ? 'checked' : '') : ''}>
                    <label class="form-check-label" for="filter-${filter.name}">
                        ${filter.label}
                    </label>
                </div>
            </div>
        `;
    }

    /**
     * Setup event listeners
     * @private
     */
    _setupEventListeners() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        // Toggle panel
        container.querySelector('#toggle-filter-panel')?.addEventListener('click', () => {
            this.toggle();
        });

        // Clear all filters
        container.querySelector('#clear-all-filters')?.addEventListener('click', () => {
            this.clearAll();
        });

        // Apply filters
        container.querySelector('#apply-filters')?.addEventListener('click', () => {
            this.apply();
        });
    }

    /**
     * Toggle panel collapse/expand
     */
    toggle() {
        const body = document.querySelector(`#${this.containerId} .filter-body`);
        const icon = document.querySelector(`#${this.containerId} #toggle-filter-panel i`);

        if (body && icon) {
            this.collapsed = !this.collapsed;
            body.style.display = this.collapsed ? 'none' : 'block';
            icon.className = this.collapsed ? 'bi bi-chevron-down' : 'bi bi-chevron-up';
        }
    }

    /**
     * Clear all filters
     */
    clearAll() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        // Clear all inputs
        container.querySelectorAll('.filter-input, .filter-select').forEach(input => {
            input.value = '';
        });

        // Clear all checkboxes
        container.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Clear all multi-selects
        container.querySelectorAll('.filter-multiselect').forEach(select => {
            Array.from(select.options).forEach(opt => opt.selected = false);
        });

        if (this.onFilterChange) {
            this.onFilterChange({});
        }
    }

    /**
     * Get filter values
     */
    getValues() {
        const container = document.getElementById(this.containerId);
        if (!container) return {};

        const values = {};

        // Text inputs
        container.querySelectorAll('.filter-input').forEach(input => {
            values[input.name] = input.value;
        });

        // Select inputs
        container.querySelectorAll('.filter-select').forEach(select => {
            values[select.name] = select.value;
        });

        // Multi-selects
        container.querySelectorAll('.filter-multiselect').forEach(select => {
            values[select.name] = Array.from(select.selectedOptions).map(opt => opt.value);
        });

        // Dates
        container.querySelectorAll('.filter-date').forEach(input => {
            values[input.name] = input.value;
        });

        // Checkboxes
        container.querySelectorAll('.filter-checkbox').forEach(checkbox => {
            values[checkbox.name] = checkbox.checked;
        });

        return values;
    }

    /**
     * Apply filters
     */
    apply() {
        const values = this.getValues();

        if (this.onFilterChange) {
            this.onFilterChange(values);
        }
    }
}

// ============================================================================
// SAVED FILTER PRESETS
// ============================================================================

class SavedFilters {
    constructor() {
        this.storageKey = 'saved-filters';
    }

    /**
     * Save current filter preset
     */
    save(name, filters) {
        const saved = StorageUtils.get(this.storageKey, {});
        saved[name] = {
            name,
            filters,
            createdAt: new Date().toISOString()
        };
        StorageUtils.save(this.storageKey, saved);
        showSuccessToast(`Filter preset "${name}" saved`);
    }

    /**
     * Load filter preset
     */
    load(name) {
        const saved = StorageUtils.get(this.storageKey, {});
        return saved[name] || null;
    }

    /**
     * Delete filter preset
     */
    delete(name) {
        const saved = StorageUtils.get(this.storageKey, {});
        delete saved[name];
        StorageUtils.save(this.storageKey, saved);
        showSuccessToast(`Filter preset "${name}" deleted`);
    }

    /**
     * List all presets
     */
    list() {
        return StorageUtils.get(this.storageKey, {});
    }
}

// ============================================================================
// EXPORT
// ============================================================================

if (typeof window !== 'undefined') {
    window.GlobalSearch = GlobalSearch;
    window.FilterPanel = FilterPanel;
    window.SavedFilters = SavedFilters;
}

</script>
